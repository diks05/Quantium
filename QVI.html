<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Quantium Virtual Internship - Retail Strategy and Analytics - Task 1</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="QVI_files/libs/clipboard/clipboard.min.js"></script>
<script src="QVI_files/libs/quarto-html/quarto.js"></script>
<script src="QVI_files/libs/quarto-html/popper.min.js"></script>
<script src="QVI_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="QVI_files/libs/quarto-html/anchor.min.js"></script>
<link href="QVI_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="QVI_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="QVI_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="QVI_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="QVI_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
</head><body class="fullcontent">\usepackage{fvextra}
\DefineVerbatimEnvironment{Highlighting}{Verbatim}{breaklines,commandchars=\\\{\}}






<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Quantium Virtual Internship - Retail Strategy and Analytics - Task 1</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>
  There is a binary version available but the source version is later:
           binary source needs_compilation
data.table 1.16.4 1.17.0              TRUE</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>package 'readr' successfully unpacked and MD5 sums checked</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
The downloaded binary packages are in
    C:\Users\barad\AppData\Local\Temp\RtmpsJ2Nh9\downloaded_packages</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>     Package LibPath Version Priority Depends Imports LinkingTo Suggests
     Enhances License License_is_FOSS License_restricts_use OS_type Archs
     MD5sum NeedsCompilation Built</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>package 'ggmosaic' successfully unpacked and MD5 sums checked

The downloaded binary packages are in
    C:\Users\barad\AppData\Local\Temp\RtmpsJ2Nh9\downloaded_packages</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">file.exists</span>(<span class="st">"C:/Users/barad/Desktop/Quantinum Internship/QVI_purchase_behaviour.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE</code></pre>
</div>
</div>
<p><br>
<strong>Loading and Joining Dataset</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co">#load dataset</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>customerData <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"C:/Users/barad/Desktop/Quantinum Internship/QVI_purchase_behaviour.csv"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  janitor<span class="sc">::</span><span class="fu">clean_names</span>()</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>transactionData <span class="ot">&lt;-</span> <span class="fu">read_xlsx</span>(<span class="st">"C:/Users/barad/Desktop/Quantinum Internship/QVI_transaction_data.xlsx"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>  janitor<span class="sc">::</span><span class="fu">clean_names</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>combinedData <span class="ot">&lt;-</span> <span class="fu">inner_join</span>(transactionData, customerData, <span class="at">by =</span> <span class="st">"lylty_card_nbr"</span>)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="fu">write.csv</span>(combinedData, <span class="st">"C:/Users/barad/Desktop/Quantinum Internship/Combined_Data.csv"</span>, <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>Removing any empty values</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>combinedData <span class="ot">&lt;-</span> combinedData <span class="sc">%&gt;%</span> </span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(lylty_card_nbr))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(combinedData)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>tibble [264,836 × 10] (S3: tbl_df/tbl/data.frame)
$ date : num [1:264836] 43390 43599 43605 43329 43330 ...
$ store_nbr : num [1:264836] 1 1 1 2 2 4 4 4 5 7 ...
$ lylty_card_nbr : num [1:264836] 1000 1307 1343 2373 2426 ...
$ txn_id : num [1:264836] 1 348 383 974 1038 ...
$ prod_nbr : num [1:264836] 5 66 61 69 108 57 16 24 42 52 ...
$ prod_name : chr [1:264836] "Natural Chip Compny SeaSalt175g" "CCs Nacho
Cheese 175g" "Smiths Crinkle Cut Chips Chicken 170g" "Smiths Chip Thinly
S/Cream&amp;Onion 175g" ...
$ prod_qty : num [1:264836] 2 3 2 5 3 1 1 1 1 2 ...
$ tot_sales : num [1:264836] 6 6.3 2.9 15 13.8 5.1 5.7 3.6 3.9 7.2 ...
$ lifestage : chr [1:264836] "YOUNG SINGLES/COUPLES" "MIDAGE SINGLES/COUPLES"
"MIDAGE SINGLES/COUPLES" "MIDAGE SINGLES/COUPLES" ...
$ premium_customer: chr [1:264836] "Premium" "Budget" "Budget" "Budget" ...</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(combinedData)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 10
   date store_nbr lylty_card_nbr txn_id prod_nbr prod_name    prod_qty tot_sales
  &lt;dbl&gt;     &lt;dbl&gt;          &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt; &lt;chr&gt;           &lt;dbl&gt;     &lt;dbl&gt;
1 43390         1           1000      1        5 Natural Chi…        2       6  
2 43599         1           1307    348       66 CCs Nacho C…        3       6.3
3 43605         1           1343    383       61 Smiths Crin…        2       2.9
4 43329         2           2373    974       69 Smiths Chip…        5      15  
5 43330         2           2426   1038      108 Kettle Tort…        3      13.8
6 43604         4           4074   2982       57 Old El Paso…        1       5.1
# ℹ 2 more variables: lifestage &lt;chr&gt;, premium_customer &lt;chr&gt;</code></pre>
</div>
</div>
<p><strong>Converting to table and understanding the class of each column</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert to data.table if it's a data frame</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>combinedData <span class="ot">&lt;-</span> <span class="fu">as.data.table</span>(combinedData)</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Check the class of each column</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="fu">sapply</span>(combinedData, class)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>            date        store_nbr   lylty_card_nbr           txn_id 
       "numeric"        "numeric"        "numeric"        "numeric" 
        prod_nbr        prod_name         prod_qty        tot_sales 
       "numeric"      "character"        "numeric"        "numeric" 
       lifestage premium_customer 
     "character"      "character" </code></pre>
</div>
</div>
<p><strong>Converting date column into acceptable date format</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co">#convert Date column in date format</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>combinedData<span class="sc">$</span>date <span class="ot">&lt;-</span> <span class="fu">as.Date</span>(combinedData<span class="sc">$</span>date, <span class="at">origin =</span> <span class="st">"1899-12-30"</span>)</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="fu">view</span>(combinedData)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(combinedData<span class="sc">$</span>prod_name)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   Length     Class      Mode 
   264836 character character </code></pre>
</div>
</div>
<p><strong>Only working on chips and removing digits and special characters.</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load necessary libraries</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Assuming 'transactionData' is your data.table and 'PROD_NAME' is the column with product names</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 1: Split the product names into individual words</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>productWords <span class="ot">&lt;-</span> <span class="fu">data.table</span>(<span class="fu">unlist</span>(<span class="fu">strsplit</span>(<span class="fu">unique</span>(combinedData[, prod_name]), <span class="st">" "</span>)))</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 2: Set column name to 'words'</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a><span class="fu">setnames</span>(productWords, <span class="st">'words'</span>)</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 3: Remove words containing digits or special characters (like '&amp;', 'g')</span></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Using grepl to remove words that contain non-alphabetic characters (including digits and special characters)</span></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>productWords <span class="ot">&lt;-</span> productWords[<span class="sc">!</span><span class="fu">grepl</span>(<span class="st">"[^a-zA-Z]"</span>, words)]</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 4: Remove any potential empty strings that may have resulted from cleaning</span></span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>productWords <span class="ot">&lt;-</span> productWords[words <span class="sc">!=</span> <span class="st">""</span>]</span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 5: Count the frequency of each word using table() and sort by frequency</span></span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>wordFrequency <span class="ot">&lt;-</span> <span class="fu">data.table</span>(<span class="fu">table</span>(productWords<span class="sc">$</span>words))</span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a><span class="fu">setnames</span>(wordFrequency, <span class="fu">c</span>(<span class="st">"word"</span>, <span class="st">"frequency"</span>))</span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 6: Sort the words by frequency (highest to lowest)</span></span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a>wordFrequency <span class="ot">&lt;-</span> wordFrequency[<span class="fu">order</span>(<span class="sc">-</span>frequency)]</span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 7: View the most common words</span></span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(wordFrequency)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        word frequency
      &lt;char&gt;     &lt;int&gt;
  1:   Chips        21
  2:  Smiths        16
  3: Crinkle        14
  4:     Cut        14
  5:  Kettle        13
 ---                  
164:     Veg         1
165:  Vinegr         1
166:  Vingar         1
167: Whlegrn         1
168:  Whlgrn         1</code></pre>
</div>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Optional: You can inspect the top words by frequency</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(wordFrequency)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      word frequency
    &lt;char&gt;     &lt;int&gt;
1:   Chips        21
2:  Smiths        16
3: Crinkle        14
4:     Cut        14
5:  Kettle        13
6:  Cheese        12</code></pre>
</div>
</div>
<p><strong>removing salsa products from the dataset as only interested in chips</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove salsa products</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>combinedData[, SALSA <span class="sc">:</span><span class="er">=</span> <span class="fu">grepl</span>(<span class="st">"salsa"</span>, <span class="fu">tolower</span>(prod_name))]</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>combinedData <span class="ot">&lt;-</span> combinedData[SALSA <span class="sc">==</span> <span class="cn">FALSE</span>, ][, SALSA <span class="sc">:</span><span class="er">=</span> <span class="cn">NULL</span>]</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(combinedData)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>         date store_nbr lylty_card_nbr txn_id prod_nbr
       &lt;Date&gt;     &lt;num&gt;          &lt;num&gt;  &lt;num&gt;    &lt;num&gt;
1: 2018-10-17         1           1000      1        5
2: 2019-05-14         1           1307    348       66
3: 2019-05-20         1           1343    383       61
4: 2018-08-17         2           2373    974       69
5: 2018-08-18         2           2426   1038      108
6: 2019-05-16         4           4149   3333       16
                                  prod_name prod_qty tot_sales
                                     &lt;char&gt;    &lt;num&gt;     &lt;num&gt;
1:   Natural Chip        Compny SeaSalt175g        2       6.0
2:                 CCs Nacho Cheese    175g        3       6.3
3:   Smiths Crinkle Cut  Chips Chicken 170g        2       2.9
4:   Smiths Chip Thinly  S/Cream&amp;Onion 175g        5      15.0
5: Kettle Tortilla ChpsHny&amp;Jlpno Chili 150g        3      13.8
6: Smiths Crinkle Chips Salt &amp; Vinegar 330g        1       5.7
                lifestage premium_customer
                   &lt;char&gt;           &lt;char&gt;
1:  YOUNG SINGLES/COUPLES          Premium
2: MIDAGE SINGLES/COUPLES           Budget
3: MIDAGE SINGLES/COUPLES           Budget
4: MIDAGE SINGLES/COUPLES           Budget
5: MIDAGE SINGLES/COUPLES           Budget
6: MIDAGE SINGLES/COUPLES           Budget</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(combinedData)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      date              store_nbr     lylty_card_nbr        txn_id       
 Min.   :2018-07-01   Min.   :  1.0   Min.   :   1000   Min.   :      1  
 1st Qu.:2018-09-30   1st Qu.: 70.0   1st Qu.:  70015   1st Qu.:  67569  
 Median :2018-12-30   Median :130.0   Median : 130367   Median : 135183  
 Mean   :2018-12-30   Mean   :135.1   Mean   : 135531   Mean   : 135131  
 3rd Qu.:2019-03-31   3rd Qu.:203.0   3rd Qu.: 203084   3rd Qu.: 202654  
 Max.   :2019-06-30   Max.   :272.0   Max.   :2373711   Max.   :2415841  
    prod_nbr       prod_name            prod_qty         tot_sales      
 Min.   :  1.00   Length:246742      Min.   :  1.000   Min.   :  1.700  
 1st Qu.: 26.00   Class :character   1st Qu.:  2.000   1st Qu.:  5.800  
 Median : 53.00   Mode  :character   Median :  2.000   Median :  7.400  
 Mean   : 56.35                      Mean   :  1.908   Mean   :  7.321  
 3rd Qu.: 87.00                      3rd Qu.:  2.000   3rd Qu.:  8.800  
 Max.   :114.00                      Max.   :200.000   Max.   :650.000  
  lifestage         premium_customer  
 Length:246742      Length:246742     
 Class :character   Class :character  
 Mode  :character   Mode  :character  
                                      
                                      
                                      </code></pre>
</div>
</div>
<p><strong>Checking for in outliers in product quantity</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(combinedData, <span class="fu">aes</span>(<span class="at">x =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(combinedData), <span class="at">y =</span> prod_qty)) <span class="sc">+</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">color =</span> <span class="st">"blue"</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Scatter Plot of Product Quantity (prod_qty)"</span>,</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Index"</span>,</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Product Quantity (prod_qty)"</span>) <span class="sc">+</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="QVI_files/figure-html/scatter%20plot%20for%20prod_qty%20to%20determine%20outliers-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># remove outliers in prod_qty</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>combinedData_filtered <span class="ot">&lt;-</span> <span class="fu">filter</span>(combinedData, prod_qty <span class="sc">!=</span> <span class="dv">200</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>Removing customer lyty number that purchased 200 prod qty</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co">#check if more transactions made by customer who purchased 200 qty</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>cust_200 <span class="ot">&lt;-</span> <span class="fu">filter</span>(combinedData, prod_qty <span class="sc">==</span> <span class="dv">200</span>)</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a><span class="fu">unique</span>(cust_200<span class="sc">$</span>lylty_card_nbr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 226000</code></pre>
</div>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>trans_made_cust_200 <span class="ot">&lt;-</span> <span class="fu">filter</span>(combinedData, lylty_card_nbr <span class="sc">==</span> <span class="dv">226000</span>)</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(trans_made_cust_200)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>         date store_nbr lylty_card_nbr txn_id prod_nbr
       &lt;Date&gt;     &lt;num&gt;          &lt;num&gt;  &lt;num&gt;    &lt;num&gt;
1: 2018-08-19       226         226000 226201        4
2: 2019-05-20       226         226000 226210        4
                          prod_name prod_qty tot_sales      lifestage
                             &lt;char&gt;    &lt;num&gt;     &lt;num&gt;         &lt;char&gt;
1: Dorito Corn Chp     Supreme 380g      200       650 OLDER FAMILIES
2: Dorito Corn Chp     Supreme 380g      200       650 OLDER FAMILIES
   premium_customer
             &lt;char&gt;
1:          Premium
2:          Premium</code></pre>
</div>
</div>
<p>It looks like this customer has only had the two transactions over the year and is<br>
not an ordinary retail customer. The customer might be buying chips for commercial<br>
purposes instead. We’ll remove this loyalty card number from further analysis.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="co">#remove the customer lyty number from original dataset</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>combinedData <span class="ot">&lt;-</span> <span class="fu">filter</span>(combinedData, lylty_card_nbr <span class="sc">!=</span> <span class="dv">226000</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(combinedData)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      date              store_nbr     lylty_card_nbr        txn_id       
 Min.   :2018-07-01   Min.   :  1.0   Min.   :   1000   Min.   :      1  
 1st Qu.:2018-09-30   1st Qu.: 70.0   1st Qu.:  70015   1st Qu.:  67569  
 Median :2018-12-30   Median :130.0   Median : 130367   Median : 135182  
 Mean   :2018-12-30   Mean   :135.1   Mean   : 135530   Mean   : 135130  
 3rd Qu.:2019-03-31   3rd Qu.:203.0   3rd Qu.: 203083   3rd Qu.: 202652  
 Max.   :2019-06-30   Max.   :272.0   Max.   :2373711   Max.   :2415841  
    prod_nbr       prod_name            prod_qty       tot_sales     
 Min.   :  1.00   Length:246740      Min.   :1.000   Min.   : 1.700  
 1st Qu.: 26.00   Class :character   1st Qu.:2.000   1st Qu.: 5.800  
 Median : 53.00   Mode  :character   Median :2.000   Median : 7.400  
 Mean   : 56.35                      Mean   :1.906   Mean   : 7.316  
 3rd Qu.: 87.00                      3rd Qu.:2.000   3rd Qu.: 8.800  
 Max.   :114.00                      Max.   :5.000   Max.   :29.500  
  lifestage         premium_customer  
 Length:246740      Length:246740     
 Class :character   Class :character  
 Mode  :character   Mode  :character  
                                      
                                      
                                      </code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co">#count number of unique transactions/number of days</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>num_days <span class="ot">&lt;-</span> combinedData <span class="sc">%&gt;%</span></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">num_distinct_days =</span> <span class="fu">n_distinct</span>(date))</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(num_days)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  num_distinct_days
1               364</code></pre>
</div>
</div>
<p>Looks like there is one missing date</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Count the number of transactions per date</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>transaction_count_per_date <span class="ot">&lt;-</span> combinedData <span class="sc">%&gt;%</span></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(date) <span class="sc">%&gt;%</span></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">transaction_count =</span> <span class="fu">n</span>())</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a><span class="co"># View the result</span></span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>transaction_count_per_date</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 364 × 2
   date       transaction_count
   &lt;date&gt;                 &lt;int&gt;
 1 2018-07-01               663
 2 2018-07-02               650
 3 2018-07-03               674
 4 2018-07-04               669
 5 2018-07-05               660
 6 2018-07-06               711
 7 2018-07-07               695
 8 2018-07-08               653
 9 2018-07-09               692
10 2018-07-10               650
# ℹ 354 more rows</code></pre>
</div>
</div>
<p>missing date is 25th DEC - Christmas - maybe the stores were closed on this holiday.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="do">#### Setting plot themes to format graphs</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="fu">theme_set</span>(<span class="fu">theme_bw</span>())</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a><span class="fu">theme_update</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>))</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a><span class="do">#### Plot transactions over time</span></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(transaction_count_per_date, <span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> transaction_count)) <span class="sc">+</span></span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a><span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a><span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Day"</span>, <span class="at">y =</span> <span class="st">"Number of transactions"</span>, <span class="at">title =</span> <span class="st">"Transactions over time"</span>) <span class="sc">+</span></span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a><span class="fu">scale_x_date</span>(<span class="at">breaks =</span> <span class="st">"1 month"</span>) <span class="sc">+</span></span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a><span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">90</span>, <span class="at">vjust =</span> <span class="fl">0.5</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="QVI_files/figure-html/unnamed-chunk-16-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Zooming the chart to see the specific dates - December</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="co">#filter out dates in dec</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>start_date <span class="ot">&lt;-</span> <span class="fu">as.Date</span>(<span class="st">"2018-12-01"</span>)</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>end_date <span class="ot">&lt;-</span> <span class="fu">as.Date</span>(<span class="st">"2018-12-31"</span>)</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>transaction_count_per_date_filtered <span class="ot">=</span> <span class="fu">filter</span>(transaction_count_per_date, date <span class="sc">&gt;=</span> start_date <span class="sc">&amp;</span> date <span class="sc">&lt;=</span> end_date)</span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>transaction_count_per_date_filtered</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 30 × 2
   date       transaction_count
   &lt;date&gt;                 &lt;int&gt;
 1 2018-12-01               675
 2 2018-12-02               655
 3 2018-12-03               677
 4 2018-12-04               666
 5 2018-12-05               660
 6 2018-12-06               645
 7 2018-12-07               672
 8 2018-12-08               622
 9 2018-12-09               659
10 2018-12-10               664
# ℹ 20 more rows</code></pre>
</div>
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>sorted_date <span class="ot">&lt;-</span> transaction_count_per_date_filtered <span class="sc">%&gt;%</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(date)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>all_dates <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="fu">min</span>(transaction_count_per_date_filtered<span class="sc">$</span>date), </span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">max</span>(transaction_count_per_date_filtered<span class="sc">$</span>date), </span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>                 <span class="at">by =</span> <span class="st">"day"</span>)</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>missing_dates <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(all_dates, transaction_count_per_date_filtered<span class="sc">$</span>date)</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>missing_dates</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 17890</code></pre>
</div>
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 2: Create a data frame with the full date range</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>complete_data <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">date =</span> all_dates)</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 3: Merge the full date range with the existing data</span></span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>transaction_count_per_date_filtered <span class="ot">&lt;-</span> <span class="fu">merge</span>(</span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>  complete_data, </span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>  transaction_count_per_date_filtered, </span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">by =</span> <span class="st">"date"</span>, </span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">all.x =</span> <span class="cn">TRUE</span>  <span class="co"># Keep all dates from the full range</span></span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 4: Replace NA values in 'N' with 0 for the missing dates</span></span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a>transaction_count_per_date_filtered<span class="sc">$</span>transaction_count[<span class="fu">is.na</span>(transaction_count_per_date_filtered<span class="sc">$</span>transaction_count)] <span class="ot">&lt;-</span> <span class="cn">NA</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(transaction_count_per_date_filtered, <span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> transaction_count)) <span class="sc">+</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Day"</span>, <span class="at">y =</span> <span class="st">"Number of transactions"</span>, <span class="at">title =</span> <span class="st">"Transactions over time"</span>) <span class="sc">+</span></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_date</span>(<span class="at">date_breaks =</span> <span class="st">"1 day"</span>, <span class="at">date_labels =</span> <span class="st">"%b %d"</span>) <span class="sc">+</span></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">90</span>, <span class="at">vjust =</span> <span class="fl">0.5</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="QVI_files/figure-html/unnamed-chunk-19-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We can see that the increase in sales occurs in the lead-up to Christmas and that<br>
there are zero sales on Christmas day itself. This is due to shops being closed on<br>
Christmas day.</p>
<p><strong>Now lets check the packet sizes</strong></p>
<pre><code>install.packages("data.table")</code></pre>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>combinedData[, pack_size <span class="sc">:</span><span class="er">=</span> <span class="fu">parse_number</span>(prod_name)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in `[.data.table`(combinedData, , `:=`(pack_size,
parse_number(prod_name))): Invalid .internal.selfref detected and fixed by
taking a (shallow) copy of the data.table so that := can add this new column by
reference. At an earlier point, this data.table has been copied by R (or was
created manually using structure() or similar). Avoid names&lt;- and attr&lt;- which
in R currently (and oddly) may copy the whole data.table. Use set* syntax
instead to avoid copying: ?set, ?setnames and ?setattr. If this message doesn't
help, please report your use case to the data.table issue tracker so the root
cause can be fixed or this message improved.</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>combinedData[, .N, pack_size][<span class="fu">order</span>(pack_size)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    pack_size     N
        &lt;num&gt; &lt;int&gt;
 1:        70  1507
 2:        90  3008
 3:       110 22387
 4:       125  1454
 5:       134 25102
 6:       135  3257
 7:       150 40203
 8:       160  2970
 9:       165 15297
10:       170 19983
11:       175 66390
12:       180  1468
13:       190  2995
14:       200  4473
15:       210  6272
16:       220  1564
17:       250  3169
18:       270  6285
19:       330 12540
20:       380  6416
    pack_size     N</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(combinedData, <span class="fu">aes</span>(pack_size))<span class="sc">+</span> <span class="fu">geom_histogram</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="QVI_files/figure-html/histogram%20of%20pack%20sizes-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract the first word from `prod_name` to create `brand_name`</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>combinedData <span class="ot">&lt;-</span> combinedData <span class="sc">%&gt;%</span></span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">brand_name =</span> <span class="fu">word</span>(prod_name, <span class="dv">1</span>))</span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Check the result</span></span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(combinedData)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>         date store_nbr lylty_card_nbr txn_id prod_nbr
       &lt;Date&gt;     &lt;num&gt;          &lt;num&gt;  &lt;num&gt;    &lt;num&gt;
1: 2018-10-17         1           1000      1        5
2: 2019-05-14         1           1307    348       66
3: 2019-05-20         1           1343    383       61
4: 2018-08-17         2           2373    974       69
5: 2018-08-18         2           2426   1038      108
6: 2019-05-16         4           4149   3333       16
                                  prod_name prod_qty tot_sales
                                     &lt;char&gt;    &lt;num&gt;     &lt;num&gt;
1:   Natural Chip        Compny SeaSalt175g        2       6.0
2:                 CCs Nacho Cheese    175g        3       6.3
3:   Smiths Crinkle Cut  Chips Chicken 170g        2       2.9
4:   Smiths Chip Thinly  S/Cream&amp;Onion 175g        5      15.0
5: Kettle Tortilla ChpsHny&amp;Jlpno Chili 150g        3      13.8
6: Smiths Crinkle Chips Salt &amp; Vinegar 330g        1       5.7
                lifestage premium_customer pack_size brand_name
                   &lt;char&gt;           &lt;char&gt;     &lt;num&gt;     &lt;char&gt;
1:  YOUNG SINGLES/COUPLES          Premium       175    Natural
2: MIDAGE SINGLES/COUPLES           Budget       175        CCs
3: MIDAGE SINGLES/COUPLES           Budget       170     Smiths
4: MIDAGE SINGLES/COUPLES           Budget       175     Smiths
5: MIDAGE SINGLES/COUPLES           Budget       150     Kettle
6: MIDAGE SINGLES/COUPLES           Budget       330     Smiths</code></pre>
</div>
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>combinedData[, .N, brand_name][<span class="fu">order</span>(brand_name)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    brand_name     N
        &lt;char&gt; &lt;int&gt;
 1:     Burger  1564
 2:        CCs  4551
 3:    Cheetos  2927
 4:   Cheezels  4603
 5:       Cobs  9693
 6:     Dorito  3183
 7:    Doritos 22041
 8:     French  1418
 9:      Grain  6272
10:    GrnWves  1468
11:  Infuzions 11057
12:     Infzns  3144
13:     Kettle 41288
14:        NCC  1419
15:    Natural  6050
16:   Pringles 25102
17:        RRD 11894
18:        Red  4427
19:      Smith  2963
20:     Smiths 27390
21:      Snbts  1576
22:   Sunbites  1432
23:      Thins 14075
24:   Tostitos  9471
25:   Twisties  9454
26:   Tyrrells  6442
27:         WW 10320
28: Woolworths  1516
    brand_name     N</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="do">#### Clean brand names</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>combinedData[brand_name <span class="sc">==</span> <span class="st">"Red"</span>, brand_name <span class="sc">:</span><span class="er">=</span> <span class="st">"RRD"</span>]</span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>combinedData[brand_name <span class="sc">==</span><span class="st">'Smith'</span> , brand_name <span class="sc">:</span><span class="er">=</span> <span class="st">'Smiths'</span>]</span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>combinedData[brand_name <span class="sc">==</span> <span class="st">"Snbts"</span>, brand_name <span class="sc">:</span><span class="er">=</span> <span class="st">"Sunbites"</span>]</span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a>combinedData[brand_name <span class="sc">==</span> <span class="st">"Infzns"</span>, brand_name <span class="sc">:</span><span class="er">=</span> <span class="st">"Infuzions"</span>]</span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a>combinedData[brand_name <span class="sc">==</span> <span class="st">"WW"</span>, brand_name <span class="sc">:</span><span class="er">=</span> <span class="st">"Woolworths"</span>]</span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a>combinedData[brand_name <span class="sc">==</span> <span class="st">"NCC"</span>, brand_name <span class="sc">:</span><span class="er">=</span> <span class="st">"Natural"</span>]</span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a>combinedData[brand_name <span class="sc">==</span> <span class="st">"Dorito"</span>, brand_name <span class="sc">:</span><span class="er">=</span> <span class="st">"Doritos"</span>]</span>
<span id="cb60-9"><a href="#cb60-9" aria-hidden="true" tabindex="-1"></a>combinedData[brand_name <span class="sc">==</span> <span class="st">"Grain"</span>, brand_name <span class="sc">:</span><span class="er">=</span> <span class="st">"GrnWves"</span>]</span>
<span id="cb60-10"><a href="#cb60-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-11"><a href="#cb60-11" aria-hidden="true" tabindex="-1"></a>combinedData[, .N, brand_name][<span class="fu">order</span>(brand_name)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    brand_name     N
        &lt;char&gt; &lt;int&gt;
 1:     Burger  1564
 2:        CCs  4551
 3:    Cheetos  2927
 4:   Cheezels  4603
 5:       Cobs  9693
 6:    Doritos 25224
 7:     French  1418
 8:    GrnWves  7740
 9:  Infuzions 14201
10:     Kettle 41288
11:    Natural  7469
12:   Pringles 25102
13:        RRD 16321
14:     Smiths 30353
15:   Sunbites  3008
16:      Thins 14075
17:   Tostitos  9471
18:   Twisties  9454
19:   Tyrrells  6442
20: Woolworths 11836
    brand_name     N</code></pre>
</div>
</div>
<p><strong>Data analysis on customer segments</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(combinedData)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      date              store_nbr     lylty_card_nbr        txn_id       
 Min.   :2018-07-01   Min.   :  1.0   Min.   :   1000   Min.   :      1  
 1st Qu.:2018-09-30   1st Qu.: 70.0   1st Qu.:  70015   1st Qu.:  67569  
 Median :2018-12-30   Median :130.0   Median : 130367   Median : 135182  
 Mean   :2018-12-30   Mean   :135.1   Mean   : 135530   Mean   : 135130  
 3rd Qu.:2019-03-31   3rd Qu.:203.0   3rd Qu.: 203083   3rd Qu.: 202652  
 Max.   :2019-06-30   Max.   :272.0   Max.   :2373711   Max.   :2415841  
    prod_nbr       prod_name            prod_qty       tot_sales     
 Min.   :  1.00   Length:246740      Min.   :1.000   Min.   : 1.700  
 1st Qu.: 26.00   Class :character   1st Qu.:2.000   1st Qu.: 5.800  
 Median : 53.00   Mode  :character   Median :2.000   Median : 7.400  
 Mean   : 56.35                      Mean   :1.906   Mean   : 7.316  
 3rd Qu.: 87.00                      3rd Qu.:2.000   3rd Qu.: 8.800  
 Max.   :114.00                      Max.   :5.000   Max.   :29.500  
  lifestage         premium_customer     pack_size      brand_name       
 Length:246740      Length:246740      Min.   : 70.0   Length:246740     
 Class :character   Class :character   1st Qu.:150.0   Class :character  
 Mode  :character   Mode  :character   Median :170.0   Mode  :character  
                                       Mean   :175.6                     
                                       3rd Qu.:175.0                     
                                       Max.   :380.0                     </code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>combinedData[ , .N, lifestage][<span class="fu">order</span>(lifestage)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                lifestage     N
                   &lt;char&gt; &lt;int&gt;
1: MIDAGE SINGLES/COUPLES 23398
2:           NEW FAMILIES  6497
3:         OLDER FAMILIES 45158
4:  OLDER SINGLES/COUPLES 50793
5:               RETIREES 46431
6:         YOUNG FAMILIES 40494
7:  YOUNG SINGLES/COUPLES 33969</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>combinedData[ , .N, premium_customer][<span class="fu">order</span>(premium_customer)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   premium_customer     N
             &lt;char&gt; &lt;int&gt;
1:           Budget 86762
2:       Mainstream 95043
3:          Premium 64935</code></pre>
</div>
</div>
<p><strong>Understanding sales by lifestyle and premium_cust</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate total sales by LIFESTAGE and PREMIUM_CUSTOMER</span></span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>sales_by_segment <span class="ot">&lt;-</span> combinedData <span class="sc">%&gt;%</span></span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(lifestage, premium_customer) <span class="sc">%&gt;%</span></span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">total_sales =</span> <span class="fu">sum</span>(tot_sales, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`summarise()` has grouped output by 'lifestage'. You can override using the
`.groups` argument.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Check the result</span></span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(sales_by_segment)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 21 × 3
   lifestage              premium_customer total_sales
   &lt;chr&gt;                  &lt;chr&gt;                  &lt;dbl&gt;
 1 MIDAGE SINGLES/COUPLES Budget                33346.
 2 MIDAGE SINGLES/COUPLES Mainstream            84734.
 3 MIDAGE SINGLES/COUPLES Premium               54444.
 4 NEW FAMILIES           Budget                20607.
 5 NEW FAMILIES           Mainstream            15980.
 6 NEW FAMILIES           Premium               10761.
 7 OLDER FAMILIES         Budget               156864.
 8 OLDER FAMILIES         Mainstream            96414.
 9 OLDER FAMILIES         Premium               75243.
10 OLDER SINGLES/COUPLES  Budget               127834.
# ℹ 11 more rows</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Bar plot of total sales by LIFESTAGE and PREMIUM_CUSTOMER</span></span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(sales_by_segment, <span class="fu">aes</span>(<span class="at">x =</span> lifestage, <span class="at">y =</span> total_sales, <span class="at">fill =</span> premium_customer)) <span class="sc">+</span></span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">"identity"</span>, <span class="at">position =</span> <span class="st">"dodge"</span>) <span class="sc">+</span></span>
<span id="cb72-6"><a href="#cb72-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb72-7"><a href="#cb72-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Total Chip Sales by Lifestage and Premium Customer Segment"</span>,</span>
<span id="cb72-8"><a href="#cb72-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Lifestage"</span>,</span>
<span id="cb72-9"><a href="#cb72-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Total Sales"</span></span>
<span id="cb72-10"><a href="#cb72-10" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb72-11"><a href="#cb72-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb72-12"><a href="#cb72-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb72-13"><a href="#cb72-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_brewer</span>(<span class="at">palette =</span> <span class="st">"Set3"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="QVI_files/figure-html/unnamed-chunk-26-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Sales are coming mainly from Budget - older families, Mainstream - young<br>
singles/couples, and Mainstream - retirees</p>
<p>Let’s see if the higher sales are due to there being more customers who buy chips.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate customers by LIFESTAGE and PREMIUM_CUSTOMER</span></span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Count unique customers by lifestage and premium_customer</span></span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a>customers <span class="ot">&lt;-</span> combinedData <span class="sc">%&gt;%</span></span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(lifestage, premium_customer) <span class="sc">%&gt;%</span></span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">customers =</span> <span class="fu">n_distinct</span>(lylty_card_nbr)) <span class="sc">%&gt;%</span></span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`summarise()` has grouped output by 'lifestage'. You can override using the
`.groups` argument.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Check the result</span></span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(customers)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 21 × 3
   lifestage              premium_customer customers
   &lt;chr&gt;                  &lt;chr&gt;                &lt;int&gt;
 1 MIDAGE SINGLES/COUPLES Budget                1474
 2 MIDAGE SINGLES/COUPLES Mainstream            3298
 3 MIDAGE SINGLES/COUPLES Premium               2369
 4 NEW FAMILIES           Budget                1087
 5 NEW FAMILIES           Mainstream             830
 6 NEW FAMILIES           Premium                575
 7 OLDER FAMILIES         Budget                4611
 8 OLDER FAMILIES         Mainstream            2788
 9 OLDER FAMILIES         Premium               2231
10 OLDER SINGLES/COUPLES  Budget                4849
# ℹ 11 more rows</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Bar plot of total sales by LIFESTAGE and PREMIUM_CUSTOMER</span></span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(customers, <span class="fu">aes</span>(<span class="at">x =</span> lifestage, <span class="at">y =</span> customers, <span class="at">fill =</span> premium_customer)) <span class="sc">+</span></span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">"identity"</span>, <span class="at">position =</span> <span class="st">"dodge"</span>) <span class="sc">+</span></span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Total Customers by Lifestage and Premium Customer Segment"</span>,</span>
<span id="cb77-6"><a href="#cb77-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Lifestage"</span>,</span>
<span id="cb77-7"><a href="#cb77-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Customers"</span></span>
<span id="cb77-8"><a href="#cb77-8" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb77-9"><a href="#cb77-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb77-10"><a href="#cb77-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb77-11"><a href="#cb77-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_brewer</span>(<span class="at">palette =</span> <span class="st">"Set3"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="QVI_files/figure-html/unnamed-chunk-28-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>There are more <strong>Mainstream - young singles/couples and Mainstream - retirees</strong> who buy<br>
chips. This contributes to there being more sales to these customer segments (more customers for these sales) but<br>
this is not a major driver for the Budget - Older families segment.<br>
Higher sales may also be driven by more units of chips being bought per customer.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>avg_units_per_cust <span class="ot">&lt;-</span> combinedData <span class="sc">%&gt;%</span></span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(lifestage, premium_customer) <span class="sc">%&gt;%</span></span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">tot_units =</span> <span class="fu">sum</span>(prod_qty),</span>
<span id="cb78-5"><a href="#cb78-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">tot_cust =</span> <span class="fu">n_distinct</span>(lylty_card_nbr),</span>
<span id="cb78-6"><a href="#cb78-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">avg_units =</span> tot_units <span class="sc">/</span> tot_cust</span>
<span id="cb78-7"><a href="#cb78-7" aria-hidden="true" tabindex="-1"></a>  )<span class="sc">%&gt;%</span></span>
<span id="cb78-8"><a href="#cb78-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`summarise()` has grouped output by 'lifestage'. You can override using the
`.groups` argument.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(avg_units_per_cust)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 21 × 5
   lifestage              premium_customer tot_units tot_cust avg_units
   &lt;chr&gt;                  &lt;chr&gt;                &lt;dbl&gt;    &lt;int&gt;     &lt;dbl&gt;
 1 MIDAGE SINGLES/COUPLES Budget                8883     1474      6.03
 2 MIDAGE SINGLES/COUPLES Mainstream           21213     3298      6.43
 3 MIDAGE SINGLES/COUPLES Premium              14400     2369      6.08
 4 NEW FAMILIES           Budget                5241     1087      4.82
 5 NEW FAMILIES           Mainstream            4060      830      4.89
 6 NEW FAMILIES           Premium               2769      575      4.82
 7 OLDER FAMILIES         Budget               41853     4611      9.08
 8 OLDER FAMILIES         Mainstream           25804     2788      9.26
 9 OLDER FAMILIES         Premium              20239     2231      9.07
10 OLDER SINGLES/COUPLES  Budget               32883     4849      6.78
# ℹ 11 more rows</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Bar plot of avg units per customer by LIFESTAGE and PREMIUM_CUSTOMER</span></span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(avg_units_per_cust, <span class="fu">aes</span>(<span class="at">x =</span> lifestage, <span class="at">y =</span> avg_units, <span class="at">fill =</span> premium_customer)) <span class="sc">+</span></span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">"identity"</span>, <span class="at">position =</span> <span class="st">"dodge"</span>) <span class="sc">+</span></span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb82-5"><a href="#cb82-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Avg units per customer by Lifestage and Premium Customer Segment"</span>,</span>
<span id="cb82-6"><a href="#cb82-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Lifestage"</span>,</span>
<span id="cb82-7"><a href="#cb82-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Avg units per customer"</span></span>
<span id="cb82-8"><a href="#cb82-8" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb82-9"><a href="#cb82-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb82-10"><a href="#cb82-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb82-11"><a href="#cb82-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_brewer</span>(<span class="at">palette =</span> <span class="st">"Set3"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="QVI_files/figure-html/unnamed-chunk-30-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Older families and young families in general buy more chips per customer (more quantity per person)</p>
<p><strong>Understanding avg cost per segament</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a>avg_price_per_unit <span class="ot">&lt;-</span> combinedData <span class="sc">%&gt;%</span></span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(lifestage, premium_customer) <span class="sc">%&gt;%</span></span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">sales =</span> <span class="fu">sum</span>(tot_sales),</span>
<span id="cb83-5"><a href="#cb83-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">tot_units =</span> <span class="fu">sum</span>(prod_qty),</span>
<span id="cb83-6"><a href="#cb83-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">avg_price =</span> sales <span class="sc">/</span> tot_units</span>
<span id="cb83-7"><a href="#cb83-7" aria-hidden="true" tabindex="-1"></a>  )<span class="sc">%&gt;%</span></span>
<span id="cb83-8"><a href="#cb83-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`summarise()` has grouped output by 'lifestage'. You can override using the
`.groups` argument.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(avg_price_per_unit)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 21 × 5
   lifestage              premium_customer   sales tot_units avg_price
   &lt;chr&gt;                  &lt;chr&gt;              &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;
 1 MIDAGE SINGLES/COUPLES Budget            33346.      8883      3.75
 2 MIDAGE SINGLES/COUPLES Mainstream        84734.     21213      3.99
 3 MIDAGE SINGLES/COUPLES Premium           54444.     14400      3.78
 4 NEW FAMILIES           Budget            20607.      5241      3.93
 5 NEW FAMILIES           Mainstream        15980.      4060      3.94
 6 NEW FAMILIES           Premium           10761.      2769      3.89
 7 OLDER FAMILIES         Budget           156864.     41853      3.75
 8 OLDER FAMILIES         Mainstream        96414.     25804      3.74
 9 OLDER FAMILIES         Premium           75243.     20239      3.72
10 OLDER SINGLES/COUPLES  Budget           127834.     32883      3.89
# ℹ 11 more rows</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Bar plot of avg price per unit by LIFESTAGE and PREMIUM_CUSTOMER</span></span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(avg_price_per_unit, <span class="fu">aes</span>(<span class="at">x =</span> lifestage, <span class="at">y =</span> avg_price, <span class="at">fill =</span> premium_customer)) <span class="sc">+</span></span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">"identity"</span>, <span class="at">position =</span> <span class="st">"dodge"</span>) <span class="sc">+</span></span>
<span id="cb87-4"><a href="#cb87-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb87-5"><a href="#cb87-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Avg price per unit by Lifestage and Premium Customer Segment"</span>,</span>
<span id="cb87-6"><a href="#cb87-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Lifestage"</span>,</span>
<span id="cb87-7"><a href="#cb87-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Avg price per unit"</span></span>
<span id="cb87-8"><a href="#cb87-8" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb87-9"><a href="#cb87-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb87-10"><a href="#cb87-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb87-11"><a href="#cb87-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_brewer</span>(<span class="at">palette =</span> <span class="st">"Set3"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="QVI_files/figure-html/unnamed-chunk-32-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p><strong>Mainstream midage and young singles and couples are more willing to pay more per<br>
packet of chips</strong> compared to their budget and premium counterparts. This may be due<br>
to premium shoppers being more likely to buy healthy snacks and when they buy<br>
chips, this is mainly for entertainment purposes rather than their own consumption.<br>
This is also supported by there being fewer premium midage and young singles and<br>
couples buying chips compared to their mainstream counterparts.</p>
<p>More price due to more customers in that segment:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a>pricePerUnit <span class="ot">&lt;-</span> combinedData[, price <span class="sc">:</span><span class="er">=</span> tot_sales<span class="sc">/</span>prod_qty]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in `[.data.table`(combinedData, , `:=`(price, tot_sales/prod_qty)):
Invalid .internal.selfref detected and fixed by taking a (shallow) copy of the
data.table so that := can add this new column by reference. At an earlier
point, this data.table has been copied by R (or was created manually using
structure() or similar). Avoid names&lt;- and attr&lt;- which in R currently (and
oddly) may copy the whole data.table. Use set* syntax instead to avoid copying:
?set, ?setnames and ?setattr. If this message doesn't help, please report your
use case to the data.table issue tracker so the root cause can be fixed or this
message improved.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a><span class="fu">t.test</span>(combinedData[lifestage <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"YOUNG SINGLES/COUPLES"</span>, <span class="st">"MIDAGE SINGLES/COUPLES"</span>)</span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a><span class="sc">&amp;</span> premium_customer <span class="sc">==</span> <span class="st">"Mainstream"</span>, price]</span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a>, combinedData[lifestage <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"YOUNG SINGLES/COUPLES"</span>, <span class="st">"MIDAGE SINGLES/COUPLES"</span>)</span>
<span id="cb90-4"><a href="#cb90-4" aria-hidden="true" tabindex="-1"></a><span class="sc">&amp;</span> premium_customer <span class="sc">!=</span> <span class="st">"Mainstream"</span>, price]</span>
<span id="cb90-5"><a href="#cb90-5" aria-hidden="true" tabindex="-1"></a>, <span class="at">alternative =</span> <span class="st">"greater"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Welch Two Sample t-test

data: combinedData[lifestage %in% c("YOUNG SINGLES/COUPLES", "MIDAGE
SINGLES/COUPLES") &amp; premium_customer == "Mainstream", price] and
combinedData[lifestage %in% c("YOUNG SINGLES/COUPLES", "MIDAGE
SINGLES/COUPLES") &amp; premium_customer != "Mainstream", price]
t = 37.624, df = 54791, p-value &lt; 2.2e-16
alternative hypothesis: true difference in means is greater than 0
95 percent confidence interval:
0.3187234 Inf
sample estimates:
mean of x mean of y
4.039786 3.706491</code></pre>
</div>
</div>
<p>The t-test results in a p-value &lt; 2.2e-16, i.e.&nbsp;the unit price for mainstream, young and mid-age singles and<br>
couples are significantly higher than that of budget or premium, young and midage singles and couples.</p>
<p><strong>Exploring YOUNG SINGLES/COUPLES</strong></p>
<p>brand affinity,</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a><span class="do">#### Deep dive into Mainstream, young singles/couples</span></span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a>segment1<span class="ot">&lt;-</span> combinedData[lifestage <span class="sc">==</span> <span class="st">"YOUNG SINGLES/COUPLES"</span> <span class="sc">&amp;</span> premium_customer <span class="sc">==</span></span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a><span class="st">"Mainstream"</span>,]</span>
<span id="cb92-4"><a href="#cb92-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-5"><a href="#cb92-5" aria-hidden="true" tabindex="-1"></a>other <span class="ot">&lt;-</span> combinedData[<span class="sc">!</span>(lifestage <span class="sc">==</span> <span class="st">"YOUNG SINGLES/COUPLES"</span> <span class="sc">&amp;</span> premium_customer <span class="sc">==</span></span>
<span id="cb92-6"><a href="#cb92-6" aria-hidden="true" tabindex="-1"></a><span class="st">"Mainstream"</span>),]</span>
<span id="cb92-7"><a href="#cb92-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-8"><a href="#cb92-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-9"><a href="#cb92-9" aria-hidden="true" tabindex="-1"></a><span class="do">#### Brand affinity compared to the rest of the population</span></span>
<span id="cb92-10"><a href="#cb92-10" aria-hidden="true" tabindex="-1"></a>quantity_segment1 <span class="ot">&lt;-</span> segment1[, <span class="fu">sum</span>(prod_qty)] <span class="co">#Total product quantity for the target segment.</span></span>
<span id="cb92-11"><a href="#cb92-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-12"><a href="#cb92-12" aria-hidden="true" tabindex="-1"></a>quantity_other <span class="ot">&lt;-</span> other[, <span class="fu">sum</span>(prod_qty)]</span>
<span id="cb92-13"><a href="#cb92-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-14"><a href="#cb92-14" aria-hidden="true" tabindex="-1"></a>quantity_segment1_by_brand <span class="ot">&lt;-</span> segment1[, .(<span class="at">targetSegment =</span> <span class="fu">sum</span>(prod_qty)<span class="sc">/</span>quantity_segment1), by <span class="ot">=</span> brand_name] <span class="co">#Proportion of purchases for each brand in the target segment.</span></span>
<span id="cb92-15"><a href="#cb92-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-16"><a href="#cb92-16" aria-hidden="true" tabindex="-1"></a>quantity_other_by_brand <span class="ot">&lt;-</span> other[, .(<span class="at">other =</span> <span class="fu">sum</span>(prod_qty)<span class="sc">/</span>quantity_other), by <span class="ot">=</span> brand_name]</span>
<span id="cb92-17"><a href="#cb92-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-18"><a href="#cb92-18" aria-hidden="true" tabindex="-1"></a>brand_proportions <span class="ot">&lt;-</span>  <span class="fu">merge</span>(quantity_segment1_by_brand, quantity_other_by_brand)[, affinityToBrand <span class="sc">:</span><span class="er">=</span> targetSegment<span class="sc">/</span>other] <span class="co">#Merge Data and Calculate Brand Affinity:</span></span>
<span id="cb92-19"><a href="#cb92-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-20"><a href="#cb92-20" aria-hidden="true" tabindex="-1"></a>brand_proportions[<span class="fu">order</span>(<span class="sc">-</span>affinityToBrand)] </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    brand_name targetSegment       other affinityToBrand
        &lt;char&gt;         &lt;num&gt;       &lt;num&gt;           &lt;num&gt;
 1:   Tyrrells   0.031552795 0.025692464       1.2280953
 2:   Twisties   0.046183575 0.037876520       1.2193194
 3:    Doritos   0.122760524 0.101074684       1.2145526
 4:     Kettle   0.197984817 0.165553442       1.1958967
 5:   Tostitos   0.045410628 0.037977861       1.1957131
 6:   Pringles   0.119420290 0.100634769       1.1866703
 7:       Cobs   0.044637681 0.039048861       1.1431238
 8:  Infuzions   0.064679089 0.057064679       1.1334347
 9:      Thins   0.060372671 0.056986370       1.0594230
10:    GrnWves   0.032712215 0.031187957       1.0488733
11:   Cheezels   0.017971014 0.018646902       0.9637534
12:     Smiths   0.096369910 0.124583692       0.7735355
13:     French   0.003947550 0.005758060       0.6855694
14:    Cheetos   0.008033126 0.012066591       0.6657329
15:        RRD   0.043809524 0.067493678       0.6490908
16:    Natural   0.019599724 0.030853989       0.6352412
17:        CCs   0.011180124 0.018895650       0.5916771
18:   Sunbites   0.006349206 0.012580210       0.5046980
19: Woolworths   0.024099379 0.049427188       0.4875733
20:     Burger   0.002926156 0.006596434       0.4435967
    brand_name targetSegment       other affinityToBrand</code></pre>
</div>
</div>
<p>• Mainstream young singles/couples are 23% more likely to purchase Tyrrells chips compared to the<br>
rest of the population<br>
• Mainstream young singles/couples are 56% less likely to purchase Burger Rings compared to the rest<br>
of the population</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="do">#### Preferred pack size compared to the rest of the population</span></span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a>quantity_segment1_by_pack <span class="ot">&lt;-</span> segment1[, .(<span class="at">targetSegment =</span> <span class="fu">sum</span>(prod_qty)<span class="sc">/</span>quantity_segment1), by <span class="ot">=</span> pack_size]</span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-4"><a href="#cb94-4" aria-hidden="true" tabindex="-1"></a>quantity_other_by_pack <span class="ot">&lt;-</span> other[, .(<span class="at">other =</span> <span class="fu">sum</span>(prod_qty)<span class="sc">/</span>quantity_other), by <span class="ot">=</span> pack_size]</span>
<span id="cb94-5"><a href="#cb94-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-6"><a href="#cb94-6" aria-hidden="true" tabindex="-1"></a>pack_proportions <span class="ot">&lt;-</span> <span class="fu">merge</span>(quantity_segment1_by_pack, quantity_other_by_pack)[,affinityToPack <span class="sc">:</span><span class="er">=</span> targetSegment<span class="sc">/</span>other]</span>
<span id="cb94-7"><a href="#cb94-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-8"><a href="#cb94-8" aria-hidden="true" tabindex="-1"></a>pack_proportions[<span class="fu">order</span>(<span class="sc">-</span>affinityToPack)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    pack_size targetSegment       other affinityToPack
        &lt;num&gt;         &lt;num&gt;       &lt;num&gt;          &lt;num&gt;
 1:       270   0.031828847 0.025095929      1.2682873
 2:       380   0.032160110 0.025584213      1.2570295
 3:       330   0.061283644 0.050161917      1.2217166
 4:       134   0.119420290 0.100634769      1.1866703
 5:       110   0.106280193 0.089791190      1.1836372
 6:       210   0.029123533 0.025121265      1.1593180
 7:       135   0.014768806 0.013075403      1.1295106
 8:       250   0.014354727 0.012780590      1.1231662
 9:       170   0.080772947 0.080985964      0.9973697
10:       150   0.157598344 0.163420656      0.9643722
11:       175   0.254989648 0.270006956      0.9443818
12:       165   0.055652174 0.062267662      0.8937572
13:       190   0.007481021 0.012442016      0.6012708
14:       180   0.003588682 0.006066692      0.5915385
15:       160   0.006404417 0.012372920      0.5176157
16:        90   0.006349206 0.012580210      0.5046980
17:       125   0.003008972 0.006036750      0.4984423
18:       200   0.008971705 0.018656115      0.4808989
19:        70   0.003036577 0.006322350      0.4802924
20:       220   0.002926156 0.006596434      0.4435967
    pack_size targetSegment       other affinityToPack</code></pre>
</div>
</div>
<p>It looks like Mainstream young singles/couples are 27% more likely to purchase a 270g pack of chips com-<br>
pared to the rest of the population but let’s dive into what brands sell this pack size.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a>combinedData[pack_size <span class="sc">==</span> <span class="dv">270</span>, <span class="fu">unique</span>(prod_name)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Twisties Cheese     270g" "Twisties Chicken270g"    </code></pre>
</div>
</div>
<p>Twisties are the only brand offering 270g packs and so this may instead be reflecting a higher likelihood of<br>
purchasing Twisties.</p>
<p>Conclusion<br>
Let’s recap what we’ve found!<br>
Sales have mainly been due to Budget - older families, Mainstream - young singles/couples, and Mainstream<br>
- retirees shoppers. We found that the high spend in chips for mainstream young singles/couples and re-<br>
tirees is due to there being more of them than other buyers. Mainstream, midage and young singles and<br>
couples are also more likely to pay more per packet of chips. This is indicative of impulse buying behaviour.<br>
We’ve also found that Mainstream young singles and couples are 23% more likely to purchase Tyrrells chips<br>
compared to the rest of the population. The Category Manager may want to increase the category’s per-<br>
formance by off-locating some Tyrrells and smaller packs of chips in discretionary space near segments<br>
where young singles and couples frequent more often to increase visibilty and impulse behaviour.<br>
Quantium can help the Category Manager with recommendations of where these segments are and further<br>
help them with measuring the impact of the changed placement. We’ll work on measuring the impact of<br>
trials in the next task and putting all these together in the third task.</p>
<p><strong>#Trial and Control Store Analysis</strong></p>
<p>#Creating metrics to compare trial and other store to find the most similiar control store in pre-trail period</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Creating metrics to compare trial and other store to find the most similiar control store in pre-trail period</span></span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-3"><a href="#cb98-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a YEARMONTH column</span></span>
<span id="cb98-4"><a href="#cb98-4" aria-hidden="true" tabindex="-1"></a>combinedData <span class="ot">&lt;-</span> combinedData <span class="sc">%&gt;%</span></span>
<span id="cb98-5"><a href="#cb98-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">YEARMONTH =</span> <span class="fu">year</span>(date) <span class="sc">*</span> <span class="dv">100</span> <span class="sc">+</span> <span class="fu">month</span>(date))</span>
<span id="cb98-6"><a href="#cb98-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-7"><a href="#cb98-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the metrics over time</span></span>
<span id="cb98-8"><a href="#cb98-8" aria-hidden="true" tabindex="-1"></a>measureOverTime <span class="ot">&lt;-</span> combinedData <span class="sc">%&gt;%</span></span>
<span id="cb98-9"><a href="#cb98-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(store_nbr, YEARMONTH) <span class="sc">%&gt;%</span></span>
<span id="cb98-10"><a href="#cb98-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb98-11"><a href="#cb98-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">totSales =</span> <span class="fu">sum</span>(tot_sales, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb98-12"><a href="#cb98-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">nCustomers =</span> <span class="fu">n_distinct</span>(lylty_card_nbr),</span>
<span id="cb98-13"><a href="#cb98-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">nTxnPerCust =</span> <span class="fu">n_distinct</span>(txn_id) <span class="sc">/</span> <span class="fu">n_distinct</span>(lylty_card_nbr),</span>
<span id="cb98-14"><a href="#cb98-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">nChipsPerTxn =</span> <span class="fu">sum</span>(prod_qty, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">/</span> <span class="fu">n_distinct</span>(txn_id),</span>
<span id="cb98-15"><a href="#cb98-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">avgPricePerUnit =</span> <span class="fu">sum</span>(tot_sales, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">/</span> <span class="fu">sum</span>(prod_qty, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb98-16"><a href="#cb98-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span>  <span class="co"># Ensures the output is ungrouped</span></span>
<span id="cb98-17"><a href="#cb98-17" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb98-18"><a href="#cb98-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-19"><a href="#cb98-19" aria-hidden="true" tabindex="-1"></a>measureOverTime</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3,165 × 7
   store_nbr YEARMONTH totSales nCustomers nTxnPerCust nChipsPerTxn
       &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;      &lt;int&gt;       &lt;dbl&gt;        &lt;dbl&gt;
 1         1    201807     189.         47        1.04         1.18
 2         1    201808     168.         41        1            1.27
 3         1    201809     268.         57        1.04         1.20
 4         1    201810     175.         39        1.03         1.27
 5         1    201811     185.         44        1.02         1.22
 6         1    201812     161.         37        1.08         1.2 
 7         1    201901     150.         35        1            1.17
 8         1    201902     195.         49        1.04         1.14
 9         1    201903     185.         43        1.09         1.19
10         1    201904     177.         39        1.03         1.3 
# ℹ 3,155 more rows
# ℹ 1 more variable: avgPricePerUnit &lt;dbl&gt;</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Extracting stores that have 12 observations</span></span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a>storesWithFullObs <span class="ot">&lt;-</span> measureOverTime <span class="sc">%&gt;%</span></span>
<span id="cb100-3"><a href="#cb100-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(store_nbr) <span class="sc">%&gt;%</span></span>
<span id="cb100-4"><a href="#cb100-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">N =</span> <span class="fu">n</span>(), <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb100-5"><a href="#cb100-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(N <span class="sc">==</span> <span class="dv">12</span>) <span class="sc">%&gt;%</span> <span class="co">#extracting stores that have 12 obs</span></span>
<span id="cb100-6"><a href="#cb100-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(store_nbr)  <span class="co"># Extracting the store numbers as a vector</span></span>
<span id="cb100-7"><a href="#cb100-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-8"><a href="#cb100-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Filtering for the pre-trial period for those stores</span></span>
<span id="cb100-9"><a href="#cb100-9" aria-hidden="true" tabindex="-1"></a>preTrialMeasures <span class="ot">&lt;-</span> measureOverTime <span class="sc">%&gt;%</span></span>
<span id="cb100-10"><a href="#cb100-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(YEARMONTH <span class="sc">&lt;</span> <span class="dv">201902</span> <span class="sc">&amp;</span> store_nbr <span class="sc">%in%</span> storesWithFullObs) </span>
<span id="cb100-11"><a href="#cb100-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-12"><a href="#cb100-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Printing the result</span></span>
<span id="cb100-13"><a href="#cb100-13" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(preTrialMeasures)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1,813 × 7
   store_nbr YEARMONTH totSales nCustomers nTxnPerCust nChipsPerTxn
       &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;      &lt;int&gt;       &lt;dbl&gt;        &lt;dbl&gt;
 1         1    201807     189.         47        1.04         1.18
 2         1    201808     168.         41        1            1.27
 3         1    201809     268.         57        1.04         1.20
 4         1    201810     175.         39        1.03         1.27
 5         1    201811     185.         44        1.02         1.22
 6         1    201812     161.         37        1.08         1.2 
 7         1    201901     150.         35        1            1.17
 8         2    201807     140.         36        1.06         1.13
 9         2    201808     181.         35        1.11         1.28
10         2    201809     134.         32        1.03         1.09
# ℹ 1,803 more rows
# ℹ 1 more variable: avgPricePerUnit &lt;dbl&gt;</code></pre>
</div>
</div>
<p>Creating a function to correlate trial store and all other stores to find the control store</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the function to calculate correlations</span></span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a>calculateCorrelation <span class="ot">&lt;-</span> <span class="cf">function</span>(inputTable, metricCol, storeComparison) {</span>
<span id="cb102-3"><a href="#cb102-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extract the unique store numbers</span></span>
<span id="cb102-4"><a href="#cb102-4" aria-hidden="true" tabindex="-1"></a>  storeNumbers <span class="ot">&lt;-</span> <span class="fu">unique</span>(inputTable<span class="sc">$</span>store_nbr)</span>
<span id="cb102-5"><a href="#cb102-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb102-6"><a href="#cb102-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Initialize an empty data frame for results</span></span>
<span id="cb102-7"><a href="#cb102-7" aria-hidden="true" tabindex="-1"></a>  calcCorrTable <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Store1 =</span> <span class="fu">numeric</span>(), <span class="at">Store2 =</span> <span class="fu">numeric</span>(), <span class="at">corr_measure =</span> <span class="fu">numeric</span>())</span>
<span id="cb102-8"><a href="#cb102-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb102-9"><a href="#cb102-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Loop through each store and calculate correlation</span></span>
<span id="cb102-10"><a href="#cb102-10" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> storeNumbers) {</span>
<span id="cb102-11"><a href="#cb102-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract data for the comparison store and the current store</span></span>
<span id="cb102-12"><a href="#cb102-12" aria-hidden="true" tabindex="-1"></a>    storeComparisonData <span class="ot">&lt;-</span> inputTable <span class="sc">%&gt;%</span></span>
<span id="cb102-13"><a href="#cb102-13" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(store_nbr <span class="sc">==</span> storeComparison) <span class="sc">%&gt;%</span></span>
<span id="cb102-14"><a href="#cb102-14" aria-hidden="true" tabindex="-1"></a>      <span class="fu">pull</span>(<span class="sc">!!</span><span class="fu">sym</span>(metricCol))</span>
<span id="cb102-15"><a href="#cb102-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb102-16"><a href="#cb102-16" aria-hidden="true" tabindex="-1"></a>    storeIData <span class="ot">&lt;-</span> inputTable <span class="sc">%&gt;%</span></span>
<span id="cb102-17"><a href="#cb102-17" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(store_nbr <span class="sc">==</span> i) <span class="sc">%&gt;%</span></span>
<span id="cb102-18"><a href="#cb102-18" aria-hidden="true" tabindex="-1"></a>      <span class="fu">pull</span>(<span class="sc">!!</span><span class="fu">sym</span>(metricCol))</span>
<span id="cb102-19"><a href="#cb102-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb102-20"><a href="#cb102-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate correlation</span></span>
<span id="cb102-21"><a href="#cb102-21" aria-hidden="true" tabindex="-1"></a>    correlation <span class="ot">&lt;-</span> <span class="fu">cor</span>(storeComparisonData, storeIData, <span class="at">use =</span> <span class="st">"complete.obs"</span>)</span>
<span id="cb102-22"><a href="#cb102-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb102-23"><a href="#cb102-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Append results to the results table</span></span>
<span id="cb102-24"><a href="#cb102-24" aria-hidden="true" tabindex="-1"></a>    calcCorrTable <span class="ot">&lt;-</span> <span class="fu">rbind</span>(</span>
<span id="cb102-25"><a href="#cb102-25" aria-hidden="true" tabindex="-1"></a>      calcCorrTable,</span>
<span id="cb102-26"><a href="#cb102-26" aria-hidden="true" tabindex="-1"></a>      <span class="fu">data.frame</span>(<span class="at">Store1 =</span> storeComparison, <span class="at">Store2 =</span> i, <span class="at">corr_measure =</span> correlation)</span>
<span id="cb102-27"><a href="#cb102-27" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb102-28"><a href="#cb102-28" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb102-29"><a href="#cb102-29" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb102-30"><a href="#cb102-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(calcCorrTable)</span>
<span id="cb102-31"><a href="#cb102-31" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>#Cal the abs difference (magnitude) metrics of trail to other stores</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a>calculateMagnitudeDistance <span class="ot">&lt;-</span> <span class="cf">function</span>(inputTable, metricCol, storeComparison) {</span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Initialize an empty data frame for results</span></span>
<span id="cb103-3"><a href="#cb103-3" aria-hidden="true" tabindex="-1"></a>  calcDistTable <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Store1 =</span> <span class="fu">numeric</span>(), <span class="at">Store2 =</span> <span class="fu">numeric</span>(), <span class="at">YEARMONTH =</span> <span class="fu">numeric</span>(), <span class="at">measure =</span> <span class="fu">numeric</span>())</span>
<span id="cb103-4"><a href="#cb103-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb103-5"><a href="#cb103-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extract unique store numbers</span></span>
<span id="cb103-6"><a href="#cb103-6" aria-hidden="true" tabindex="-1"></a>  storeNumbers <span class="ot">&lt;-</span> <span class="fu">unique</span>(inputTable<span class="sc">$</span>store_nbr)</span>
<span id="cb103-7"><a href="#cb103-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb103-8"><a href="#cb103-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Loop through each store to calculate magnitude distance</span></span>
<span id="cb103-9"><a href="#cb103-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> storeNumbers) {</span>
<span id="cb103-10"><a href="#cb103-10" aria-hidden="true" tabindex="-1"></a>    calculatedMeasure <span class="ot">&lt;-</span> inputTable <span class="sc">%&gt;%</span></span>
<span id="cb103-11"><a href="#cb103-11" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(store_nbr <span class="sc">==</span> storeComparison) <span class="sc">%&gt;%</span></span>
<span id="cb103-12"><a href="#cb103-12" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(YEARMONTH, <span class="at">comparisonMetric =</span> <span class="sc">!!</span><span class="fu">sym</span>(metricCol)) <span class="sc">%&gt;%</span></span>
<span id="cb103-13"><a href="#cb103-13" aria-hidden="true" tabindex="-1"></a>      <span class="fu">inner_join</span>(</span>
<span id="cb103-14"><a href="#cb103-14" aria-hidden="true" tabindex="-1"></a>        inputTable <span class="sc">%&gt;%</span></span>
<span id="cb103-15"><a href="#cb103-15" aria-hidden="true" tabindex="-1"></a>          <span class="fu">filter</span>(store_nbr <span class="sc">==</span> i) <span class="sc">%&gt;%</span></span>
<span id="cb103-16"><a href="#cb103-16" aria-hidden="true" tabindex="-1"></a>          <span class="fu">select</span>(YEARMONTH, <span class="at">metricCol =</span> <span class="sc">!!</span><span class="fu">sym</span>(metricCol)),</span>
<span id="cb103-17"><a href="#cb103-17" aria-hidden="true" tabindex="-1"></a>        <span class="at">by =</span> <span class="st">"YEARMONTH"</span></span>
<span id="cb103-18"><a href="#cb103-18" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span></span>
<span id="cb103-19"><a href="#cb103-19" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(</span>
<span id="cb103-20"><a href="#cb103-20" aria-hidden="true" tabindex="-1"></a>        <span class="at">Store1 =</span> storeComparison,</span>
<span id="cb103-21"><a href="#cb103-21" aria-hidden="true" tabindex="-1"></a>        <span class="at">Store2 =</span> i,</span>
<span id="cb103-22"><a href="#cb103-22" aria-hidden="true" tabindex="-1"></a>        <span class="at">measure =</span> <span class="fu">abs</span>(comparisonMetric <span class="sc">-</span> metricCol)</span>
<span id="cb103-23"><a href="#cb103-23" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span></span>
<span id="cb103-24"><a href="#cb103-24" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(Store1, Store2, YEARMONTH, measure)</span>
<span id="cb103-25"><a href="#cb103-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb103-26"><a href="#cb103-26" aria-hidden="true" tabindex="-1"></a>    calcDistTable <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(calcDistTable, calculatedMeasure)</span>
<span id="cb103-27"><a href="#cb103-27" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb103-28"><a href="#cb103-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb103-29"><a href="#cb103-29" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Standardize distances to a range of 0-1</span></span>
<span id="cb103-30"><a href="#cb103-30" aria-hidden="true" tabindex="-1"></a>  distTable <span class="ot">&lt;-</span> calcDistTable <span class="sc">%&gt;%</span></span>
<span id="cb103-31"><a href="#cb103-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(Store1, YEARMONTH) <span class="sc">%&gt;%</span></span>
<span id="cb103-32"><a href="#cb103-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb103-33"><a href="#cb103-33" aria-hidden="true" tabindex="-1"></a>      <span class="at">minDist =</span> <span class="fu">min</span>(measure),</span>
<span id="cb103-34"><a href="#cb103-34" aria-hidden="true" tabindex="-1"></a>      <span class="at">maxDist =</span> <span class="fu">max</span>(measure),</span>
<span id="cb103-35"><a href="#cb103-35" aria-hidden="true" tabindex="-1"></a>      <span class="at">magnitudeMeasure =</span> <span class="dv">1</span> <span class="sc">-</span> (measure <span class="sc">-</span> minDist) <span class="sc">/</span> (maxDist <span class="sc">-</span> minDist)</span>
<span id="cb103-36"><a href="#cb103-36" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb103-37"><a href="#cb103-37" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ungroup</span>()</span>
<span id="cb103-38"><a href="#cb103-38" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb103-39"><a href="#cb103-39" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate the mean standardized magnitude measure</span></span>
<span id="cb103-40"><a href="#cb103-40" aria-hidden="true" tabindex="-1"></a>  finalDistTable <span class="ot">&lt;-</span> distTable <span class="sc">%&gt;%</span></span>
<span id="cb103-41"><a href="#cb103-41" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(Store1, Store2) <span class="sc">%&gt;%</span></span>
<span id="cb103-42"><a href="#cb103-42" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="at">mag_measure =</span> <span class="fu">mean</span>(magnitudeMeasure, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">.groups =</span> <span class="st">"drop"</span>)</span>
<span id="cb103-43"><a href="#cb103-43" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb103-44"><a href="#cb103-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(finalDistTable)</span>
<span id="cb103-45"><a href="#cb103-45" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we set the trial store as 77 and cal the correlation and magnitude for two metrics (tot sales and cust)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Set the trial store</span></span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a>trial_store <span class="ot">&lt;-</span> <span class="dv">77</span></span>
<span id="cb104-3"><a href="#cb104-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-4"><a href="#cb104-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate magnitude distance for `totSales` and `nCustomers`</span></span>
<span id="cb104-5"><a href="#cb104-5" aria-hidden="true" tabindex="-1"></a>magnitude_nSales <span class="ot">&lt;-</span> <span class="fu">calculateMagnitudeDistance</span>(preTrialMeasures, <span class="st">"totSales"</span>, trial_store)</span>
<span id="cb104-6"><a href="#cb104-6" aria-hidden="true" tabindex="-1"></a>magnitude_nCustomers <span class="ot">&lt;-</span> <span class="fu">calculateMagnitudeDistance</span>(preTrialMeasures, <span class="st">"nCustomers"</span>, trial_store)</span>
<span id="cb104-7"><a href="#cb104-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-8"><a href="#cb104-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate correlation for `totSales` and `nCustomers`</span></span>
<span id="cb104-9"><a href="#cb104-9" aria-hidden="true" tabindex="-1"></a>corr_nSales <span class="ot">&lt;-</span> <span class="fu">calculateCorrelation</span>(preTrialMeasures, <span class="st">"totSales"</span>, trial_store)</span>
<span id="cb104-10"><a href="#cb104-10" aria-hidden="true" tabindex="-1"></a>corr_nCustomers <span class="ot">&lt;-</span> <span class="fu">calculateCorrelation</span>(preTrialMeasures, <span class="st">"nCustomers"</span>, trial_store)</span>
<span id="cb104-11"><a href="#cb104-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-12"><a href="#cb104-12" aria-hidden="true" tabindex="-1"></a>magnitude_nCustomers</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 259 × 3
   Store1 Store2 mag_measure
    &lt;dbl&gt;  &lt;dbl&gt;       &lt;dbl&gt;
 1     77      1       0.939
 2     77      2       0.909
 3     77      3       0.343
 4     77      4       0.202
 5     77      5       0.514
 6     77      6       0.925
 7     77      7       0.355
 8     77      8       0.926
 9     77      9       0.880
10     77     10       0.417
# ℹ 249 more rows</code></pre>
</div>
<div class="sourceCode cell-code" id="cb106"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a>corr_nCustomers</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    Store1 Store2 corr_measure
1       77      1  0.337865596
2       77      2 -0.596491730
3       77      3  0.755248715
4       77      4 -0.305411652
5       77      5  0.224768439
6       77      6  0.034804233
7       77      7 -0.074868597
8       77      8 -0.487865821
9       77      9 -0.804503828
10      77     10  0.222015929
11      77     12  0.077787062
12      77     13  0.240590962
13      77     14  0.770074741
14      77     15  0.116053082
15      77     16 -0.536494564
16      77     17  0.577210793
17      77     18 -0.100840224
18      77     19 -0.676742974
19      77     20  0.304077481
20      77     21  0.205024814
21      77     22 -0.450151936
22      77     23  0.021774898
23      77     24 -0.445457781
24      77     25 -0.445343465
25      77     26  0.399159883
26      77     27  0.765510412
27      77     28  0.257194297
28      77     29 -0.340879382
29      77     30  0.385511487
30      77     32  0.290114377
31      77     33  0.313474118
32      77     34  0.065419239
33      77     35  0.892741386
34      77     36  0.409102796
35      77     37  0.532848187
36      77     38 -0.441846072
37      77     39  0.372444107
38      77     40  0.358492932
39      77     41  0.660733078
40      77     42  0.108526799
41      77     43  0.078659472
42      77     45  0.056101852
43      77     46  0.510209444
44      77     47  0.122968758
45      77     48 -0.099162427
46      77     49 -0.390426266
47      77     50  0.709397724
48      77     51  0.070713003
49      77     52 -0.204633819
50      77     53  0.649075117
51      77     54 -0.831479891
52      77     55 -0.413452723
53      77     56  0.170275805
54      77     57  0.829119768
55      77     58  0.030202065
56      77     59  0.153225700
57      77     60  0.459678239
58      77     61 -0.377888007
59      77     62  0.388552481
60      77     63  0.302797221
61      77     64  0.451311145
62      77     65 -0.299480794
63      77     66 -0.122160578
64      77     67 -0.463508743
65      77     68 -0.124392287
66      77     69  0.509082189
67      77     70  0.076565108
68      77     71  0.642298662
69      77     72  0.580632272
70      77     73 -0.091865799
71      77     74 -0.321866245
72      77     75 -0.565016376
73      77     77  1.000000000
74      77     78 -0.220100392
75      77     79  0.135063627
76      77     80 -0.284780397
77      77     81  0.416206609
78      77     82 -0.486902630
79      77     83  0.170396558
80      77     84  0.851521027
81      77     86 -0.097924379
82      77     87 -0.284416307
83      77     88  0.863735513
84      77     89 -0.465909836
85      77     90 -0.404271759
86      77     91  0.018321632
87      77     93  0.251345287
88      77     94  0.275738342
89      77     95  0.068403920
90      77     96  0.294430128
91      77     97 -0.012135647
92      77     98 -0.071402546
93      77     99 -0.144652083
94      77    100 -0.005604339
95      77    101  0.012367644
96      77    102 -0.637109251
97      77    103 -0.272064769
98      77    104  0.347321594
99      77    105  0.791964672
100     77    106  0.094520909
101     77    107 -0.181227126
102     77    108 -0.036988636
103     77    109  0.150129648
104     77    110 -0.230383376
105     77    111  0.454831315
106     77    112  0.008669518
107     77    113  0.901629918
108     77    114  0.164795663
109     77    115  0.448832367
110     77    116 -0.238535267
111     77    118  0.246672625
112     77    119  0.919063856
113     77    120 -0.071468116
114     77    121  0.472694144
115     77    122  0.466168889
116     77    123  0.323521351
117     77    124 -0.365573659
118     77    125 -0.187649736
119     77    126 -0.411649553
120     77    127 -0.194518631
121     77    128  0.453462824
122     77    129 -0.275410142
123     77    130  0.053329195
124     77    131  0.116404764
125     77    132  0.239832372
126     77    133 -0.321730640
127     77    134  0.010555231
128     77    135  0.203617383
129     77    136  0.192953924
130     77    137  0.097133929
131     77    138 -0.548343875
132     77    139  0.382619679
133     77    140  0.041033750
134     77    141 -0.272990471
135     77    142 -0.015018008
136     77    143 -0.139160875
137     77    144  0.129754612
138     77    145  0.537224348
139     77    146  0.135339387
140     77    147 -0.714895663
141     77    148  0.073717466
142     77    149  0.252198648
143     77    150  0.202373970
144     77    151  0.162221093
145     77    152  0.212922101
146     77    153  0.288121874
147     77    154 -0.045314381
148     77    155 -0.251367113
149     77    156  0.063680579
150     77    157  0.832839160
151     77    158 -0.274946226
152     77    159  0.057285850
153     77    160 -0.322266898
154     77    161  0.357750017
155     77    162  0.811531999
156     77    163 -0.527615246
157     77    164  0.246457579
158     77    165 -0.364745854
159     77    166 -0.071234108
160     77    167  0.668651817
161     77    168  0.174852194
162     77    169 -0.784241237
163     77    170  0.076161294
164     77    171 -0.083316421
165     77    172 -0.448164974
166     77    173  0.317372411
167     77    174  0.198657414
168     77    175  0.048107464
169     77    176  0.216761190
170     77    178  0.787521488
171     77    179 -0.451557062
172     77    180 -0.213083449
173     77    181  0.479043286
174     77    182 -0.015627968
175     77    183 -0.307121902
176     77    184 -0.094634566
177     77    185 -0.022044101
178     77    186 -0.766873081
179     77    187  0.336866203
180     77    188  0.360546304
181     77    189 -0.090919528
182     77    190  0.232331326
183     77    191  0.264309721
184     77    192  0.248336772
185     77    194 -0.029936216
186     77    195  0.586982522
187     77    196  0.006385899
188     77    197  0.007467504
189     77    198 -0.119889304
190     77    199  0.273697926
191     77    200  0.240552835
192     77    201  0.063406738
193     77    202  0.332585639
194     77    203  0.410498997
195     77    204  0.283896134
196     77    205  0.306307458
197     77    207 -0.164286487
198     77    208 -0.680224654
199     77    209 -0.285627748
200     77    210 -0.222613744
201     77    212  0.069122642
202     77    213  0.038955321
203     77    214 -0.206971003
204     77    215 -0.472122221
205     77    216 -0.031730484
206     77    217  0.033442044
207     77    219  0.091463974
208     77    220 -0.436540077
209     77    221  0.284321616
210     77    222  0.289713031
211     77    223 -0.068504896
212     77    224 -0.235469922
213     77    225  0.234414387
214     77    226  0.187305318
215     77    227 -0.750629092
216     77    228  0.130615731
217     77    229  0.619161594
218     77    230  0.517208265
219     77    231 -0.200905670
220     77    232 -0.024371626
221     77    233  0.965682150
222     77    234  0.453353867
223     77    235 -0.115481894
224     77    236  0.392445594
225     77    237  0.855156317
226     77    238  0.226913353
227     77    239 -0.392932912
228     77    240 -0.239265557
229     77    241 -0.106793283
230     77    242 -0.741021229
231     77    243 -0.316133412
232     77    244 -0.214893601
233     77    245  0.122259022
234     77    246 -0.235890037
235     77    247 -0.543684054
236     77    248  0.671095201
237     77    249  0.024819824
238     77    250  0.703364132
239     77    251  0.035967209
240     77    253  0.149777703
241     77    254  0.901610499
242     77    255 -0.607162127
243     77    256 -0.060034477
244     77    257  0.402533668
245     77    258 -0.550485658
246     77    259  0.136923234
247     77    260 -0.035351552
248     77    261  0.238681419
249     77    262 -0.244842304
250     77    263  0.275179063
251     77    264  0.181012090
252     77    265  0.498311623
253     77    266 -0.557794289
254     77    267 -0.589794444
255     77    268  0.369735946
256     77    269 -0.247580595
257     77    270 -0.009181744
258     77    271  0.023634941
259     77    272  0.068677178</code></pre>
</div>
</div>
<p>Let’s take a simple average of the correlation and magnitude scores for each driver. Note that if we consider<br>
it more important for the trend of the drivers to be similar, we can increase the weight of the correlation<br>
score (a simple average gives a weight of 0.5 to the corr_weight) or if we consider the absolute size of the<br>
drivers to be more important, we can lower the weight of the correlation score.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb108"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a>corr_nSales</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    Store1 Store2 corr_measure
1       77      1 -0.005382429
2       77      2 -0.251182809
3       77      3  0.660446832
4       77      4 -0.347846468
5       77      5 -0.139047983
6       77      6  0.002086539
7       77      7 -0.029184988
8       77      8 -0.478237510
9       77      9 -0.813285370
10      77     10  0.483885404
11      77     12 -0.112780355
12      77     13 -0.234287449
13      77     14  0.239009597
14      77     15 -0.152914868
15      77     16 -0.224917499
16      77     17  0.707947085
17      77     18 -0.188594509
18      77     19 -0.657861398
19      77     20  0.420737822
20      77     21  0.339770924
21      77     22 -0.640877686
22      77     23  0.309436105
23      77     24 -0.687263219
24      77     25 -0.278647886
25      77     26  0.232659647
26      77     27  0.598531551
27      77     28  0.171571947
28      77     29 -0.304169519
29      77     30  0.740400901
30      77     32 -0.276386603
31      77     33  0.380439000
32      77     34 -0.053713425
33      77     35  0.691089699
34      77     36  0.058758641
35      77     37  0.491132896
36      77     38 -0.065511816
37      77     39  0.286734047
38      77     40  0.013118160
39      77     41  0.659127864
40      77     42  0.084051939
41      77     43  0.259932390
42      77     45  0.153674933
43      77     46  0.309803978
44      77     47 -0.038083235
45      77     48  0.455072694
46      77     49 -0.263387232
47      77     50  0.897701265
48      77     51  0.005706945
49      77     52 -0.216274110
50      77     53  0.636529437
51      77     54 -0.445852823
52      77     55 -0.618714938
53      77     56 -0.145751828
54      77     57  0.267379018
55      77     58  0.018576787
56      77     59  0.065663131
57      77     60  0.691251626
58      77     61 -0.427825856
59      77     62  0.421518470
60      77     63  0.529999059
61      77     64  0.265566794
62      77     65 -0.160347389
63      77     66 -0.230999228
64      77     67 -0.283464716
65      77     68 -0.018047561
66      77     69  0.521826476
67      77     70 -0.166780045
68      77     71  0.815634523
69      77     72  0.274209246
70      77     73  0.047977301
71      77     74 -0.209197522
72      77     75 -0.795205727
73      77     77  1.000000000
74      77     78 -0.337970341
75      77     79 -0.038104580
76      77     80 -0.439189551
77      77     81  0.390603093
78      77     82 -0.279761799
79      77     83 -0.064770497
80      77     84  0.666156810
81      77     86 -0.313469087
82      77     87 -0.117301728
83      77     88 -0.308586946
84      77     89 -0.724137726
85      77     90 -0.439455642
86      77     91  0.022092320
87      77     93  0.272927192
88      77     94 -0.145506509
89      77     95 -0.026832347
90      77     96  0.477429009
91      77     97 -0.309124262
92      77     98  0.158685689
93      77     99 -0.159475709
94      77    100 -0.277307195
95      77    101 -0.245556581
96      77    102 -0.359298458
97      77    103 -0.307816145
98      77    104 -0.137216541
99      77    105  0.686294507
100     77    106 -0.010315800
101     77    107 -0.253436923
102     77    108 -0.024918726
103     77    109 -0.079468503
104     77    110 -0.139552445
105     77    111  0.317923636
106     77    112  0.139714778
107     77    113  0.747222212
108     77    114 -0.232176866
109     77    115  0.603387672
110     77    116  0.005839656
111     77    118 -0.061635585
112     77    119  0.775571366
113     77    120 -0.100525036
114     77    121  0.555559359
115     77    122  0.059351326
116     77    123  0.017816716
117     77    124 -0.189005300
118     77    125 -0.106317744
119     77    126 -0.265621070
120     77    127 -0.101723564
121     77    128  0.213775803
122     77    129 -0.479759185
123     77    130  0.136907385
124     77    131  0.313865324
125     77    132 -0.071020189
126     77    133 -0.133344597
127     77    134 -0.299431461
128     77    135 -0.002449935
129     77    136  0.136206460
130     77    137 -0.408305398
131     77    138 -0.694148961
132     77    139  0.310876045
133     77    140 -0.017496933
134     77    141 -0.144592869
135     77    142 -0.236274699
136     77    143 -0.164411613
137     77    144  0.231551864
138     77    145  0.178278219
139     77    146 -0.215861234
140     77    147 -0.664014177
141     77    148  0.465301246
142     77    149 -0.059100777
143     77    150  0.408594690
144     77    151  0.428611996
145     77    152  0.085546807
146     77    153  0.257418282
147     77    154  0.029130313
148     77    155 -0.308270391
149     77    156  0.010967504
150     77    157  0.776545146
151     77    158 -0.654161229
152     77    159 -0.037191686
153     77    160 -0.149815354
154     77    161  0.438754678
155     77    162  0.857583939
156     77    163 -0.069703560
157     77    164  0.160535801
158     77    165  0.037613163
159     77    166 -0.110938680
160     77    167  0.654667967
161     77    168  0.456542499
162     77    169 -0.649458736
163     77    170  0.039518046
164     77    171 -0.201972576
165     77    172 -0.624276766
166     77    173  0.115279745
167     77    174  0.036170465
168     77    175  0.224373367
169     77    176  0.369105177
170     77    178  0.557391049
171     77    179 -0.519941762
172     77    180 -0.383982753
173     77    181  0.226152918
174     77    182 -0.205342831
175     77    183 -0.042596657
176     77    184 -0.176693368
177     77    185 -0.120745883
178     77    186 -0.917130597
179     77    187  0.329609148
180     77    188  0.542510773
181     77    189  0.107316190
182     77    190 -0.154926236
183     77    191  0.167095678
184     77    192  0.635491407
185     77    194 -0.114008855
186     77    195  0.488218397
187     77    196  0.298771575
188     77    197  0.266614090
189     77    198 -0.396737802
190     77    199  0.440352301
191     77    200 -0.029187880
192     77    201 -0.373382343
193     77    202  0.503645827
194     77    203  0.422221556
195     77    204 -0.055358491
196     77    205  0.273728007
197     77    207 -0.019548597
198     77    208 -0.479055501
199     77    209 -0.148265146
200     77    210 -0.135293606
201     77    212  0.017174891
202     77    213  0.253010597
203     77    214  0.057036200
204     77    215 -0.060415209
205     77    216  0.134718583
206     77    217  0.261240270
207     77    219  0.026938156
208     77    220 -0.118851894
209     77    221  0.481879754
210     77    222  0.095225000
211     77    223 -0.335925768
212     77    224 -0.270702125
213     77    225  0.064336107
214     77    226  0.161392594
215     77    227 -0.504082231
216     77    228  0.225776896
217     77    229  0.308421201
218     77    230 -0.029715599
219     77    231 -0.032915550
220     77    232  0.370690787
221     77    233  0.973642941
222     77    234  0.654696189
223     77    235  0.102849791
224     77    236  0.541828412
225     77    237  0.660345509
226     77    238 -0.092060049
227     77    239 -0.218496064
228     77    240 -0.338603966
229     77    241 -0.306651437
230     77    242 -0.804103979
231     77    243 -0.365119093
232     77    244 -0.729337335
233     77    245  0.247950955
234     77    246 -0.178433750
235     77    247 -0.710906231
236     77    248  0.360322435
237     77    249 -0.350070038
238     77    250  0.636892538
239     77    251  0.175344004
240     77    253  0.135624790
241     77    254  0.584872920
242     77    255 -0.146885686
243     77    256  0.086989588
244     77    257  0.598984220
245     77    258 -0.503033701
246     77    259 -0.088608968
247     77    260 -0.067615600
248     77    261 -0.272061258
249     77    262  0.236336041
250     77    263  0.318835822
251     77    264  0.368357525
252     77    265  0.462883434
253     77    266 -0.251162707
254     77    267 -0.443938535
255     77    268  0.395460337
256     77    269 -0.466370424
257     77    270  0.274854303
258     77    271  0.195189898
259     77    272 -0.179646952</code></pre>
</div>
<div class="sourceCode cell-code" id="cb110"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Set correlation weight</span></span>
<span id="cb110-2"><a href="#cb110-2" aria-hidden="true" tabindex="-1"></a>corr_weight <span class="ot">&lt;-</span> <span class="fl">0.5</span> <span class="co">#balancing out the the important of both correlation and magnitude</span></span>
<span id="cb110-3"><a href="#cb110-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-4"><a href="#cb110-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge and calculate score for nSales</span></span>
<span id="cb110-5"><a href="#cb110-5" aria-hidden="true" tabindex="-1"></a>score_nSales <span class="ot">&lt;-</span> corr_nSales <span class="sc">%&gt;%</span></span>
<span id="cb110-6"><a href="#cb110-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(magnitude_nSales, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"Store1"</span>, <span class="st">"Store2"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb110-7"><a href="#cb110-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb110-8"><a href="#cb110-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">scoreNSales =</span> corr_measure <span class="sc">*</span> corr_weight <span class="sc">+</span> mag_measure <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> corr_weight)</span>
<span id="cb110-9"><a href="#cb110-9" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb110-10"><a href="#cb110-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-11"><a href="#cb110-11" aria-hidden="true" tabindex="-1"></a>score_nSales</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    Store1 Store2 corr_measure mag_measure   scoreNSales
1       77      1 -0.005382429  0.95253665  0.4735771091
2       77      2 -0.251182809  0.93606981  0.3424434998
3       77      3  0.660446832  0.34499591  0.5027213697
4       77      4 -0.347846468  0.18084965 -0.0834984086
5       77      5 -0.139047983  0.56445679  0.2127044033
6       77      6  0.002086539  0.96578744  0.4839369918
7       77      7 -0.029184988  0.37200154  0.1714082758
8       77      8 -0.478237510  0.89092659  0.2063445377
9       77      9 -0.813285370  0.91765454  0.0521845851
10      77     10  0.483885404  0.49901851  0.4914519575
11      77     12 -0.112780355  0.85560615  0.3714128989
12      77     13 -0.234287449  0.52486557  0.1452890581
13      77     14  0.239009597  0.84182136  0.5404154801
14      77     15 -0.152914868  0.57144924  0.2092671841
15      77     16 -0.224917499  0.92627153  0.3506770172
16      77     17  0.707947085  0.88612950  0.7970382937
17      77     18 -0.188594509  0.96788002  0.3896427550
18      77     19 -0.657861398  0.59507196 -0.0313947208
19      77     20  0.420737822  0.96289901  0.6918184168
20      77     21  0.339770924  0.84286497  0.5913179488
21      77     22 -0.640877686  0.94745136  0.1532868345
22      77     23  0.309436105  0.53330511  0.4213706065
23      77     24 -0.687263219  0.60484912 -0.0412070479
24      77     25 -0.278647886  0.84896503  0.2851585724
25      77     26  0.232659647  0.25641738  0.2445385156
26      77     27  0.598531551  0.85552568  0.7270286163
27      77     28  0.171571947  0.57314550  0.3723587218
28      77     29 -0.304169519  0.89021563  0.2930230555
29      77     30  0.740400901  0.51277420  0.6265875513
30      77     32 -0.276386603  0.51630816  0.1199607768
31      77     33  0.380439000  0.45994981  0.4201944073
32      77     34 -0.053713425  0.90148175  0.4238841623
33      77     35  0.691089699  0.90767119  0.7993804422
34      77     36  0.058758641  0.38398218  0.2213704116
35      77     37  0.491132896  0.86097537  0.6760541305
36      77     38 -0.065511816  0.95992145  0.4472048196
37      77     39  0.286734047  0.52377039  0.4052522186
38      77     40  0.013118160  0.22173184  0.1174249996
39      77     41  0.659127864  0.95689257  0.8080102161
40      77     42  0.084051939  0.83194843  0.4580001822
41      77     43  0.259932390  0.39764591  0.3287891498
42      77     45  0.153674933  0.58060260  0.3671387649
43      77     46  0.309803978  0.97387251  0.6418382445
44      77     47 -0.038083235  0.88341773  0.4226672452
45      77     48  0.455072694  0.51779435  0.4864335223
46      77     49 -0.263387232  0.36232146  0.0494671135
47      77     50  0.897701265  0.97438355  0.9360424099
48      77     51  0.005706945  0.93700805  0.4713574982
49      77     52 -0.216274110  0.84098483  0.3123553580
50      77     53  0.636529437  0.97211427  0.8043218517
51      77     54 -0.445852823  0.81733370  0.1857404394
52      77     55 -0.618714938  0.47505656 -0.0718291872
53      77     56 -0.145751828  0.64071855  0.2474833611
54      77     57  0.267379018  0.52117402  0.3942765209
55      77     58  0.018576787  0.18395901  0.1012678988
56      77     59  0.065663131  0.34174396  0.2037035444
57      77     60  0.691251626  0.34941344  0.5203325349
58      77     61 -0.427825856  0.85082828  0.2115012129
59      77     62  0.421518470  0.50459081  0.4630546417
60      77     63  0.529999059  0.43822228  0.4841106677
61      77     64  0.265566794  0.87324385  0.5694053197
62      77     65 -0.160347389  0.35653410  0.0980933538
63      77     66 -0.230999228  0.86397441  0.3164875912
64      77     67 -0.283464716  0.52944860  0.1229919401
65      77     68 -0.018047561  0.93722829  0.4595903657
66      77     69  0.521826476  0.45840670  0.4901165857
67      77     70 -0.166780045  0.54681400  0.1900169762
68      77     71  0.815634523  0.45017391  0.6329042177
69      77     72  0.274209246  0.26217376  0.2681915036
70      77     73  0.047977301  0.93906338  0.4935203420
71      77     74 -0.209197522  0.94511663  0.3679595560
72      77     75 -0.795205727  0.31570975 -0.2397479861
73      77     77  1.000000000  1.00000000  1.0000000000
74      77     78 -0.337970341  0.58271844  0.1223740510
75      77     79 -0.038104580  0.40439775  0.1831465839
76      77     80 -0.439189551  0.43720605 -0.0009917523
77      77     81  0.390603093  0.27387995  0.3322415207
78      77     82 -0.279761799  0.93275805  0.3264981240
79      77     83 -0.064770497  0.55304121  0.2441353549
80      77     84  0.666156810  0.82932501  0.7477409078
81      77     86 -0.313469087  0.50924027  0.0978855901
82      77     87 -0.117301728  0.92817809  0.4054381802
83      77     88 -0.308586946  0.15058837 -0.0789992868
84      77     89 -0.724137726  0.94424666  0.1100544659
85      77     90 -0.439455642  0.95220117  0.2563727624
86      77     91  0.022092320  0.50529387  0.2636930942
87      77     93  0.272927192  0.37868901  0.3258081028
88      77     94 -0.145506509  0.42314746  0.1388204734
89      77     95 -0.026832347  0.30908534  0.1411264957
90      77     96  0.477429009  0.89484046  0.6861347358
91      77     97 -0.309124262  0.50660658  0.0987411580
92      77     98  0.158685689  0.90491769  0.5318016892
93      77     99 -0.159475709  0.82496693  0.3327456085
94      77    100 -0.277307195  0.43452929  0.0786110458
95      77    101 -0.245556581  0.53218134  0.1433123791
96      77    102 -0.359298458  0.49933230  0.0700169218
97      77    103 -0.307816145  0.95137010  0.3217769794
98      77    104 -0.137216541  0.52381563  0.1932995449
99      77    105  0.686294507  0.51502380  0.6006591529
100     77    106 -0.010315800  0.46781048  0.2287473418
101     77    107 -0.253436923  0.57767547  0.1621192717
102     77    108 -0.024918726  0.94329346  0.4591873656
103     77    109 -0.079468503  0.51029348  0.2154124898
104     77    110 -0.139552445  0.57276570  0.2166066289
105     77    111  0.317923636  0.96336503  0.6406443327
106     77    112  0.139714778  0.47976006  0.3097374183
107     77    113  0.747222212  0.48170716  0.6144646859
108     77    114 -0.232176866  0.46806547  0.1179443029
109     77    115  0.603387672  0.93263684  0.7680122547
110     77    116  0.005839656  0.51694511  0.2613923820
111     77    118 -0.061635585  0.55632635  0.2473453821
112     77    119  0.775571366  0.44683585  0.6112036061
113     77    120 -0.100525036  0.92987697  0.4146759661
114     77    121  0.555559359  0.94482515  0.7501922540
115     77    122  0.059351326  0.52557848  0.2924649011
116     77    123  0.017816716  0.29535556  0.1565861400
117     77    124 -0.189005300  0.94157547  0.3762850847
118     77    125 -0.106317744  0.30425100  0.0989666298
119     77    126 -0.265621070  0.89367342  0.3140261754
120     77    127 -0.101723564  0.83550532  0.3668908787
121     77    128  0.213775803  0.42914545  0.3214606289
122     77    129 -0.479759185  0.57090069  0.0455707503
123     77    130  0.136907385  0.28159379  0.2092505858
124     77    131  0.313865324  0.97607236  0.6449688438
125     77    132 -0.071020189  0.84335952  0.3861696670
126     77    133 -0.133344597  0.43712400  0.1518897008
127     77    134 -0.299431461  0.85120945  0.2758889957
128     77    135 -0.002449935  0.83592991  0.4167399858
129     77    136  0.136206460  0.92767497  0.5319407151
130     77    137 -0.408305398  0.45910884  0.0254017207
131     77    138 -0.694148961  0.50849698 -0.0928259921
132     77    139  0.310876045  0.83439261  0.5726343262
133     77    140 -0.017496933  0.83013344  0.4063182524
134     77    141 -0.144592869  0.96095205  0.4081795907
135     77    142 -0.236274699  0.82353602  0.2936306617
136     77    143 -0.164411613  0.89723960  0.3664139932
137     77    144  0.231551864  0.62883589  0.4301938763
138     77    145  0.178278219  0.94057302  0.5594256208
139     77    146 -0.215861234  0.83171872  0.3079287442
140     77    147 -0.664014177  0.56619609 -0.0489090421
141     77    148  0.465301246  0.63145505  0.5483781467
142     77    149 -0.059100777  0.86943869  0.4051689563
143     77    150  0.408594690  0.84157356  0.6250841265
144     77    151  0.428611996  0.92507824  0.6768451183
145     77    152  0.085546807  0.40983549  0.2476911503
146     77    153  0.257418282  0.34161777  0.2995180242
147     77    154  0.029130313  0.37163824  0.2003842786
148     77    155 -0.308270391  0.48885205  0.0902908320
149     77    156  0.010967504  0.41813679  0.2145521490
150     77    157  0.776545146  0.47628154  0.6264133422
151     77    158 -0.654161229  0.83621957  0.0910291727
152     77    159 -0.037191686  0.83245706  0.3976326893
153     77    160 -0.149815354  0.49515793  0.1726712867
154     77    161  0.438754678  0.83827716  0.6385159166
155     77    162  0.857583939  0.54548390  0.7015339196
156     77    163 -0.069703560  0.96391382  0.4471051294
157     77    164  0.160535801  0.51070999  0.3356228977
158     77    165  0.037613163  0.16189998  0.0997565730
159     77    166 -0.110938680  0.40150840  0.1452848582
160     77    167  0.654667967  0.95465879  0.8046633798
161     77    168  0.456542499  0.44064743  0.4485949668
162     77    169 -0.649458736  0.94721508  0.1488781700
163     77    170  0.039518046  0.87131883  0.4554184388
164     77    171 -0.201972576  0.88852514  0.3432762805
165     77    172 -0.624276766  0.52716468 -0.0485560451
166     77    173  0.115279745  0.82020248  0.4677411140
167     77    174  0.036170465  0.90953607  0.4728532662
168     77    175  0.224373367  0.43604817  0.3302107706
169     77    176  0.369105177  0.96344076  0.6662729662
170     77    178  0.557391049  0.47606829  0.5167296716
171     77    179 -0.519941762  0.46485598 -0.0275428901
172     77    180 -0.383982753  0.51015373  0.0630854903
173     77    181  0.226152918  0.26248105  0.2443169829
174     77    182 -0.205342831  0.88333375  0.3389954620
175     77    183 -0.042596657  0.55848432  0.2579438326
176     77    184 -0.176693368  0.48881441  0.1560605188
177     77    185 -0.120745883  0.96829741  0.4237757649
178     77    186 -0.917130597  0.93603941  0.0094544088
179     77    187  0.329609148  0.96942502  0.6495170847
180     77    188  0.542510773  0.97857803  0.7605444033
181     77    189  0.107316190  0.90348451  0.5054003489
182     77    190 -0.154926236  0.56443032  0.2047520399
183     77    191  0.167095678  0.54827778  0.3576867265
184     77    192  0.635491407  0.83950199  0.7374966995
185     77    194 -0.114008855  0.33463157  0.1103113553
186     77    195  0.488218397  0.96312823  0.7256733117
187     77    196  0.298771575  0.52987169  0.4143216323
188     77    197  0.266614090  0.93474476  0.6006794273
189     77    198 -0.396737802  0.82953187  0.2163970329
190     77    199  0.440352301  0.22625833  0.3333053146
191     77    200 -0.029187880  0.78935799  0.3800850555
192     77    201 -0.373382343  0.28017568 -0.0466033300
193     77    202  0.503645827  0.80025239  0.6519491066
194     77    203  0.422221556  0.21553698  0.3188792683
195     77    204 -0.055358491  0.84424966  0.3944455863
196     77    205  0.273728007  0.97567969  0.6247038504
197     77    207 -0.019548597  0.51645999  0.2484556973
198     77    208 -0.479055501  0.62065962  0.0708020570
199     77    209 -0.148265146  0.56008795  0.2059114028
200     77    210 -0.135293606  0.29925490  0.0819806468
201     77    212  0.017174891  0.65032364  0.3337492672
202     77    213  0.253010597  0.40786575  0.3304381746
203     77    214  0.057036200  0.96731369  0.5121749435
204     77    215 -0.060415209  0.89298504  0.4162849160
205     77    216  0.134718583  0.35367993  0.2441992577
206     77    217  0.261240270  0.26424058  0.2627404268
207     77    219  0.026938156  0.55509758  0.2910178669
208     77    220 -0.118851894  0.97259590  0.4268720037
209     77    221  0.481879754  0.49549345  0.4886866007
210     77    222  0.095225000  0.54170521  0.3184651044
211     77    223 -0.335925768  0.45459375  0.0593339902
212     77    224 -0.270702125  0.83408470  0.2816912865
213     77    225  0.064336107  0.53514801  0.2997420579
214     77    226  0.161392594  0.06137464  0.1113836157
215     77    227 -0.504082231  0.50571023  0.0008139983
216     77    228  0.225776896  0.91685589  0.5713163930
217     77    229  0.308421201  0.55629116  0.4323561814
218     77    230 -0.029715599  0.42857332  0.1994288621
219     77    231 -0.032915550  0.35310544  0.1600949433
220     77    232  0.370690787  0.49296019  0.4318254871
221     77    233  0.973642941  0.98589670  0.9797698229
222     77    234  0.654696189  0.88467209  0.7696841381
223     77    235  0.102849791  0.81952324  0.4611865151
224     77    236  0.541828412  0.51702213  0.5294252685
225     77    237  0.660345509  0.14128953  0.4008175184
226     77    238 -0.092060049  0.27162901  0.0897844790
227     77    239 -0.218496064  0.92381207  0.3526580032
228     77    240 -0.338603966  0.88160623  0.2715011334
229     77    241 -0.306651437  0.57201820  0.1326833791
230     77    242 -0.804103979  0.80221974 -0.0009421184
231     77    243 -0.365119093  0.89387567  0.2643782875
232     77    244 -0.729337335  0.83385032  0.0522564920
233     77    245  0.247950955  0.91079165  0.5793713007
234     77    246 -0.178433750  0.79202792  0.3067970831
235     77    247 -0.710906231  0.53193051 -0.0894878589
236     77    248  0.360322435  0.89267614  0.6264992897
237     77    249 -0.350070038  0.95706498  0.3034974687
238     77    250  0.636892538  0.34159701  0.4892447755
239     77    251  0.175344004  0.87095888  0.5231514410
240     77    253  0.135624790  0.87513493  0.5053798588
241     77    254  0.584872920  0.92096584  0.7529193791
242     77    255 -0.146885686  0.97416474  0.4136395295
243     77    256  0.086989588  0.94752652  0.5172580538
244     77    257  0.598984220  0.48826268  0.5436234479
245     77    258 -0.503033701  0.83121714  0.1640917216
246     77    259 -0.088608968  0.44726370  0.1793273673
247     77    260 -0.067615600  0.85850777  0.3954460828
248     77    261 -0.272061258  0.27150791 -0.0002766743
249     77    262  0.236336041  0.60612781  0.4212319279
250     77    263  0.318835822  0.83327440  0.5760551130
251     77    264  0.368357525  0.96794041  0.6681489650
252     77    265  0.462883434  0.95761218  0.7102478051
253     77    266 -0.251162707  0.92516110  0.3369991962
254     77    267 -0.443938535  0.83078230  0.1934218846
255     77    268  0.395460337  0.96248883  0.6789745820
256     77    269 -0.466370424  0.45464109 -0.0058646649
257     77    270  0.274854303  0.45792331  0.3663888080
258     77    271  0.195189898  0.57202067  0.3836052843
259     77    272 -0.179646952  0.89174764  0.3560503429</code></pre>
</div>
<div class="sourceCode cell-code" id="cb112"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge and calculate score for nCustomers</span></span>
<span id="cb112-2"><a href="#cb112-2" aria-hidden="true" tabindex="-1"></a>score_nCustomers <span class="ot">&lt;-</span> corr_nCustomers <span class="sc">%&gt;%</span></span>
<span id="cb112-3"><a href="#cb112-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(magnitude_nCustomers, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"Store1"</span>, <span class="st">"Store2"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb112-4"><a href="#cb112-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb112-5"><a href="#cb112-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">scoreNCust =</span> corr_measure <span class="sc">*</span> corr_weight <span class="sc">+</span> mag_measure <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> corr_weight)</span>
<span id="cb112-6"><a href="#cb112-6" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>combining the score across the drivers (sales and customers)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb113"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge score_nSales and score_nCustomers</span></span>
<span id="cb113-2"><a href="#cb113-2" aria-hidden="true" tabindex="-1"></a>score_Control <span class="ot">&lt;-</span> score_nSales <span class="sc">%&gt;%</span></span>
<span id="cb113-3"><a href="#cb113-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(score_nCustomers, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"Store1"</span>, <span class="st">"Store2"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb113-4"><a href="#cb113-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">finalControlScore =</span> scoreNSales <span class="sc">*</span> <span class="fl">0.5</span> <span class="sc">+</span> scoreNCust <span class="sc">*</span> <span class="fl">0.5</span>)</span>
<span id="cb113-5"><a href="#cb113-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-6"><a href="#cb113-6" aria-hidden="true" tabindex="-1"></a>score_Control</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    Store1 Store2 corr_measure.x mag_measure.x   scoreNSales corr_measure.y
1       77      1   -0.005382429    0.95253665  0.4735771091    0.337865596
2       77      2   -0.251182809    0.93606981  0.3424434998   -0.596491730
3       77      3    0.660446832    0.34499591  0.5027213697    0.755248715
4       77      4   -0.347846468    0.18084965 -0.0834984086   -0.305411652
5       77      5   -0.139047983    0.56445679  0.2127044033    0.224768439
6       77      6    0.002086539    0.96578744  0.4839369918    0.034804233
7       77      7   -0.029184988    0.37200154  0.1714082758   -0.074868597
8       77      8   -0.478237510    0.89092659  0.2063445377   -0.487865821
9       77      9   -0.813285370    0.91765454  0.0521845851   -0.804503828
10      77     10    0.483885404    0.49901851  0.4914519575    0.222015929
11      77     12   -0.112780355    0.85560615  0.3714128989    0.077787062
12      77     13   -0.234287449    0.52486557  0.1452890581    0.240590962
13      77     14    0.239009597    0.84182136  0.5404154801    0.770074741
14      77     15   -0.152914868    0.57144924  0.2092671841    0.116053082
15      77     16   -0.224917499    0.92627153  0.3506770172   -0.536494564
16      77     17    0.707947085    0.88612950  0.7970382937    0.577210793
17      77     18   -0.188594509    0.96788002  0.3896427550   -0.100840224
18      77     19   -0.657861398    0.59507196 -0.0313947208   -0.676742974
19      77     20    0.420737822    0.96289901  0.6918184168    0.304077481
20      77     21    0.339770924    0.84286497  0.5913179488    0.205024814
21      77     22   -0.640877686    0.94745136  0.1532868345   -0.450151936
22      77     23    0.309436105    0.53330511  0.4213706065    0.021774898
23      77     24   -0.687263219    0.60484912 -0.0412070479   -0.445457781
24      77     25   -0.278647886    0.84896503  0.2851585724   -0.445343465
25      77     26    0.232659647    0.25641738  0.2445385156    0.399159883
26      77     27    0.598531551    0.85552568  0.7270286163    0.765510412
27      77     28    0.171571947    0.57314550  0.3723587218    0.257194297
28      77     29   -0.304169519    0.89021563  0.2930230555   -0.340879382
29      77     30    0.740400901    0.51277420  0.6265875513    0.385511487
30      77     32   -0.276386603    0.51630816  0.1199607768    0.290114377
31      77     33    0.380439000    0.45994981  0.4201944073    0.313474118
32      77     34   -0.053713425    0.90148175  0.4238841623    0.065419239
33      77     35    0.691089699    0.90767119  0.7993804422    0.892741386
34      77     36    0.058758641    0.38398218  0.2213704116    0.409102796
35      77     37    0.491132896    0.86097537  0.6760541305    0.532848187
36      77     38   -0.065511816    0.95992145  0.4472048196   -0.441846072
37      77     39    0.286734047    0.52377039  0.4052522186    0.372444107
38      77     40    0.013118160    0.22173184  0.1174249996    0.358492932
39      77     41    0.659127864    0.95689257  0.8080102161    0.660733078
40      77     42    0.084051939    0.83194843  0.4580001822    0.108526799
41      77     43    0.259932390    0.39764591  0.3287891498    0.078659472
42      77     45    0.153674933    0.58060260  0.3671387649    0.056101852
43      77     46    0.309803978    0.97387251  0.6418382445    0.510209444
44      77     47   -0.038083235    0.88341773  0.4226672452    0.122968758
45      77     48    0.455072694    0.51779435  0.4864335223   -0.099162427
46      77     49   -0.263387232    0.36232146  0.0494671135   -0.390426266
47      77     50    0.897701265    0.97438355  0.9360424099    0.709397724
48      77     51    0.005706945    0.93700805  0.4713574982    0.070713003
49      77     52   -0.216274110    0.84098483  0.3123553580   -0.204633819
50      77     53    0.636529437    0.97211427  0.8043218517    0.649075117
51      77     54   -0.445852823    0.81733370  0.1857404394   -0.831479891
52      77     55   -0.618714938    0.47505656 -0.0718291872   -0.413452723
53      77     56   -0.145751828    0.64071855  0.2474833611    0.170275805
54      77     57    0.267379018    0.52117402  0.3942765209    0.829119768
55      77     58    0.018576787    0.18395901  0.1012678988    0.030202065
56      77     59    0.065663131    0.34174396  0.2037035444    0.153225700
57      77     60    0.691251626    0.34941344  0.5203325349    0.459678239
58      77     61   -0.427825856    0.85082828  0.2115012129   -0.377888007
59      77     62    0.421518470    0.50459081  0.4630546417    0.388552481
60      77     63    0.529999059    0.43822228  0.4841106677    0.302797221
61      77     64    0.265566794    0.87324385  0.5694053197    0.451311145
62      77     65   -0.160347389    0.35653410  0.0980933538   -0.299480794
63      77     66   -0.230999228    0.86397441  0.3164875912   -0.122160578
64      77     67   -0.283464716    0.52944860  0.1229919401   -0.463508743
65      77     68   -0.018047561    0.93722829  0.4595903657   -0.124392287
66      77     69    0.521826476    0.45840670  0.4901165857    0.509082189
67      77     70   -0.166780045    0.54681400  0.1900169762    0.076565108
68      77     71    0.815634523    0.45017391  0.6329042177    0.642298662
69      77     72    0.274209246    0.26217376  0.2681915036    0.580632272
70      77     73    0.047977301    0.93906338  0.4935203420   -0.091865799
71      77     74   -0.209197522    0.94511663  0.3679595560   -0.321866245
72      77     75   -0.795205727    0.31570975 -0.2397479861   -0.565016376
73      77     77    1.000000000    1.00000000  1.0000000000    1.000000000
74      77     78   -0.337970341    0.58271844  0.1223740510   -0.220100392
75      77     79   -0.038104580    0.40439775  0.1831465839    0.135063627
76      77     80   -0.439189551    0.43720605 -0.0009917523   -0.284780397
77      77     81    0.390603093    0.27387995  0.3322415207    0.416206609
78      77     82   -0.279761799    0.93275805  0.3264981240   -0.486902630
79      77     83   -0.064770497    0.55304121  0.2441353549    0.170396558
80      77     84    0.666156810    0.82932501  0.7477409078    0.851521027
81      77     86   -0.313469087    0.50924027  0.0978855901   -0.097924379
82      77     87   -0.117301728    0.92817809  0.4054381802   -0.284416307
83      77     88   -0.308586946    0.15058837 -0.0789992868    0.863735513
84      77     89   -0.724137726    0.94424666  0.1100544659   -0.465909836
85      77     90   -0.439455642    0.95220117  0.2563727624   -0.404271759
86      77     91    0.022092320    0.50529387  0.2636930942    0.018321632
87      77     93    0.272927192    0.37868901  0.3258081028    0.251345287
88      77     94   -0.145506509    0.42314746  0.1388204734    0.275738342
89      77     95   -0.026832347    0.30908534  0.1411264957    0.068403920
90      77     96    0.477429009    0.89484046  0.6861347358    0.294430128
91      77     97   -0.309124262    0.50660658  0.0987411580   -0.012135647
92      77     98    0.158685689    0.90491769  0.5318016892   -0.071402546
93      77     99   -0.159475709    0.82496693  0.3327456085   -0.144652083
94      77    100   -0.277307195    0.43452929  0.0786110458   -0.005604339
95      77    101   -0.245556581    0.53218134  0.1433123791    0.012367644
96      77    102   -0.359298458    0.49933230  0.0700169218   -0.637109251
97      77    103   -0.307816145    0.95137010  0.3217769794   -0.272064769
98      77    104   -0.137216541    0.52381563  0.1932995449    0.347321594
99      77    105    0.686294507    0.51502380  0.6006591529    0.791964672
100     77    106   -0.010315800    0.46781048  0.2287473418    0.094520909
101     77    107   -0.253436923    0.57767547  0.1621192717   -0.181227126
102     77    108   -0.024918726    0.94329346  0.4591873656   -0.036988636
103     77    109   -0.079468503    0.51029348  0.2154124898    0.150129648
104     77    110   -0.139552445    0.57276570  0.2166066289   -0.230383376
105     77    111    0.317923636    0.96336503  0.6406443327    0.454831315
106     77    112    0.139714778    0.47976006  0.3097374183    0.008669518
107     77    113    0.747222212    0.48170716  0.6144646859    0.901629918
108     77    114   -0.232176866    0.46806547  0.1179443029    0.164795663
109     77    115    0.603387672    0.93263684  0.7680122547    0.448832367
110     77    116    0.005839656    0.51694511  0.2613923820   -0.238535267
111     77    118   -0.061635585    0.55632635  0.2473453821    0.246672625
112     77    119    0.775571366    0.44683585  0.6112036061    0.919063856
113     77    120   -0.100525036    0.92987697  0.4146759661   -0.071468116
114     77    121    0.555559359    0.94482515  0.7501922540    0.472694144
115     77    122    0.059351326    0.52557848  0.2924649011    0.466168889
116     77    123    0.017816716    0.29535556  0.1565861400    0.323521351
117     77    124   -0.189005300    0.94157547  0.3762850847   -0.365573659
118     77    125   -0.106317744    0.30425100  0.0989666298   -0.187649736
119     77    126   -0.265621070    0.89367342  0.3140261754   -0.411649553
120     77    127   -0.101723564    0.83550532  0.3668908787   -0.194518631
121     77    128    0.213775803    0.42914545  0.3214606289    0.453462824
122     77    129   -0.479759185    0.57090069  0.0455707503   -0.275410142
123     77    130    0.136907385    0.28159379  0.2092505858    0.053329195
124     77    131    0.313865324    0.97607236  0.6449688438    0.116404764
125     77    132   -0.071020189    0.84335952  0.3861696670    0.239832372
126     77    133   -0.133344597    0.43712400  0.1518897008   -0.321730640
127     77    134   -0.299431461    0.85120945  0.2758889957    0.010555231
128     77    135   -0.002449935    0.83592991  0.4167399858    0.203617383
129     77    136    0.136206460    0.92767497  0.5319407151    0.192953924
130     77    137   -0.408305398    0.45910884  0.0254017207    0.097133929
131     77    138   -0.694148961    0.50849698 -0.0928259921   -0.548343875
132     77    139    0.310876045    0.83439261  0.5726343262    0.382619679
133     77    140   -0.017496933    0.83013344  0.4063182524    0.041033750
134     77    141   -0.144592869    0.96095205  0.4081795907   -0.272990471
135     77    142   -0.236274699    0.82353602  0.2936306617   -0.015018008
136     77    143   -0.164411613    0.89723960  0.3664139932   -0.139160875
137     77    144    0.231551864    0.62883589  0.4301938763    0.129754612
138     77    145    0.178278219    0.94057302  0.5594256208    0.537224348
139     77    146   -0.215861234    0.83171872  0.3079287442    0.135339387
140     77    147   -0.664014177    0.56619609 -0.0489090421   -0.714895663
141     77    148    0.465301246    0.63145505  0.5483781467    0.073717466
142     77    149   -0.059100777    0.86943869  0.4051689563    0.252198648
143     77    150    0.408594690    0.84157356  0.6250841265    0.202373970
144     77    151    0.428611996    0.92507824  0.6768451183    0.162221093
145     77    152    0.085546807    0.40983549  0.2476911503    0.212922101
146     77    153    0.257418282    0.34161777  0.2995180242    0.288121874
147     77    154    0.029130313    0.37163824  0.2003842786   -0.045314381
148     77    155   -0.308270391    0.48885205  0.0902908320   -0.251367113
149     77    156    0.010967504    0.41813679  0.2145521490    0.063680579
150     77    157    0.776545146    0.47628154  0.6264133422    0.832839160
151     77    158   -0.654161229    0.83621957  0.0910291727   -0.274946226
152     77    159   -0.037191686    0.83245706  0.3976326893    0.057285850
153     77    160   -0.149815354    0.49515793  0.1726712867   -0.322266898
154     77    161    0.438754678    0.83827716  0.6385159166    0.357750017
155     77    162    0.857583939    0.54548390  0.7015339196    0.811531999
156     77    163   -0.069703560    0.96391382  0.4471051294   -0.527615246
157     77    164    0.160535801    0.51070999  0.3356228977    0.246457579
158     77    165    0.037613163    0.16189998  0.0997565730   -0.364745854
159     77    166   -0.110938680    0.40150840  0.1452848582   -0.071234108
160     77    167    0.654667967    0.95465879  0.8046633798    0.668651817
161     77    168    0.456542499    0.44064743  0.4485949668    0.174852194
162     77    169   -0.649458736    0.94721508  0.1488781700   -0.784241237
163     77    170    0.039518046    0.87131883  0.4554184388    0.076161294
164     77    171   -0.201972576    0.88852514  0.3432762805   -0.083316421
165     77    172   -0.624276766    0.52716468 -0.0485560451   -0.448164974
166     77    173    0.115279745    0.82020248  0.4677411140    0.317372411
167     77    174    0.036170465    0.90953607  0.4728532662    0.198657414
168     77    175    0.224373367    0.43604817  0.3302107706    0.048107464
169     77    176    0.369105177    0.96344076  0.6662729662    0.216761190
170     77    178    0.557391049    0.47606829  0.5167296716    0.787521488
171     77    179   -0.519941762    0.46485598 -0.0275428901   -0.451557062
172     77    180   -0.383982753    0.51015373  0.0630854903   -0.213083449
173     77    181    0.226152918    0.26248105  0.2443169829    0.479043286
174     77    182   -0.205342831    0.88333375  0.3389954620   -0.015627968
175     77    183   -0.042596657    0.55848432  0.2579438326   -0.307121902
176     77    184   -0.176693368    0.48881441  0.1560605188   -0.094634566
177     77    185   -0.120745883    0.96829741  0.4237757649   -0.022044101
178     77    186   -0.917130597    0.93603941  0.0094544088   -0.766873081
179     77    187    0.329609148    0.96942502  0.6495170847    0.336866203
180     77    188    0.542510773    0.97857803  0.7605444033    0.360546304
181     77    189    0.107316190    0.90348451  0.5054003489   -0.090919528
182     77    190   -0.154926236    0.56443032  0.2047520399    0.232331326
183     77    191    0.167095678    0.54827778  0.3576867265    0.264309721
184     77    192    0.635491407    0.83950199  0.7374966995    0.248336772
185     77    194   -0.114008855    0.33463157  0.1103113553   -0.029936216
186     77    195    0.488218397    0.96312823  0.7256733117    0.586982522
187     77    196    0.298771575    0.52987169  0.4143216323    0.006385899
188     77    197    0.266614090    0.93474476  0.6006794273    0.007467504
189     77    198   -0.396737802    0.82953187  0.2163970329   -0.119889304
190     77    199    0.440352301    0.22625833  0.3333053146    0.273697926
191     77    200   -0.029187880    0.78935799  0.3800850555    0.240552835
192     77    201   -0.373382343    0.28017568 -0.0466033300    0.063406738
193     77    202    0.503645827    0.80025239  0.6519491066    0.332585639
194     77    203    0.422221556    0.21553698  0.3188792683    0.410498997
195     77    204   -0.055358491    0.84424966  0.3944455863    0.283896134
196     77    205    0.273728007    0.97567969  0.6247038504    0.306307458
197     77    207   -0.019548597    0.51645999  0.2484556973   -0.164286487
198     77    208   -0.479055501    0.62065962  0.0708020570   -0.680224654
199     77    209   -0.148265146    0.56008795  0.2059114028   -0.285627748
200     77    210   -0.135293606    0.29925490  0.0819806468   -0.222613744
201     77    212    0.017174891    0.65032364  0.3337492672    0.069122642
202     77    213    0.253010597    0.40786575  0.3304381746    0.038955321
203     77    214    0.057036200    0.96731369  0.5121749435   -0.206971003
204     77    215   -0.060415209    0.89298504  0.4162849160   -0.472122221
205     77    216    0.134718583    0.35367993  0.2441992577   -0.031730484
206     77    217    0.261240270    0.26424058  0.2627404268    0.033442044
207     77    219    0.026938156    0.55509758  0.2910178669    0.091463974
208     77    220   -0.118851894    0.97259590  0.4268720037   -0.436540077
209     77    221    0.481879754    0.49549345  0.4886866007    0.284321616
210     77    222    0.095225000    0.54170521  0.3184651044    0.289713031
211     77    223   -0.335925768    0.45459375  0.0593339902   -0.068504896
212     77    224   -0.270702125    0.83408470  0.2816912865   -0.235469922
213     77    225    0.064336107    0.53514801  0.2997420579    0.234414387
214     77    226    0.161392594    0.06137464  0.1113836157    0.187305318
215     77    227   -0.504082231    0.50571023  0.0008139983   -0.750629092
216     77    228    0.225776896    0.91685589  0.5713163930    0.130615731
217     77    229    0.308421201    0.55629116  0.4323561814    0.619161594
218     77    230   -0.029715599    0.42857332  0.1994288621    0.517208265
219     77    231   -0.032915550    0.35310544  0.1600949433   -0.200905670
220     77    232    0.370690787    0.49296019  0.4318254871   -0.024371626
221     77    233    0.973642941    0.98589670  0.9797698229    0.965682150
222     77    234    0.654696189    0.88467209  0.7696841381    0.453353867
223     77    235    0.102849791    0.81952324  0.4611865151   -0.115481894
224     77    236    0.541828412    0.51702213  0.5294252685    0.392445594
225     77    237    0.660345509    0.14128953  0.4008175184    0.855156317
226     77    238   -0.092060049    0.27162901  0.0897844790    0.226913353
227     77    239   -0.218496064    0.92381207  0.3526580032   -0.392932912
228     77    240   -0.338603966    0.88160623  0.2715011334   -0.239265557
229     77    241   -0.306651437    0.57201820  0.1326833791   -0.106793283
230     77    242   -0.804103979    0.80221974 -0.0009421184   -0.741021229
231     77    243   -0.365119093    0.89387567  0.2643782875   -0.316133412
232     77    244   -0.729337335    0.83385032  0.0522564920   -0.214893601
233     77    245    0.247950955    0.91079165  0.5793713007    0.122259022
234     77    246   -0.178433750    0.79202792  0.3067970831   -0.235890037
235     77    247   -0.710906231    0.53193051 -0.0894878589   -0.543684054
236     77    248    0.360322435    0.89267614  0.6264992897    0.671095201
237     77    249   -0.350070038    0.95706498  0.3034974687    0.024819824
238     77    250    0.636892538    0.34159701  0.4892447755    0.703364132
239     77    251    0.175344004    0.87095888  0.5231514410    0.035967209
240     77    253    0.135624790    0.87513493  0.5053798588    0.149777703
241     77    254    0.584872920    0.92096584  0.7529193791    0.901610499
242     77    255   -0.146885686    0.97416474  0.4136395295   -0.607162127
243     77    256    0.086989588    0.94752652  0.5172580538   -0.060034477
244     77    257    0.598984220    0.48826268  0.5436234479    0.402533668
245     77    258   -0.503033701    0.83121714  0.1640917216   -0.550485658
246     77    259   -0.088608968    0.44726370  0.1793273673    0.136923234
247     77    260   -0.067615600    0.85850777  0.3954460828   -0.035351552
248     77    261   -0.272061258    0.27150791 -0.0002766743    0.238681419
249     77    262    0.236336041    0.60612781  0.4212319279   -0.244842304
250     77    263    0.318835822    0.83327440  0.5760551130    0.275179063
251     77    264    0.368357525    0.96794041  0.6681489650    0.181012090
252     77    265    0.462883434    0.95761218  0.7102478051    0.498311623
253     77    266   -0.251162707    0.92516110  0.3369991962   -0.557794289
254     77    267   -0.443938535    0.83078230  0.1934218846   -0.589794444
255     77    268    0.395460337    0.96248883  0.6789745820    0.369735946
256     77    269   -0.466370424    0.45464109 -0.0058646649   -0.247580595
257     77    270    0.274854303    0.45792331  0.3663888080   -0.009181744
258     77    271    0.195189898    0.57202067  0.3836052843    0.023634941
259     77    272   -0.179646952    0.89174764  0.3560503429    0.068677178
    mag_measure.y   scoreNCust finalControlScore
1      0.93911494  0.638490270       0.556033689
2      0.90873223  0.156120251       0.249281875
3      0.34315941  0.549204065       0.525962717
4      0.20226032 -0.051575666      -0.067537037
5      0.51357976  0.369174101       0.290939252
6      0.92490800  0.479856118       0.481896555
7      0.35469291  0.139912158       0.155660217
8      0.92571666  0.218925421       0.212634979
9      0.88013623  0.037816200       0.045000393
10     0.41705367  0.319534798       0.405493378
11     0.93311137  0.505449213       0.438431056
12     0.43323776  0.336914362       0.241101710
13     0.63361102  0.701842878       0.621129179
14     0.51795534  0.317004211       0.263135698
15     0.91978074  0.191643089       0.271160053
16     0.95667919  0.766944992       0.781991643
17     0.92903269  0.414096235       0.401869495
18     0.55171946 -0.062511759      -0.046953240
19     0.94449469  0.624286084       0.658052251
20     0.91870276  0.561863789       0.576590869
21     0.93107667  0.240462368       0.196874601
22     0.48572498  0.253749940       0.337560273
23     0.54498902  0.049765619       0.004279285
24     0.90206202  0.228359279       0.256758926
25     0.25028333  0.324721606       0.284630061
26     0.95047998  0.857995196       0.792511906
27     0.48837788  0.372786087       0.372572404
28     0.92088680  0.290003708       0.291513382
29     0.45044737  0.417979427       0.522283489
30     0.47575282  0.382933600       0.251447188
31     0.37719308  0.345333597       0.382764002
32     0.93362112  0.499520178       0.461702170
33     0.89956065  0.896151017       0.847765730
34     0.39094729  0.400025044       0.310697728
35     0.91976312  0.726305655       0.701179893
36     0.91784769  0.238000807       0.342602813
37     0.45288525  0.412664678       0.408958448
38     0.19373423  0.276113582       0.196769291
39     0.95880630  0.809769690       0.808889953
40     0.62952403  0.369025415       0.413512799
41     0.31833246  0.198495965       0.263642557
42     0.51894291  0.287522382       0.327330574
43     0.95756389  0.733886668       0.687862456
44     0.86809620  0.495532480       0.459099863
45     0.47527337  0.188055469       0.337244496
46     0.38400864 -0.003208813       0.023129150
47     0.93198950  0.820693614       0.878368012
48     0.92247937  0.496596189       0.483976844
49     0.62845963  0.211912903       0.262134131
50     0.94852066  0.798797889       0.801559870
51     0.89465085  0.031585480       0.108662959
52     0.39978745 -0.006832634      -0.039330911
53     0.59482268  0.382549240       0.315016301
54     0.42752371  0.628321737       0.511299129
55     0.17338115  0.101791610       0.101529754
56     0.33007106  0.241648379       0.222675962
57     0.38487552  0.422276877       0.471304706
58     0.64837714  0.135244565       0.173372889
59     0.43208474  0.410318608       0.436686625
60     0.33723003  0.320013627       0.402062147
61     0.94199969  0.696655416       0.633030368
62     0.34181978  0.021169491       0.059631422
63     0.92667532  0.402257371       0.359372481
64     0.43445821 -0.014525268       0.054233336
65     0.91537085  0.395489279       0.427539823
66     0.34317367  0.426127932       0.458122259
67     0.47865381  0.277609458       0.233813217
68     0.37807520  0.510186931       0.571545575
69     0.27598883  0.428310552       0.348251028
70     0.94712471  0.427629454       0.460574898
71     0.91390062  0.296017189       0.331988373
72     0.34198878 -0.111513798      -0.175630892
73     1.00000000  1.000000000       1.000000000
74     0.53662999  0.158264801       0.140319426
75     0.36524193  0.250152776       0.216649680
76     0.39533698  0.055278293       0.027143270
77     0.27542224  0.345814426       0.339027973
78     0.93198999  0.222543678       0.274520901
79     0.46867513  0.319535842       0.281835599
80     0.92304253  0.887281779       0.817511344
81     0.42013961  0.161107617       0.129496604
82     0.92117398  0.318378838       0.361908509
83     0.14692424  0.505329875       0.213165294
84     0.91520186  0.224646014       0.167350240
85     0.89095818  0.243343209       0.249857985
86     0.51401363  0.266167630       0.264930362
87     0.29177950  0.271562395       0.298685249
88     0.34581101  0.310774674       0.224797574
89     0.30877438  0.188589149       0.164857822
90     0.93742132  0.615925724       0.651030230
91     0.41852259  0.203193469       0.150967314
92     0.88877454  0.408685997       0.470243843
93     0.61376293  0.234555424       0.283650516
94     0.36376933  0.179082498       0.128846772
95     0.45113545  0.231751545       0.187531962
96     0.43001313 -0.103548062      -0.016765570
97     0.90964127  0.318788250       0.320282615
98     0.46629197  0.406806781       0.300053163
99     0.42771685  0.609840759       0.605249956
100    0.36108512  0.227803013       0.228275177
101    0.51357362  0.166173247       0.164146259
102    0.90480784  0.433909604       0.446548485
103    0.43728893  0.293709288       0.254560889
104    0.49292837  0.131272496       0.173939563
105    0.95160690  0.703219107       0.671931720
106    0.39567698  0.202173249       0.255955334
107    0.42823306  0.664931491       0.639698088
108    0.37537491  0.270085286       0.194014795
109    0.95421699  0.701524681       0.734768468
110    0.42826830  0.094866516       0.178129449
111    0.47073104  0.358701831       0.303023606
112    0.44062743  0.679845642       0.645524624
113    0.87452142  0.401526653       0.408101309
114    0.92763497  0.700164556       0.725178405
115    0.44319262  0.454680753       0.373572827
116    0.28246980  0.302995578       0.229790859
117    0.91104168  0.272734008       0.324509547
118    0.27775047  0.045050369       0.072008499
119    0.91559734  0.251973895       0.283000035
120    0.62890710  0.217194236       0.292042557
121    0.33438522  0.393924022       0.357692325
122    0.53991571  0.132252786       0.088911768
123    0.23513019  0.144229691       0.176740138
124    0.92313380  0.519769283       0.582369064
125    0.63757494  0.438703659       0.412436663
126    0.31432111 -0.003704765       0.074092468
127    0.92184085  0.466198043       0.371043519
128    0.63173029  0.417673838       0.417206912
129    0.89990309  0.546428505       0.539184610
130    0.37237286  0.234753394       0.130077557
131    0.41654890 -0.065897486      -0.079361739
132    0.63165902  0.507139349       0.539886837
133    0.62694359  0.333988671       0.370153461
134    0.90744351  0.317226519       0.362703055
135    0.89688305  0.440932522       0.367281592
136    0.93720528  0.399022200       0.382718097
137    0.57056428  0.350159445       0.390176661
138    0.95370524  0.745464795       0.652445208
139    0.61694272  0.376141056       0.342034900
140    0.50951393 -0.102690865      -0.075799953
141    0.45115415  0.262435807       0.405406977
142    0.95135104  0.601774843       0.503471900
143    0.93907928  0.570726625       0.597905376
144    0.89318246  0.527701778       0.602273448
145    0.31664877  0.264785434       0.256238292
146    0.33533895  0.311730413       0.305624218
147    0.33717309  0.145929354       0.173156816
148    0.42378208  0.086207485       0.088249158
149    0.30019663  0.181938602       0.198245376
150    0.37103795  0.601938554       0.614175948
151    0.63504906  0.180051416       0.135540294
152    0.62572456  0.341505203       0.369568946
153    0.40365525  0.040694176       0.106682731
154    0.63632393  0.497036973       0.567776445
155    0.44662159  0.629076797       0.665305358
156    0.90745799  0.189921370       0.318513250
157    0.43452435  0.340490963       0.338056930
158    0.18090694 -0.091919455       0.003918559
159    0.29971730  0.114241598       0.129763228
160    0.95234083  0.810496324       0.807579852
161    0.36347405  0.269163124       0.358879045
162    0.90753966  0.061649212       0.105263691
163    0.93344067  0.504800982       0.480109711
164    0.92709674  0.421890160       0.382583220
165    0.48770676  0.019770893      -0.014392576
166    0.90042904  0.608900728       0.538320921
167    0.92617643  0.562416921       0.517635094
168    0.41436617  0.231236818       0.280723794
169    0.93494883  0.575855010       0.621063988
170    0.38683880  0.587180144       0.551954908
171    0.42163348 -0.014961789      -0.021252339
172    0.43038846  0.108652507       0.085868999
173    0.24639591  0.362719598       0.303518290
174    0.93965322  0.462012627       0.400504045
175    0.48498406  0.088931079       0.173437456
176    0.44152619  0.173445812       0.164753166
177    0.93671014  0.457333019       0.440554392
178    0.88469865  0.058912786       0.034183598
179    0.91114758  0.624006892       0.636761988
180    0.94073477  0.650640535       0.705592469
181    0.86984566  0.389463067       0.447431708
182    0.48619593  0.359263629       0.282007834
183    0.48774461  0.376027168       0.366856947
184    0.64489242  0.446614595       0.592055647
185    0.30833464  0.139199211       0.124755283
186    0.93693193  0.761957227       0.743815270
187    0.45478523  0.230585562       0.322453597
188    0.93275998  0.470113741       0.535396584
189    0.61040567  0.245258181       0.230827607
190    0.22781603  0.250756979       0.292031147
191    0.85154456  0.546048699       0.463066877
192    0.24505927  0.154233002       0.053814836
193    0.89569012  0.614137878       0.633043492
194    0.22748763  0.318993315       0.318936292
195    0.62917105  0.456533591       0.425489589
196    0.94059287  0.623450166       0.624077008
197    0.43551475  0.135614130       0.192034914
198    0.56794409 -0.056140284       0.007330886
199    0.50557246  0.109972356       0.157941880
200    0.30431151  0.040848885       0.061414766
201    0.61639534  0.342758990       0.338254129
202    0.30634915  0.172652235       0.251545205
203    0.91750066  0.355264828       0.433719886
204    0.91109967  0.219488726       0.317886821
205    0.29177487  0.130022194       0.187110726
206    0.31350733  0.173474687       0.218107557
207    0.49224207  0.291853020       0.291435444
208    0.91365316  0.238556541       0.332714273
209    0.39786211  0.341091862       0.414889231
210    0.50505618  0.397384607       0.357924856
211    0.33015159  0.130823345       0.095078668
212    0.62227731  0.193403696       0.237547491
213    0.44758336  0.340998874       0.320370466
214    0.05006858  0.118686951       0.115035283
215    0.43176542 -0.159431834      -0.079308918
216    0.92537423  0.527994978       0.549655686
217    0.47296418  0.546062887       0.489209534
218    0.34087359  0.429040925       0.314234894
219    0.33917108  0.069132703       0.114613823
220    0.41219117  0.193909773       0.312867630
221    0.99096346  0.978322802       0.979046313
222    0.93909935  0.696226608       0.732955373
223    0.90638773  0.395452917       0.428319716
224    0.46814128  0.430293438       0.479859353
225    0.13965450  0.497405408       0.449111463
226    0.25814829  0.242530822       0.166157650
227    0.91332086  0.260193974       0.306425989
228    0.91976336  0.340248903       0.305875018
229    0.52836370  0.210785210       0.171734294
230    0.89309295  0.076035863       0.037546872
231    0.89705964  0.290463113       0.277420700
232    0.61843459  0.201770495       0.127013493
233    0.91124043  0.516749725       0.548060513
234    0.86806227  0.316086117       0.311441600
235    0.45310458 -0.045289737      -0.067388798
236    0.89416865  0.782631924       0.704565607
237    0.93326354  0.479041684       0.391269576
238    0.32737280  0.515368467       0.502306621
239    0.90046443  0.468215818       0.495683630
240    0.94219116  0.545984430       0.525682145
241    0.92950399  0.915557243       0.834238311
242    0.92477184  0.158804856       0.286222193
243    0.93000080  0.434983163       0.476120608
244    0.38118581  0.391859738       0.467741593
245    0.60729978  0.028407059       0.096249390
246    0.35885303  0.247888130       0.213607749
247    0.91524059  0.439944521       0.417695302
248    0.24847609  0.243578756       0.121651041
249    0.56075018  0.157953938       0.289592933
250    0.62855517  0.451867118       0.513961116
251    0.94880903  0.564910562       0.616529764
252    0.94314763  0.720729629       0.715488717
253    0.90979625  0.176000982       0.256500089
254    0.62801314  0.019109347       0.106265616
255    0.94351544  0.656625693       0.667800137
256    0.36242075  0.057420077       0.025777706
257    0.39100548  0.190911866       0.278650337
258    0.52451988  0.274077413       0.328841349
259    0.94815007  0.508413624       0.432231984</code></pre>
</div>
<div class="sourceCode cell-code" id="cb115"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the store with the second highest finalControlScore for the trial store</span></span>
<span id="cb115-2"><a href="#cb115-2" aria-hidden="true" tabindex="-1"></a>control_store <span class="ot">&lt;-</span> score_Control <span class="sc">%&gt;%</span></span>
<span id="cb115-3"><a href="#cb115-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Store1 <span class="sc">==</span> trial_store) <span class="sc">%&gt;%</span></span>
<span id="cb115-4"><a href="#cb115-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(finalControlScore)) <span class="sc">%&gt;%</span></span>
<span id="cb115-5"><a href="#cb115-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="dv">2</span>) <span class="sc">%&gt;%</span></span>
<span id="cb115-6"><a href="#cb115-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(Store2)</span>
<span id="cb115-7"><a href="#cb115-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-8"><a href="#cb115-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Display the result</span></span>
<span id="cb115-9"><a href="#cb115-9" aria-hidden="true" tabindex="-1"></a>control_store</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 233</code></pre>
</div>
</div>
<p>finding the control store - checking if the drivers are actually similar in the period</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb117"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a><span class="co">#checking for sales</span></span>
<span id="cb117-2"><a href="#cb117-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-3"><a href="#cb117-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a new column for Store type (Trial, Control, Other)</span></span>
<span id="cb117-4"><a href="#cb117-4" aria-hidden="true" tabindex="-1"></a>pastSales <span class="ot">&lt;-</span> measureOverTime <span class="sc">%&gt;%</span></span>
<span id="cb117-5"><a href="#cb117-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Store_type =</span> <span class="fu">case_when</span>(</span>
<span id="cb117-6"><a href="#cb117-6" aria-hidden="true" tabindex="-1"></a>    store_nbr <span class="sc">==</span> trial_store <span class="sc">~</span> <span class="st">"Trial"</span>,</span>
<span id="cb117-7"><a href="#cb117-7" aria-hidden="true" tabindex="-1"></a>    store_nbr <span class="sc">==</span> control_store <span class="sc">~</span> <span class="st">"Control"</span>,</span>
<span id="cb117-8"><a href="#cb117-8" aria-hidden="true" tabindex="-1"></a>    <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"Other stores"</span></span>
<span id="cb117-9"><a href="#cb117-9" aria-hidden="true" tabindex="-1"></a>  )) <span class="sc">%&gt;%</span></span>
<span id="cb117-10"><a href="#cb117-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(YEARMONTH, Store_type) <span class="sc">%&gt;%</span></span>
<span id="cb117-11"><a href="#cb117-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">totSales =</span> <span class="fu">mean</span>(totSales, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb117-12"><a href="#cb117-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb117-13"><a href="#cb117-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">TransactionMonth =</span> <span class="fu">as.Date</span>(<span class="fu">paste0</span>(YEARMONTH <span class="sc">%/%</span> <span class="dv">100</span>, <span class="st">"-"</span>, YEARMONTH <span class="sc">%%</span> <span class="dv">100</span>, <span class="st">"-01"</span>), <span class="st">"%Y-%m-%d"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb117-14"><a href="#cb117-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(YEARMONTH <span class="sc">&lt;</span> <span class="dv">201903</span>)  <span class="co"># Filter to pre-trial period</span></span>
<span id="cb117-15"><a href="#cb117-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-16"><a href="#cb117-16" aria-hidden="true" tabindex="-1"></a>pastSales</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2,110 × 9
   store_nbr YEARMONTH totSales nCustomers nTxnPerCust nChipsPerTxn
       &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;      &lt;int&gt;       &lt;dbl&gt;        &lt;dbl&gt;
 1         1    201807     588.         47        1.04         1.18
 2         1    201808     563.         41        1            1.27
 3         1    201809     571.         57        1.04         1.20
 4         1    201810     582.         39        1.03         1.27
 5         1    201811     569.         44        1.02         1.22
 6         1    201812     597.         37        1.08         1.2 
 7         1    201901     580.         35        1            1.17
 8         1    201902     535.         49        1.04         1.14
 9         2    201807     588.         36        1.06         1.13
10         2    201808     563.         35        1.11         1.28
# ℹ 2,100 more rows
# ℹ 3 more variables: avgPricePerUnit &lt;dbl&gt;, Store_type &lt;chr&gt;,
#   TransactionMonth &lt;date&gt;</code></pre>
</div>
<div class="sourceCode cell-code" id="cb119"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plotting total sales by month for Trial, Control, and Other stores</span></span>
<span id="cb119-2"><a href="#cb119-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(pastSales, <span class="fu">aes</span>(TransactionMonth, totSales, <span class="at">color =</span> Store_type)) <span class="sc">+</span></span>
<span id="cb119-3"><a href="#cb119-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb119-4"><a href="#cb119-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb119-5"><a href="#cb119-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Month of operation"</span>, </span>
<span id="cb119-6"><a href="#cb119-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Total Sales"</span>, </span>
<span id="cb119-7"><a href="#cb119-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Total Sales by Month (Trial Store vs Control vs Other Stores)"</span></span>
<span id="cb119-8"><a href="#cb119-8" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb119-9"><a href="#cb119-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span> </span>
<span id="cb119-10"><a href="#cb119-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_date</span>(<span class="at">date_labels =</span> <span class="st">"%b %Y"</span>, <span class="at">date_breaks =</span> <span class="st">"1 month"</span>) <span class="sc">+</span>  <span class="co"># Adjust x-axis for better readability</span></span>
<span id="cb119-11"><a href="#cb119-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>))  <span class="co"># Rotate x-axis labels</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="QVI_files/figure-html/unnamed-chunk-44-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb120"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a><span class="co">#checking for customers</span></span>
<span id="cb120-2"><a href="#cb120-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-3"><a href="#cb120-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a new column for Store type (Trial, Control, Other)</span></span>
<span id="cb120-4"><a href="#cb120-4" aria-hidden="true" tabindex="-1"></a>pastnCustomers <span class="ot">&lt;-</span> measureOverTime <span class="sc">%&gt;%</span></span>
<span id="cb120-5"><a href="#cb120-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Store_type =</span> <span class="fu">case_when</span>(</span>
<span id="cb120-6"><a href="#cb120-6" aria-hidden="true" tabindex="-1"></a>    store_nbr <span class="sc">==</span> trial_store <span class="sc">~</span> <span class="st">"Trial"</span>,</span>
<span id="cb120-7"><a href="#cb120-7" aria-hidden="true" tabindex="-1"></a>    store_nbr <span class="sc">==</span> control_store <span class="sc">~</span> <span class="st">"Control"</span>,</span>
<span id="cb120-8"><a href="#cb120-8" aria-hidden="true" tabindex="-1"></a>    <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"Other stores"</span></span>
<span id="cb120-9"><a href="#cb120-9" aria-hidden="true" tabindex="-1"></a>  )) <span class="sc">%&gt;%</span></span>
<span id="cb120-10"><a href="#cb120-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(YEARMONTH, Store_type) <span class="sc">%&gt;%</span></span>
<span id="cb120-11"><a href="#cb120-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">nCustomers =</span> <span class="fu">mean</span>(nCustomers, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb120-12"><a href="#cb120-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb120-13"><a href="#cb120-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">TransactionMonth =</span> <span class="fu">as.Date</span>(<span class="fu">paste0</span>(YEARMONTH <span class="sc">%/%</span> <span class="dv">100</span>, <span class="st">"-"</span>, YEARMONTH <span class="sc">%%</span> <span class="dv">100</span>, <span class="st">"-01"</span>), <span class="st">"%Y-%m-%d"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb120-14"><a href="#cb120-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(YEARMONTH <span class="sc">&lt;</span> <span class="dv">201903</span>)  <span class="co"># Filter to pre-trial period</span></span>
<span id="cb120-15"><a href="#cb120-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-16"><a href="#cb120-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Plotting total customers by month for Trial, Control, and Other stores</span></span>
<span id="cb120-17"><a href="#cb120-17" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(pastnCustomers, <span class="fu">aes</span>(TransactionMonth, nCustomers, <span class="at">color =</span> Store_type)) <span class="sc">+</span></span>
<span id="cb120-18"><a href="#cb120-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb120-19"><a href="#cb120-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb120-20"><a href="#cb120-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Month of operation"</span>, </span>
<span id="cb120-21"><a href="#cb120-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Total Customers"</span>, </span>
<span id="cb120-22"><a href="#cb120-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Total Customers by Month (Trial Store vs Control vs Other Stores)"</span></span>
<span id="cb120-23"><a href="#cb120-23" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb120-24"><a href="#cb120-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span> </span>
<span id="cb120-25"><a href="#cb120-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_date</span>(<span class="at">date_labels =</span> <span class="st">"%b %Y"</span>, <span class="at">date_breaks =</span> <span class="st">"1 month"</span>) <span class="sc">+</span>  <span class="co"># Adjust x-axis for better readability</span></span>
<span id="cb120-26"><a href="#cb120-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>))  <span class="co"># Rotate x-axis labels</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="QVI_files/figure-html/unnamed-chunk-45-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p><strong>Assessment of trial</strong><br>
The trial period goes from the start of March 2019 to June 2019. We now want to see if there has been an<br>
uplift in overall chip sales.</p>
<p>like we can see in the graphs the trial and control have some differences - hence we can scale up control stores to a level similar to control for any differences between the two stores outside of the trial period (pre-trial period)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb121"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the scaling factor for control store sales relative to trial store sales</span></span>
<span id="cb121-2"><a href="#cb121-2" aria-hidden="true" tabindex="-1"></a>scalingFactorForControlSales <span class="ot">&lt;-</span> preTrialMeasures <span class="sc">%&gt;%</span></span>
<span id="cb121-3"><a href="#cb121-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(store_nbr <span class="sc">==</span> trial_store <span class="sc">&amp;</span> YEARMONTH <span class="sc">&lt;</span> <span class="dv">201902</span>) <span class="sc">%&gt;%</span></span>
<span id="cb121-4"><a href="#cb121-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">total_trial_sales =</span> <span class="fu">sum</span>(totSales)) <span class="sc">%&gt;%</span></span>
<span id="cb121-5"><a href="#cb121-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(total_trial_sales) <span class="sc">/</span> preTrialMeasures <span class="sc">%&gt;%</span></span>
<span id="cb121-6"><a href="#cb121-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(store_nbr <span class="sc">==</span> control_store <span class="sc">&amp;</span> YEARMONTH <span class="sc">&lt;</span> <span class="dv">201902</span>) <span class="sc">%&gt;%</span></span>
<span id="cb121-7"><a href="#cb121-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">total_control_sales =</span> <span class="fu">sum</span>(totSales)) <span class="sc">%&gt;%</span></span>
<span id="cb121-8"><a href="#cb121-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(total_control_sales)</span>
<span id="cb121-9"><a href="#cb121-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-10"><a href="#cb121-10" aria-hidden="true" tabindex="-1"></a>scalingFactorForControlSales</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1.039752</code></pre>
</div>
<div class="sourceCode cell-code" id="cb123"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply the scaling factor to the control store sales</span></span>
<span id="cb123-2"><a href="#cb123-2" aria-hidden="true" tabindex="-1"></a>measureOverTimeSales <span class="ot">&lt;-</span> measureOverTime <span class="sc">%&gt;%</span></span>
<span id="cb123-3"><a href="#cb123-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">controlSales =</span> <span class="fu">ifelse</span>(store_nbr <span class="sc">==</span> control_store, totSales <span class="sc">*</span> scalingFactorForControlSales, totSales))</span>
<span id="cb123-4"><a href="#cb123-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-5"><a href="#cb123-5" aria-hidden="true" tabindex="-1"></a>measureOverTimeSales</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3,165 × 8
   store_nbr YEARMONTH totSales nCustomers nTxnPerCust nChipsPerTxn
       &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;      &lt;int&gt;       &lt;dbl&gt;        &lt;dbl&gt;
 1         1    201807     189.         47        1.04         1.18
 2         1    201808     168.         41        1            1.27
 3         1    201809     268.         57        1.04         1.20
 4         1    201810     175.         39        1.03         1.27
 5         1    201811     185.         44        1.02         1.22
 6         1    201812     161.         37        1.08         1.2 
 7         1    201901     150.         35        1            1.17
 8         1    201902     195.         49        1.04         1.14
 9         1    201903     185.         43        1.09         1.19
10         1    201904     177.         39        1.03         1.3 
# ℹ 3,155 more rows
# ℹ 2 more variables: avgPricePerUnit &lt;dbl&gt;, controlSales &lt;dbl&gt;</code></pre>
</div>
</div>
<p>cal per diff</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb125"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 3: Calculate the percentage difference between scaled control sales and trial store sales</span></span>
<span id="cb125-2"><a href="#cb125-2" aria-hidden="true" tabindex="-1"></a>percentageDiff <span class="ot">&lt;-</span> measureOverTimeSales <span class="sc">%&gt;%</span></span>
<span id="cb125-3"><a href="#cb125-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(store_nbr <span class="sc">==</span> trial_store) <span class="sc">%&gt;%</span></span>
<span id="cb125-4"><a href="#cb125-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(YEARMONTH, totSales) <span class="sc">%&gt;%</span></span>
<span id="cb125-5"><a href="#cb125-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(measureOverTimeSales <span class="sc">%&gt;%</span></span>
<span id="cb125-6"><a href="#cb125-6" aria-hidden="true" tabindex="-1"></a>              <span class="fu">filter</span>(store_nbr <span class="sc">==</span> control_store) <span class="sc">%&gt;%</span></span>
<span id="cb125-7"><a href="#cb125-7" aria-hidden="true" tabindex="-1"></a>              <span class="fu">select</span>(YEARMONTH, controlSales), <span class="at">by =</span> <span class="st">"YEARMONTH"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb125-8"><a href="#cb125-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">percentageDiff =</span> <span class="fu">abs</span>(controlSales <span class="sc">-</span> totSales) <span class="sc">/</span> controlSales)</span>
<span id="cb125-9"><a href="#cb125-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-10"><a href="#cb125-10" aria-hidden="true" tabindex="-1"></a>percentageDiff</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 12 × 4
   YEARMONTH totSales controlSales percentageDiff
       &lt;dbl&gt;    &lt;dbl&gt;        &lt;dbl&gt;          &lt;dbl&gt;
 1    201807     268.         282.         0.0482
 2    201808     248.         271.         0.0869
 3    201809     217.         230.         0.0561
 4    201810     194.         166.         0.173 
 5    201811     225.         215.         0.0475
 6    201812     255.         276.         0.0752
 7    201901     188.         156.         0.204 
 8    201902     212.         229.         0.0779
 9    201903     255.         188.         0.359 
10    201904     258.         150.         0.721 
11    201905     272.         325.         0.161 
12    201906     247.         205.         0.204 </code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb127"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 1: Calculate the standard deviation of the percentageDiff during the pre-trial period</span></span>
<span id="cb127-2"><a href="#cb127-2" aria-hidden="true" tabindex="-1"></a>stdDev <span class="ot">&lt;-</span> percentageDiff <span class="sc">%&gt;%</span></span>
<span id="cb127-3"><a href="#cb127-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(YEARMONTH <span class="sc">&lt;</span> <span class="dv">201902</span>) <span class="sc">%&gt;%</span></span>
<span id="cb127-4"><a href="#cb127-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">std_dev =</span> <span class="fu">sd</span>(percentageDiff, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb127-5"><a href="#cb127-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(std_dev)</span>
<span id="cb127-6"><a href="#cb127-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-7"><a href="#cb127-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 2: Degrees of freedom (8 months in pre-trial period, hence 7 degrees of freedom)</span></span>
<span id="cb127-8"><a href="#cb127-8" aria-hidden="true" tabindex="-1"></a>degreesOfFreedom <span class="ot">&lt;-</span> <span class="dv">7</span></span>
<span id="cb127-9"><a href="#cb127-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-10"><a href="#cb127-10" aria-hidden="true" tabindex="-1"></a><span class="do">#### We will test with a null hypothesis of there being 0 difference between trial and control stores</span></span>
<span id="cb127-11"><a href="#cb127-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 3: Calculate the t-value for each percentage difference</span></span>
<span id="cb127-12"><a href="#cb127-12" aria-hidden="true" tabindex="-1"></a>percentageDiffWithTValue <span class="ot">&lt;-</span> percentageDiff <span class="sc">%&gt;%</span></span>
<span id="cb127-13"><a href="#cb127-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">tValue =</span> (percentageDiff <span class="sc">-</span> <span class="dv">0</span>) <span class="sc">/</span> stdDev) <span class="sc">%&gt;%</span></span>
<span id="cb127-14"><a href="#cb127-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">TransactionMonth =</span> <span class="fu">as.Date</span>(<span class="fu">paste0</span>(YEARMONTH <span class="sc">%/%</span> <span class="dv">100</span>, <span class="st">"-"</span>, YEARMONTH <span class="sc">%%</span> <span class="dv">100</span>, <span class="st">"-01"</span>), <span class="st">"%Y-%m-%d"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb127-15"><a href="#cb127-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(YEARMONTH <span class="sc">&gt;</span> <span class="dv">201901</span> <span class="sc">&amp;</span> YEARMONTH <span class="sc">&lt;</span> <span class="dv">201905</span>) <span class="sc">%&gt;%</span> <span class="co"># Filter for trial period (from Feb 2019 to Apr 2019)</span></span>
<span id="cb127-16"><a href="#cb127-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(TransactionMonth, tValue)</span>
<span id="cb127-17"><a href="#cb127-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-18"><a href="#cb127-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Output the result</span></span>
<span id="cb127-19"><a href="#cb127-19" aria-hidden="true" tabindex="-1"></a>percentageDiffWithTValue</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 2
  TransactionMonth tValue
  &lt;date&gt;            &lt;dbl&gt;
1 2019-02-01         1.22
2 2019-03-01         5.63
3 2019-04-01        11.3 </code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb129"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Degrees of freedom (already set to 7 in the previous step)</span></span>
<span id="cb129-2"><a href="#cb129-2" aria-hidden="true" tabindex="-1"></a>degreesOfFreedom <span class="ot">&lt;-</span> <span class="dv">7</span></span>
<span id="cb129-3"><a href="#cb129-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-4"><a href="#cb129-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the 95th percentile of the t-distribution with the appropriate degrees of freedom</span></span>
<span id="cb129-5"><a href="#cb129-5" aria-hidden="true" tabindex="-1"></a>tPercentile95 <span class="ot">&lt;-</span> <span class="fu">qt</span>(<span class="fl">0.95</span>, <span class="at">df =</span> degreesOfFreedom)</span>
<span id="cb129-6"><a href="#cb129-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-7"><a href="#cb129-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Print the result</span></span>
<span id="cb129-8"><a href="#cb129-8" aria-hidden="true" tabindex="-1"></a>tPercentile95</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1.894579</code></pre>
</div>
</div>
<section id="purpose-of-the-analysis" class="level3">
<h3 class="anchored" data-anchor-id="purpose-of-the-analysis"><strong>Purpose of the Analysis:</strong></h3>
<ol type="1">
<li><p><strong>Null Hypothesis</strong>: The percentage difference between trial and control stores during the trial period is <strong>0</strong>.</p></li>
<li><p><strong>Alternative Hypothesis</strong>: The percentage difference is <strong>not 0</strong> (indicating the trial had an effect).</p></li>
<li><p><strong>t-Values Interpretation</strong>:</p>
<ul>
<li><p>If the <strong>t-value</strong> exceeds the critical thresholds (e.g., ±1.96 for a 95% confidence level), it indicates a statistically significant difference.</p></li>
<li><p>This helps determine whether the trial had an impact on the total sales.</p></li>
</ul></li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb131"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb131-1"><a href="#cb131-1" aria-hidden="true" tabindex="-1"></a><span class="co">#graphing out the comparison values</span></span>
<span id="cb131-2"><a href="#cb131-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-3"><a href="#cb131-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 1: Classifying stores into "Trial", "Control", and "Other stores"</span></span>
<span id="cb131-4"><a href="#cb131-4" aria-hidden="true" tabindex="-1"></a>pastSales <span class="ot">&lt;-</span> measureOverTime <span class="sc">%&gt;%</span></span>
<span id="cb131-5"><a href="#cb131-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Store_type =</span> <span class="fu">case_when</span>(</span>
<span id="cb131-6"><a href="#cb131-6" aria-hidden="true" tabindex="-1"></a>    store_nbr <span class="sc">==</span> trial_store <span class="sc">~</span> <span class="st">"Trial"</span>,</span>
<span id="cb131-7"><a href="#cb131-7" aria-hidden="true" tabindex="-1"></a>    store_nbr <span class="sc">==</span> control_store <span class="sc">~</span> <span class="st">"Control"</span>,</span>
<span id="cb131-8"><a href="#cb131-8" aria-hidden="true" tabindex="-1"></a>    <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"Other stores"</span></span>
<span id="cb131-9"><a href="#cb131-9" aria-hidden="true" tabindex="-1"></a>  )) <span class="sc">%&gt;%</span></span>
<span id="cb131-10"><a href="#cb131-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(YEARMONTH, Store_type) <span class="sc">%&gt;%</span></span>
<span id="cb131-11"><a href="#cb131-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">totSales =</span> <span class="fu">mean</span>(totSales, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb131-12"><a href="#cb131-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">TransactionMonth =</span> <span class="fu">as.Date</span>(<span class="fu">paste</span>(YEARMONTH <span class="sc">%/%</span> <span class="dv">100</span>, YEARMONTH <span class="sc">%%</span> <span class="dv">100</span>, <span class="st">"01"</span>, <span class="at">sep =</span> <span class="st">"-"</span>), <span class="st">"%Y-%m-%d"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb131-13"><a href="#cb131-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Store_type <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Trial"</span>, <span class="st">"Control"</span>))</span>
<span id="cb131-14"><a href="#cb131-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-15"><a href="#cb131-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 2: Adjust the control store sales for the 95th and 5th percentiles based on the standard deviation</span></span>
<span id="cb131-16"><a href="#cb131-16" aria-hidden="true" tabindex="-1"></a>pastSales_Controls95 <span class="ot">&lt;-</span> pastSales <span class="sc">%&gt;%</span></span>
<span id="cb131-17"><a href="#cb131-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Store_type <span class="sc">==</span> <span class="st">"Control"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb131-18"><a href="#cb131-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">totSales =</span> totSales <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">+</span> stdDev <span class="sc">*</span> <span class="dv">2</span>), <span class="at">Store_type =</span> <span class="st">"Control 95th % confidence interval"</span>)</span>
<span id="cb131-19"><a href="#cb131-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-20"><a href="#cb131-20" aria-hidden="true" tabindex="-1"></a>pastSales_Controls5 <span class="ot">&lt;-</span> pastSales <span class="sc">%&gt;%</span></span>
<span id="cb131-21"><a href="#cb131-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Store_type <span class="sc">==</span> <span class="st">"Control"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb131-22"><a href="#cb131-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">totSales =</span> totSales <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> stdDev <span class="sc">*</span> <span class="dv">2</span>), <span class="at">Store_type =</span> <span class="st">"Control 5th % confidence interval"</span>)</span>
<span id="cb131-23"><a href="#cb131-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-24"><a href="#cb131-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 3: Combine all the data</span></span>
<span id="cb131-25"><a href="#cb131-25" aria-hidden="true" tabindex="-1"></a>trialAssessment <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(pastSales, pastSales_Controls95, pastSales_Controls5)</span>
<span id="cb131-26"><a href="#cb131-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-27"><a href="#cb131-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 4: Plotting the data</span></span>
<span id="cb131-28"><a href="#cb131-28" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(trialAssessment, <span class="fu">aes</span>(TransactionMonth, totSales, <span class="at">color =</span> Store_type)) <span class="sc">+</span></span>
<span id="cb131-29"><a href="#cb131-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_rect</span>(<span class="at">data =</span> trialAssessment <span class="sc">%&gt;%</span> <span class="fu">filter</span>(YEARMONTH <span class="sc">&lt;</span> <span class="dv">201905</span> <span class="sc">&amp;</span> YEARMONTH <span class="sc">&gt;</span> <span class="dv">201901</span>),</span>
<span id="cb131-30"><a href="#cb131-30" aria-hidden="true" tabindex="-1"></a>            <span class="fu">aes</span>(<span class="at">xmin =</span> <span class="fu">min</span>(TransactionMonth), <span class="at">xmax =</span> <span class="fu">max</span>(TransactionMonth), <span class="at">ymin =</span> <span class="dv">0</span>, <span class="at">ymax =</span> <span class="cn">Inf</span>, <span class="at">color =</span> <span class="cn">NULL</span>),</span>
<span id="cb131-31"><a href="#cb131-31" aria-hidden="true" tabindex="-1"></a>            <span class="at">show.legend =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb131-32"><a href="#cb131-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb131-33"><a href="#cb131-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Month of operation"</span>, <span class="at">y =</span> <span class="st">"Total sales"</span>, <span class="at">title =</span> <span class="st">"Total Sales by Month (Trial vs Control)"</span>) <span class="sc">+</span></span>
<span id="cb131-34"><a href="#cb131-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb131-35"><a href="#cb131-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_date</span>(<span class="at">date_labels =</span> <span class="st">"%b %Y"</span>, <span class="at">date_breaks =</span> <span class="st">"1 month"</span>) <span class="sc">+</span>  <span class="co"># Adjust x-axis for better readability</span></span>
<span id="cb131-36"><a href="#cb131-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>))  <span class="co"># Rotate x-axis labels</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="QVI_files/figure-html/unnamed-chunk-50-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The results show that the trial in store 77 is significantly different to its control store in the trial period as<br>
the trial store performance lies outside the 5% to 95% confidence interval of the control store in two of the<br>
three trial months.</p>
<p>Assessment for ncustomers</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb132"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb132-1"><a href="#cb132-1" aria-hidden="true" tabindex="-1"></a><span class="co">#checking for customers</span></span>
<span id="cb132-2"><a href="#cb132-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb132-3"><a href="#cb132-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the scaling factor for control store customers relative to trial store customers</span></span>
<span id="cb132-4"><a href="#cb132-4" aria-hidden="true" tabindex="-1"></a>scalingFactorForControlCustomers <span class="ot">&lt;-</span> preTrialMeasures <span class="sc">%&gt;%</span></span>
<span id="cb132-5"><a href="#cb132-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(store_nbr <span class="sc">==</span> trial_store <span class="sc">&amp;</span> YEARMONTH <span class="sc">&lt;</span> <span class="dv">201902</span>) <span class="sc">%&gt;%</span></span>
<span id="cb132-6"><a href="#cb132-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">total_trial_customers =</span> <span class="fu">sum</span>(nCustomers)) <span class="sc">%&gt;%</span></span>
<span id="cb132-7"><a href="#cb132-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(total_trial_customers) <span class="sc">/</span> preTrialMeasures <span class="sc">%&gt;%</span></span>
<span id="cb132-8"><a href="#cb132-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(store_nbr <span class="sc">==</span> control_store <span class="sc">&amp;</span> YEARMONTH <span class="sc">&lt;</span> <span class="dv">201902</span>) <span class="sc">%&gt;%</span></span>
<span id="cb132-9"><a href="#cb132-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">total_control_customers =</span> <span class="fu">sum</span>(nCustomers)) <span class="sc">%&gt;%</span></span>
<span id="cb132-10"><a href="#cb132-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(total_control_customers)</span>
<span id="cb132-11"><a href="#cb132-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb132-12"><a href="#cb132-12" aria-hidden="true" tabindex="-1"></a>scalingFactorForControlCustomers</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1.021739</code></pre>
</div>
<div class="sourceCode cell-code" id="cb134"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb134-1"><a href="#cb134-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply the scaling factor to the control store customers</span></span>
<span id="cb134-2"><a href="#cb134-2" aria-hidden="true" tabindex="-1"></a>measureOverTimeCustomers <span class="ot">&lt;-</span> measureOverTime <span class="sc">%&gt;%</span></span>
<span id="cb134-3"><a href="#cb134-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">controlCustomers =</span> <span class="fu">ifelse</span>(store_nbr <span class="sc">==</span> control_store, nCustomers <span class="sc">*</span> scalingFactorForControlCustomers, nCustomers))</span>
<span id="cb134-4"><a href="#cb134-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb134-5"><a href="#cb134-5" aria-hidden="true" tabindex="-1"></a>measureOverTimeCustomers</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3,165 × 8
   store_nbr YEARMONTH totSales nCustomers nTxnPerCust nChipsPerTxn
       &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;      &lt;int&gt;       &lt;dbl&gt;        &lt;dbl&gt;
 1         1    201807     189.         47        1.04         1.18
 2         1    201808     168.         41        1            1.27
 3         1    201809     268.         57        1.04         1.20
 4         1    201810     175.         39        1.03         1.27
 5         1    201811     185.         44        1.02         1.22
 6         1    201812     161.         37        1.08         1.2 
 7         1    201901     150.         35        1            1.17
 8         1    201902     195.         49        1.04         1.14
 9         1    201903     185.         43        1.09         1.19
10         1    201904     177.         39        1.03         1.3 
# ℹ 3,155 more rows
# ℹ 2 more variables: avgPricePerUnit &lt;dbl&gt;, controlCustomers &lt;dbl&gt;</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb136"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb136-1"><a href="#cb136-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Calculate the percentage difference between scaled control customers and trial store customers</span></span>
<span id="cb136-2"><a href="#cb136-2" aria-hidden="true" tabindex="-1"></a>percentageDiffCustomers <span class="ot">&lt;-</span> measureOverTimeCustomers <span class="sc">%&gt;%</span></span>
<span id="cb136-3"><a href="#cb136-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(store_nbr <span class="sc">==</span> trial_store) <span class="sc">%&gt;%</span></span>
<span id="cb136-4"><a href="#cb136-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(YEARMONTH, nCustomers) <span class="sc">%&gt;%</span></span>
<span id="cb136-5"><a href="#cb136-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(measureOverTimeCustomers <span class="sc">%&gt;%</span></span>
<span id="cb136-6"><a href="#cb136-6" aria-hidden="true" tabindex="-1"></a>              <span class="fu">filter</span>(store_nbr <span class="sc">==</span> control_store) <span class="sc">%&gt;%</span></span>
<span id="cb136-7"><a href="#cb136-7" aria-hidden="true" tabindex="-1"></a>              <span class="fu">select</span>(YEARMONTH, controlCustomers), <span class="at">by =</span> <span class="st">"YEARMONTH"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb136-8"><a href="#cb136-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">percentageDiffCustomers =</span> <span class="fu">abs</span>(controlCustomers <span class="sc">-</span> nCustomers) <span class="sc">/</span> controlCustomers)</span>
<span id="cb136-9"><a href="#cb136-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-10"><a href="#cb136-10" aria-hidden="true" tabindex="-1"></a>percentageDiffCustomers</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 12 × 4
   YEARMONTH nCustomers controlCustomers percentageDiffCustomers
       &lt;dbl&gt;      &lt;int&gt;            &lt;dbl&gt;                   &lt;dbl&gt;
 1    201807         47             48.0                  0.0213
 2    201808         46             45.0                  0.0232
 3    201809         40             40.9                  0.0213
 4    201810         36             32.7                  0.101 
 5    201811         39             39.8                  0.0213
 6    201812         43             43.9                  0.0213
 7    201901         31             31.7                  0.0213
 8    201902         40             42.9                  0.0679
 9    201903         46             35.8                  0.286 
10    201904         47             27.6                  0.704 
11    201905         53             55.2                  0.0394
12    201906         38             34.7                  0.0939</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb138"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb138-1"><a href="#cb138-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 1: Calculate the standard deviation of the percentageDiffCustomers during the pre-trial period</span></span>
<span id="cb138-2"><a href="#cb138-2" aria-hidden="true" tabindex="-1"></a>stdDevC <span class="ot">&lt;-</span> percentageDiffCustomers <span class="sc">%&gt;%</span></span>
<span id="cb138-3"><a href="#cb138-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(YEARMONTH <span class="sc">&lt;</span> <span class="dv">201902</span>) <span class="sc">%&gt;%</span></span>
<span id="cb138-4"><a href="#cb138-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">std_dev =</span> <span class="fu">sd</span>(percentageDiffCustomers, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb138-5"><a href="#cb138-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(std_dev)</span>
<span id="cb138-6"><a href="#cb138-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-7"><a href="#cb138-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 2: Degrees of freedom (8 months in pre-trial period, hence 7 degrees of freedom)</span></span>
<span id="cb138-8"><a href="#cb138-8" aria-hidden="true" tabindex="-1"></a>degreesOfFreedom <span class="ot">&lt;-</span> <span class="dv">7</span></span>
<span id="cb138-9"><a href="#cb138-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-10"><a href="#cb138-10" aria-hidden="true" tabindex="-1"></a><span class="do">#### We will test with a null hypothesis of there being 0 difference between trial and control stores</span></span>
<span id="cb138-11"><a href="#cb138-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 3: Calculate the t-value for each percentage difference</span></span>
<span id="cb138-12"><a href="#cb138-12" aria-hidden="true" tabindex="-1"></a>percentageDiffWithTValueC <span class="ot">&lt;-</span> percentageDiffCustomers <span class="sc">%&gt;%</span></span>
<span id="cb138-13"><a href="#cb138-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">tValue =</span> (percentageDiffCustomers <span class="sc">-</span> <span class="dv">0</span>) <span class="sc">/</span> stdDev) <span class="sc">%&gt;%</span></span>
<span id="cb138-14"><a href="#cb138-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">TransactionMonth =</span> <span class="fu">as.Date</span>(<span class="fu">paste0</span>(YEARMONTH <span class="sc">%/%</span> <span class="dv">100</span>, <span class="st">"-"</span>, YEARMONTH <span class="sc">%%</span> <span class="dv">100</span>, <span class="st">"-01"</span>), <span class="st">"%Y-%m-%d"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb138-15"><a href="#cb138-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(YEARMONTH <span class="sc">&gt;</span> <span class="dv">201901</span> <span class="sc">&amp;</span> YEARMONTH <span class="sc">&lt;</span> <span class="dv">201905</span>) <span class="sc">%&gt;%</span> <span class="co"># Filter for trial period (from Feb 2019 to Apr 2019)</span></span>
<span id="cb138-16"><a href="#cb138-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(TransactionMonth, tValue)</span>
<span id="cb138-17"><a href="#cb138-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-18"><a href="#cb138-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Output the result</span></span>
<span id="cb138-19"><a href="#cb138-19" aria-hidden="true" tabindex="-1"></a>percentageDiffWithTValueC</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 2
  TransactionMonth tValue
  &lt;date&gt;            &lt;dbl&gt;
1 2019-02-01         1.07
2 2019-03-01         4.50
3 2019-04-01        11.1 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb140"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb140-1"><a href="#cb140-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the 95th percentile of the t-distribution with the appropriate degrees of freedom</span></span>
<span id="cb140-2"><a href="#cb140-2" aria-hidden="true" tabindex="-1"></a>tPercentile95 <span class="ot">&lt;-</span> <span class="fu">qt</span>(<span class="fl">0.95</span>, <span class="at">df =</span> degreesOfFreedom)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb141"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb141-1"><a href="#cb141-1" aria-hidden="true" tabindex="-1"></a><span class="co">#graphing out the comparison values</span></span>
<span id="cb141-2"><a href="#cb141-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-3"><a href="#cb141-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 1: Classifying stores into "Trial", "Control", and "Other stores"</span></span>
<span id="cb141-4"><a href="#cb141-4" aria-hidden="true" tabindex="-1"></a>pastCustomers <span class="ot">&lt;-</span> measureOverTime <span class="sc">%&gt;%</span></span>
<span id="cb141-5"><a href="#cb141-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Store_type =</span> <span class="fu">case_when</span>(</span>
<span id="cb141-6"><a href="#cb141-6" aria-hidden="true" tabindex="-1"></a>    store_nbr <span class="sc">==</span> trial_store <span class="sc">~</span> <span class="st">"Trial"</span>,</span>
<span id="cb141-7"><a href="#cb141-7" aria-hidden="true" tabindex="-1"></a>    store_nbr <span class="sc">==</span> control_store <span class="sc">~</span> <span class="st">"Control"</span>,</span>
<span id="cb141-8"><a href="#cb141-8" aria-hidden="true" tabindex="-1"></a>    <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"Other stores"</span></span>
<span id="cb141-9"><a href="#cb141-9" aria-hidden="true" tabindex="-1"></a>  )) <span class="sc">%&gt;%</span></span>
<span id="cb141-10"><a href="#cb141-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(YEARMONTH, Store_type) <span class="sc">%&gt;%</span></span>
<span id="cb141-11"><a href="#cb141-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">nCustomers =</span> <span class="fu">mean</span>(nCustomers, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb141-12"><a href="#cb141-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">TransactionMonth =</span> <span class="fu">as.Date</span>(<span class="fu">paste</span>(YEARMONTH <span class="sc">%/%</span> <span class="dv">100</span>, YEARMONTH <span class="sc">%%</span> <span class="dv">100</span>, <span class="st">"01"</span>, <span class="at">sep =</span> <span class="st">"-"</span>), <span class="st">"%Y-%m-%d"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb141-13"><a href="#cb141-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Store_type <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Trial"</span>, <span class="st">"Control"</span>))</span>
<span id="cb141-14"><a href="#cb141-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-15"><a href="#cb141-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 2: Adjust the control store sales for the 95th and 5th percentiles based on the standard deviation</span></span>
<span id="cb141-16"><a href="#cb141-16" aria-hidden="true" tabindex="-1"></a>pastCustomers_Controls95 <span class="ot">&lt;-</span> pastCustomers <span class="sc">%&gt;%</span></span>
<span id="cb141-17"><a href="#cb141-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Store_type <span class="sc">==</span> <span class="st">"Control"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb141-18"><a href="#cb141-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">nCustomers =</span> nCustomers <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">+</span> stdDev <span class="sc">*</span> <span class="dv">2</span>), <span class="at">Store_type =</span> <span class="st">"Control 95th % confidence interval"</span>)</span>
<span id="cb141-19"><a href="#cb141-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-20"><a href="#cb141-20" aria-hidden="true" tabindex="-1"></a>pastCustomers_Controls5 <span class="ot">&lt;-</span> pastCustomers <span class="sc">%&gt;%</span></span>
<span id="cb141-21"><a href="#cb141-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Store_type <span class="sc">==</span> <span class="st">"Control"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb141-22"><a href="#cb141-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">nCustomers =</span> nCustomers <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> stdDev <span class="sc">*</span> <span class="dv">2</span>), <span class="at">Store_type =</span> <span class="st">"Control 5th % confidence interval"</span>)</span>
<span id="cb141-23"><a href="#cb141-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-24"><a href="#cb141-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 3: Combine all the data</span></span>
<span id="cb141-25"><a href="#cb141-25" aria-hidden="true" tabindex="-1"></a>trialAssessment <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(pastCustomers, pastCustomers_Controls95, pastCustomers_Controls5)</span>
<span id="cb141-26"><a href="#cb141-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-27"><a href="#cb141-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 4: Plotting the data</span></span>
<span id="cb141-28"><a href="#cb141-28" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(trialAssessment, <span class="fu">aes</span>(TransactionMonth, nCustomers, <span class="at">color =</span> Store_type)) <span class="sc">+</span></span>
<span id="cb141-29"><a href="#cb141-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_rect</span>(<span class="at">data =</span> trialAssessment <span class="sc">%&gt;%</span> <span class="fu">filter</span>(YEARMONTH <span class="sc">&lt;</span> <span class="dv">201905</span> <span class="sc">&amp;</span> YEARMONTH <span class="sc">&gt;</span> <span class="dv">201901</span>),</span>
<span id="cb141-30"><a href="#cb141-30" aria-hidden="true" tabindex="-1"></a>            <span class="fu">aes</span>(<span class="at">xmin =</span> <span class="fu">min</span>(TransactionMonth), <span class="at">xmax =</span> <span class="fu">max</span>(TransactionMonth), <span class="at">ymin =</span> <span class="dv">0</span>, <span class="at">ymax =</span> <span class="cn">Inf</span>, <span class="at">color =</span> <span class="cn">NULL</span>),</span>
<span id="cb141-31"><a href="#cb141-31" aria-hidden="true" tabindex="-1"></a>            <span class="at">show.legend =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb141-32"><a href="#cb141-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb141-33"><a href="#cb141-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Month of operation"</span>, <span class="at">y =</span> <span class="st">"Total Customers"</span>, <span class="at">title =</span> <span class="st">"Total Customers by Month (Trial vs Control)"</span>) <span class="sc">+</span></span>
<span id="cb141-34"><a href="#cb141-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb141-35"><a href="#cb141-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_date</span>(<span class="at">date_labels =</span> <span class="st">"%b %Y"</span>, <span class="at">date_breaks =</span> <span class="st">"1 month"</span>) <span class="sc">+</span>  <span class="co"># Adjust x-axis for better readability</span></span>
<span id="cb141-36"><a href="#cb141-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>))  <span class="co"># Rotate x-axis labels</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="QVI_files/figure-html/unnamed-chunk-54-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>even the customers show significant difference in trial and control line</p>
</section>
<section id="trial-store-88" class="level1">
<h1><strong>##TRIAL STORE 88</strong></h1>
<p>Now we set the trial store as 86 and cal the correlation and magnitude for two metrics (tot sales and cust)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb142"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb142-1"><a href="#cb142-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Extracting stores that have 12 observations</span></span>
<span id="cb142-2"><a href="#cb142-2" aria-hidden="true" tabindex="-1"></a>storesWithFullObs <span class="ot">&lt;-</span> measureOverTime <span class="sc">%&gt;%</span></span>
<span id="cb142-3"><a href="#cb142-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(store_nbr) <span class="sc">%&gt;%</span></span>
<span id="cb142-4"><a href="#cb142-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">N =</span> <span class="fu">n</span>(), <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb142-5"><a href="#cb142-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(N <span class="sc">==</span> <span class="dv">12</span>) <span class="sc">%&gt;%</span> <span class="co">#extracting stores that have 12 obs</span></span>
<span id="cb142-6"><a href="#cb142-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(store_nbr)  <span class="co"># Extracting the store numbers as a vector</span></span>
<span id="cb142-7"><a href="#cb142-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-8"><a href="#cb142-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Filtering for the pre-trial period for those stores</span></span>
<span id="cb142-9"><a href="#cb142-9" aria-hidden="true" tabindex="-1"></a>preTrialMeasures <span class="ot">&lt;-</span> measureOverTime <span class="sc">%&gt;%</span></span>
<span id="cb142-10"><a href="#cb142-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(YEARMONTH <span class="sc">&lt;</span> <span class="dv">201902</span> <span class="sc">&amp;</span> store_nbr <span class="sc">%in%</span> storesWithFullObs) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb143"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb143-1"><a href="#cb143-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Set the trial store </span></span>
<span id="cb143-2"><a href="#cb143-2" aria-hidden="true" tabindex="-1"></a>trial_store <span class="ot">&lt;-</span> <span class="dv">86</span> </span>
<span id="cb143-3"><a href="#cb143-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate magnitude distance for `totSales` and `nCustomers` </span></span>
<span id="cb143-4"><a href="#cb143-4" aria-hidden="true" tabindex="-1"></a>magnitude_nSales <span class="ot">&lt;-</span> <span class="fu">calculateMagnitudeDistance</span>(preTrialMeasures, <span class="st">"totSales"</span>, trial_store) </span>
<span id="cb143-5"><a href="#cb143-5" aria-hidden="true" tabindex="-1"></a>magnitude_nCustomers <span class="ot">&lt;-</span> <span class="fu">calculateMagnitudeDistance</span>(preTrialMeasures, <span class="st">"nCustomers"</span>, trial_store)  <span class="co"># Calculate correlation for `totSales` and `nCustomers` </span></span>
<span id="cb143-6"><a href="#cb143-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb143-7"><a href="#cb143-7" aria-hidden="true" tabindex="-1"></a>corr_nSales <span class="ot">&lt;-</span> <span class="fu">calculateCorrelation</span>(preTrialMeasures, <span class="st">"totSales"</span>, trial_store) </span>
<span id="cb143-8"><a href="#cb143-8" aria-hidden="true" tabindex="-1"></a>corr_nCustomers <span class="ot">&lt;-</span> <span class="fu">calculateCorrelation</span>(preTrialMeasures, <span class="st">"nCustomers"</span>, trial_store)  </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s take a simple average of the correlation and magnitude scores for each driver. Note that if we consider<br>
it more important for the trend of the drivers to be similar, we can increase the weight of the correlation<br>
score (a simple average gives a weight of 0.5 to the corr_weight) or if we consider the absolute size of the<br>
drivers to be more important, we can lower the weight of the correlation score.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb144"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb144-1"><a href="#cb144-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Set correlation weight </span></span>
<span id="cb144-2"><a href="#cb144-2" aria-hidden="true" tabindex="-1"></a>corr_weight <span class="ot">&lt;-</span> <span class="fl">0.5</span> <span class="co">#balancing out the the important of both correlation and magnitude  </span></span>
<span id="cb144-3"><a href="#cb144-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-4"><a href="#cb144-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge and calculate score for nSales </span></span>
<span id="cb144-5"><a href="#cb144-5" aria-hidden="true" tabindex="-1"></a>score_nSales <span class="ot">&lt;-</span> corr_nSales <span class="sc">%&gt;%</span>   </span>
<span id="cb144-6"><a href="#cb144-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(magnitude_nSales, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"Store1"</span>, <span class="st">"Store2"</span>)) <span class="sc">%&gt;%</span>   </span>
<span id="cb144-7"><a href="#cb144-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(     <span class="at">scoreNSales =</span> corr_measure <span class="sc">*</span> corr_weight <span class="sc">+</span> mag_measure <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> corr_weight)   )  </span>
<span id="cb144-8"><a href="#cb144-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-9"><a href="#cb144-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge and calculate score for nCustomers </span></span>
<span id="cb144-10"><a href="#cb144-10" aria-hidden="true" tabindex="-1"></a>score_nCustomers <span class="ot">&lt;-</span> corr_nCustomers <span class="sc">%&gt;%</span>   </span>
<span id="cb144-11"><a href="#cb144-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(magnitude_nCustomers, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"Store1"</span>, <span class="st">"Store2"</span>)) <span class="sc">%&gt;%</span>   </span>
<span id="cb144-12"><a href="#cb144-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(     <span class="at">scoreNCust =</span> corr_measure <span class="sc">*</span> corr_weight <span class="sc">+</span> mag_measure <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> corr_weight)   ) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>combining the score across the drivers (sales and customers)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb145"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb145-1"><a href="#cb145-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge score_nSales and score_nCustomers</span></span>
<span id="cb145-2"><a href="#cb145-2" aria-hidden="true" tabindex="-1"></a>score_Control <span class="ot">&lt;-</span> score_nSales <span class="sc">%&gt;%</span></span>
<span id="cb145-3"><a href="#cb145-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(score_nCustomers, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"Store1"</span>, <span class="st">"Store2"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb145-4"><a href="#cb145-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">finalControlScore =</span> scoreNSales <span class="sc">*</span> <span class="fl">0.5</span> <span class="sc">+</span> scoreNCust <span class="sc">*</span> <span class="fl">0.5</span>)</span>
<span id="cb145-5"><a href="#cb145-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb145-6"><a href="#cb145-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the store with the second highest finalControlScore for the trial store</span></span>
<span id="cb145-7"><a href="#cb145-7" aria-hidden="true" tabindex="-1"></a>control_store <span class="ot">&lt;-</span> score_Control <span class="sc">%&gt;%</span></span>
<span id="cb145-8"><a href="#cb145-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Store1 <span class="sc">==</span> trial_store) <span class="sc">%&gt;%</span></span>
<span id="cb145-9"><a href="#cb145-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(finalControlScore)) <span class="sc">%&gt;%</span></span>
<span id="cb145-10"><a href="#cb145-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="dv">2</span>) <span class="sc">%&gt;%</span></span>
<span id="cb145-11"><a href="#cb145-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(Store2)</span>
<span id="cb145-12"><a href="#cb145-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb145-13"><a href="#cb145-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Display the result</span></span>
<span id="cb145-14"><a href="#cb145-14" aria-hidden="true" tabindex="-1"></a>control_store</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 155</code></pre>
</div>
</div>
<p>finding the control store - checking if the drivers are actually similar in the period</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb147"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb147-1"><a href="#cb147-1" aria-hidden="true" tabindex="-1"></a><span class="co">#checking for sales</span></span>
<span id="cb147-2"><a href="#cb147-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb147-3"><a href="#cb147-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a new column for Store type (Trial, Control, Other)</span></span>
<span id="cb147-4"><a href="#cb147-4" aria-hidden="true" tabindex="-1"></a>pastSales <span class="ot">&lt;-</span> measureOverTime <span class="sc">%&gt;%</span></span>
<span id="cb147-5"><a href="#cb147-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Store_type =</span> <span class="fu">case_when</span>(</span>
<span id="cb147-6"><a href="#cb147-6" aria-hidden="true" tabindex="-1"></a>    store_nbr <span class="sc">==</span> trial_store <span class="sc">~</span> <span class="st">"Trial"</span>,</span>
<span id="cb147-7"><a href="#cb147-7" aria-hidden="true" tabindex="-1"></a>    store_nbr <span class="sc">==</span> control_store <span class="sc">~</span> <span class="st">"Control"</span>,</span>
<span id="cb147-8"><a href="#cb147-8" aria-hidden="true" tabindex="-1"></a>    <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"Other stores"</span></span>
<span id="cb147-9"><a href="#cb147-9" aria-hidden="true" tabindex="-1"></a>  )) <span class="sc">%&gt;%</span></span>
<span id="cb147-10"><a href="#cb147-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(YEARMONTH, Store_type) <span class="sc">%&gt;%</span></span>
<span id="cb147-11"><a href="#cb147-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">totSales =</span> <span class="fu">mean</span>(totSales, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb147-12"><a href="#cb147-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb147-13"><a href="#cb147-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">TransactionMonth =</span> <span class="fu">as.Date</span>(<span class="fu">paste0</span>(YEARMONTH <span class="sc">%/%</span> <span class="dv">100</span>, <span class="st">"-"</span>, YEARMONTH <span class="sc">%%</span> <span class="dv">100</span>, <span class="st">"-01"</span>), <span class="st">"%Y-%m-%d"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb147-14"><a href="#cb147-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(YEARMONTH <span class="sc">&lt;</span> <span class="dv">201903</span>)  <span class="co"># Filter to pre-trial period</span></span>
<span id="cb147-15"><a href="#cb147-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb147-16"><a href="#cb147-16" aria-hidden="true" tabindex="-1"></a>pastSales</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2,110 × 9
   store_nbr YEARMONTH totSales nCustomers nTxnPerCust nChipsPerTxn
       &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;      &lt;int&gt;       &lt;dbl&gt;        &lt;dbl&gt;
 1         1    201807     583.         47        1.04         1.18
 2         1    201808     559.         41        1            1.27
 3         1    201809     566.         57        1.04         1.20
 4         1    201810     577.         39        1.03         1.27
 5         1    201811     565.         44        1.02         1.22
 6         1    201812     593.         37        1.08         1.2 
 7         1    201901     575.         35        1            1.17
 8         1    201902     530.         49        1.04         1.14
 9         2    201807     583.         36        1.06         1.13
10         2    201808     559.         35        1.11         1.28
# ℹ 2,100 more rows
# ℹ 3 more variables: avgPricePerUnit &lt;dbl&gt;, Store_type &lt;chr&gt;,
#   TransactionMonth &lt;date&gt;</code></pre>
</div>
<div class="sourceCode cell-code" id="cb149"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb149-1"><a href="#cb149-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plotting total sales by month for Trial, Control, and Other stores</span></span>
<span id="cb149-2"><a href="#cb149-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(pastSales, <span class="fu">aes</span>(TransactionMonth, totSales, <span class="at">color =</span> Store_type)) <span class="sc">+</span></span>
<span id="cb149-3"><a href="#cb149-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb149-4"><a href="#cb149-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb149-5"><a href="#cb149-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Month of operation"</span>, </span>
<span id="cb149-6"><a href="#cb149-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Total Sales"</span>, </span>
<span id="cb149-7"><a href="#cb149-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Total Sales by Month (Trial Store vs Control vs Other Stores)"</span></span>
<span id="cb149-8"><a href="#cb149-8" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb149-9"><a href="#cb149-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span> </span>
<span id="cb149-10"><a href="#cb149-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_date</span>(<span class="at">date_labels =</span> <span class="st">"%b %Y"</span>, <span class="at">date_breaks =</span> <span class="st">"1 month"</span>) <span class="sc">+</span>  <span class="co"># Adjust x-axis for better readability</span></span>
<span id="cb149-11"><a href="#cb149-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>))  <span class="co"># Rotate x-axis labels</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="QVI_files/figure-html/unnamed-chunk-59-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb150"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb150-1"><a href="#cb150-1" aria-hidden="true" tabindex="-1"></a><span class="co">#checking for customers</span></span>
<span id="cb150-2"><a href="#cb150-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-3"><a href="#cb150-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a new column for Store type (Trial, Control, Other)</span></span>
<span id="cb150-4"><a href="#cb150-4" aria-hidden="true" tabindex="-1"></a>pastnCustomers <span class="ot">&lt;-</span> measureOverTime <span class="sc">%&gt;%</span></span>
<span id="cb150-5"><a href="#cb150-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Store_type =</span> <span class="fu">case_when</span>(</span>
<span id="cb150-6"><a href="#cb150-6" aria-hidden="true" tabindex="-1"></a>    store_nbr <span class="sc">==</span> trial_store <span class="sc">~</span> <span class="st">"Trial"</span>,</span>
<span id="cb150-7"><a href="#cb150-7" aria-hidden="true" tabindex="-1"></a>    store_nbr <span class="sc">==</span> control_store <span class="sc">~</span> <span class="st">"Control"</span>,</span>
<span id="cb150-8"><a href="#cb150-8" aria-hidden="true" tabindex="-1"></a>    <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"Other stores"</span></span>
<span id="cb150-9"><a href="#cb150-9" aria-hidden="true" tabindex="-1"></a>  )) <span class="sc">%&gt;%</span></span>
<span id="cb150-10"><a href="#cb150-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(YEARMONTH, Store_type) <span class="sc">%&gt;%</span></span>
<span id="cb150-11"><a href="#cb150-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">nCustomers =</span> <span class="fu">mean</span>(nCustomers, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb150-12"><a href="#cb150-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb150-13"><a href="#cb150-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">TransactionMonth =</span> <span class="fu">as.Date</span>(<span class="fu">paste0</span>(YEARMONTH <span class="sc">%/%</span> <span class="dv">100</span>, <span class="st">"-"</span>, YEARMONTH <span class="sc">%%</span> <span class="dv">100</span>, <span class="st">"-01"</span>), <span class="st">"%Y-%m-%d"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb150-14"><a href="#cb150-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(YEARMONTH <span class="sc">&lt;</span> <span class="dv">201903</span>)  <span class="co"># Filter to pre-trial period</span></span>
<span id="cb150-15"><a href="#cb150-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-16"><a href="#cb150-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Plotting total customers by month for Trial, Control, and Other stores</span></span>
<span id="cb150-17"><a href="#cb150-17" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(pastnCustomers, <span class="fu">aes</span>(TransactionMonth, nCustomers, <span class="at">color =</span> Store_type)) <span class="sc">+</span></span>
<span id="cb150-18"><a href="#cb150-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb150-19"><a href="#cb150-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb150-20"><a href="#cb150-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Month of operation"</span>, </span>
<span id="cb150-21"><a href="#cb150-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Total Customers"</span>, </span>
<span id="cb150-22"><a href="#cb150-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Total Customers by Month (Trial Store vs Control vs Other Stores)"</span></span>
<span id="cb150-23"><a href="#cb150-23" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb150-24"><a href="#cb150-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span> </span>
<span id="cb150-25"><a href="#cb150-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_date</span>(<span class="at">date_labels =</span> <span class="st">"%b %Y"</span>, <span class="at">date_breaks =</span> <span class="st">"1 month"</span>) <span class="sc">+</span>  <span class="co"># Adjust x-axis for better readability</span></span>
<span id="cb150-26"><a href="#cb150-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>))  <span class="co"># Rotate x-axis labels</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="QVI_files/figure-html/unnamed-chunk-60-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p><strong>Assessment of trial</strong><br>
The trial period goes from the start of March 2019 to June 2019. We now want to see if there has been an<br>
uplift in overall chip sales.</p>
<p>like we can see in the graphs the trial and control have some differences - hence we can scale up control stores to a level similar to control for any differences between the two stores outside of the trial period (pre-trial period)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb151"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb151-1"><a href="#cb151-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the scaling factor for control store sales relative to trial store sales</span></span>
<span id="cb151-2"><a href="#cb151-2" aria-hidden="true" tabindex="-1"></a>scalingFactorForControlSales <span class="ot">&lt;-</span> preTrialMeasures <span class="sc">%&gt;%</span></span>
<span id="cb151-3"><a href="#cb151-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(store_nbr <span class="sc">==</span> trial_store <span class="sc">&amp;</span> YEARMONTH <span class="sc">&lt;</span> <span class="dv">201902</span>) <span class="sc">%&gt;%</span></span>
<span id="cb151-4"><a href="#cb151-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">total_trial_sales =</span> <span class="fu">sum</span>(totSales)) <span class="sc">%&gt;%</span></span>
<span id="cb151-5"><a href="#cb151-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(total_trial_sales) <span class="sc">/</span> preTrialMeasures <span class="sc">%&gt;%</span></span>
<span id="cb151-6"><a href="#cb151-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(store_nbr <span class="sc">==</span> control_store <span class="sc">&amp;</span> YEARMONTH <span class="sc">&lt;</span> <span class="dv">201902</span>) <span class="sc">%&gt;%</span></span>
<span id="cb151-7"><a href="#cb151-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">total_control_sales =</span> <span class="fu">sum</span>(totSales)) <span class="sc">%&gt;%</span></span>
<span id="cb151-8"><a href="#cb151-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(total_control_sales)</span>
<span id="cb151-9"><a href="#cb151-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb151-10"><a href="#cb151-10" aria-hidden="true" tabindex="-1"></a>scalingFactorForControlSales</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.9720494</code></pre>
</div>
<div class="sourceCode cell-code" id="cb153"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb153-1"><a href="#cb153-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply the scaling factor to the control store sales</span></span>
<span id="cb153-2"><a href="#cb153-2" aria-hidden="true" tabindex="-1"></a>measureOverTimeSales <span class="ot">&lt;-</span> measureOverTime <span class="sc">%&gt;%</span></span>
<span id="cb153-3"><a href="#cb153-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">controlSales =</span> <span class="fu">ifelse</span>(store_nbr <span class="sc">==</span> control_store, totSales <span class="sc">*</span> scalingFactorForControlSales, totSales))</span>
<span id="cb153-4"><a href="#cb153-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb153-5"><a href="#cb153-5" aria-hidden="true" tabindex="-1"></a>measureOverTimeSales</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3,165 × 8
   store_nbr YEARMONTH totSales nCustomers nTxnPerCust nChipsPerTxn
       &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;      &lt;int&gt;       &lt;dbl&gt;        &lt;dbl&gt;
 1         1    201807     189.         47        1.04         1.18
 2         1    201808     168.         41        1            1.27
 3         1    201809     268.         57        1.04         1.20
 4         1    201810     175.         39        1.03         1.27
 5         1    201811     185.         44        1.02         1.22
 6         1    201812     161.         37        1.08         1.2 
 7         1    201901     150.         35        1            1.17
 8         1    201902     195.         49        1.04         1.14
 9         1    201903     185.         43        1.09         1.19
10         1    201904     177.         39        1.03         1.3 
# ℹ 3,155 more rows
# ℹ 2 more variables: avgPricePerUnit &lt;dbl&gt;, controlSales &lt;dbl&gt;</code></pre>
</div>
</div>
<p>cal per diff</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb155"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb155-1"><a href="#cb155-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 3: Calculate the percentage difference between scaled control sales and trial store sales</span></span>
<span id="cb155-2"><a href="#cb155-2" aria-hidden="true" tabindex="-1"></a>percentageDiff <span class="ot">&lt;-</span> measureOverTimeSales <span class="sc">%&gt;%</span></span>
<span id="cb155-3"><a href="#cb155-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(store_nbr <span class="sc">==</span> trial_store) <span class="sc">%&gt;%</span></span>
<span id="cb155-4"><a href="#cb155-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(YEARMONTH, totSales) <span class="sc">%&gt;%</span></span>
<span id="cb155-5"><a href="#cb155-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(measureOverTimeSales <span class="sc">%&gt;%</span></span>
<span id="cb155-6"><a href="#cb155-6" aria-hidden="true" tabindex="-1"></a>              <span class="fu">filter</span>(store_nbr <span class="sc">==</span> control_store) <span class="sc">%&gt;%</span></span>
<span id="cb155-7"><a href="#cb155-7" aria-hidden="true" tabindex="-1"></a>              <span class="fu">select</span>(YEARMONTH, controlSales), <span class="at">by =</span> <span class="st">"YEARMONTH"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb155-8"><a href="#cb155-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">percentageDiff =</span> <span class="fu">abs</span>(controlSales <span class="sc">-</span> totSales) <span class="sc">/</span> controlSales)</span>
<span id="cb155-9"><a href="#cb155-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb155-10"><a href="#cb155-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb155-11"><a href="#cb155-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 1: Calculate the standard deviation of the percentageDiff during the pre-trial period</span></span>
<span id="cb155-12"><a href="#cb155-12" aria-hidden="true" tabindex="-1"></a>stdDev <span class="ot">&lt;-</span> percentageDiff <span class="sc">%&gt;%</span></span>
<span id="cb155-13"><a href="#cb155-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(YEARMONTH <span class="sc">&lt;</span> <span class="dv">201902</span>) <span class="sc">%&gt;%</span></span>
<span id="cb155-14"><a href="#cb155-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">std_dev =</span> <span class="fu">sd</span>(percentageDiff, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb155-15"><a href="#cb155-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(std_dev)</span>
<span id="cb155-16"><a href="#cb155-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb155-17"><a href="#cb155-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 2: Degrees of freedom (8 months in pre-trial period, hence 7 degrees of freedom)</span></span>
<span id="cb155-18"><a href="#cb155-18" aria-hidden="true" tabindex="-1"></a>degreesOfFreedom <span class="ot">&lt;-</span> <span class="dv">7</span></span>
<span id="cb155-19"><a href="#cb155-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb155-20"><a href="#cb155-20" aria-hidden="true" tabindex="-1"></a><span class="do">#### We will test with a null hypothesis of there being 0 difference between trial and control stores</span></span>
<span id="cb155-21"><a href="#cb155-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 3: Calculate the t-value for each percentage difference</span></span>
<span id="cb155-22"><a href="#cb155-22" aria-hidden="true" tabindex="-1"></a>percentageDiffWithTValue <span class="ot">&lt;-</span> percentageDiff <span class="sc">%&gt;%</span></span>
<span id="cb155-23"><a href="#cb155-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">tValue =</span> (percentageDiff <span class="sc">-</span> <span class="dv">0</span>) <span class="sc">/</span> stdDev) <span class="sc">%&gt;%</span></span>
<span id="cb155-24"><a href="#cb155-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">TransactionMonth =</span> <span class="fu">as.Date</span>(<span class="fu">paste0</span>(YEARMONTH <span class="sc">%/%</span> <span class="dv">100</span>, <span class="st">"-"</span>, YEARMONTH <span class="sc">%%</span> <span class="dv">100</span>, <span class="st">"-01"</span>), <span class="st">"%Y-%m-%d"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb155-25"><a href="#cb155-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(YEARMONTH <span class="sc">&gt;</span> <span class="dv">201901</span> <span class="sc">&amp;</span> YEARMONTH <span class="sc">&lt;</span> <span class="dv">201905</span>) <span class="sc">%&gt;%</span> <span class="co"># Filter for trial period (from Feb 2019 to Apr 2019)</span></span>
<span id="cb155-26"><a href="#cb155-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(TransactionMonth, tValue)</span>
<span id="cb155-27"><a href="#cb155-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb155-28"><a href="#cb155-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb155-29"><a href="#cb155-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the 95th percentile of the t-distribution with the appropriate degrees of freedom</span></span>
<span id="cb155-30"><a href="#cb155-30" aria-hidden="true" tabindex="-1"></a>tPercentile95 <span class="ot">&lt;-</span> <span class="fu">qt</span>(<span class="fl">0.95</span>, <span class="at">df =</span> degreesOfFreedom)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb156"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb156-1"><a href="#cb156-1" aria-hidden="true" tabindex="-1"></a><span class="co">#graphing out the comparison values</span></span>
<span id="cb156-2"><a href="#cb156-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-3"><a href="#cb156-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 1: Classifying stores into "Trial", "Control", and "Other stores"</span></span>
<span id="cb156-4"><a href="#cb156-4" aria-hidden="true" tabindex="-1"></a>pastSales <span class="ot">&lt;-</span> measureOverTime <span class="sc">%&gt;%</span></span>
<span id="cb156-5"><a href="#cb156-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Store_type =</span> <span class="fu">case_when</span>(</span>
<span id="cb156-6"><a href="#cb156-6" aria-hidden="true" tabindex="-1"></a>    store_nbr <span class="sc">==</span> trial_store <span class="sc">~</span> <span class="st">"Trial"</span>,</span>
<span id="cb156-7"><a href="#cb156-7" aria-hidden="true" tabindex="-1"></a>    store_nbr <span class="sc">==</span> control_store <span class="sc">~</span> <span class="st">"Control"</span>,</span>
<span id="cb156-8"><a href="#cb156-8" aria-hidden="true" tabindex="-1"></a>    <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"Other stores"</span></span>
<span id="cb156-9"><a href="#cb156-9" aria-hidden="true" tabindex="-1"></a>  )) <span class="sc">%&gt;%</span></span>
<span id="cb156-10"><a href="#cb156-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(YEARMONTH, Store_type) <span class="sc">%&gt;%</span></span>
<span id="cb156-11"><a href="#cb156-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">totSales =</span> <span class="fu">mean</span>(totSales, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb156-12"><a href="#cb156-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">TransactionMonth =</span> <span class="fu">as.Date</span>(<span class="fu">paste</span>(YEARMONTH <span class="sc">%/%</span> <span class="dv">100</span>, YEARMONTH <span class="sc">%%</span> <span class="dv">100</span>, <span class="st">"01"</span>, <span class="at">sep =</span> <span class="st">"-"</span>), <span class="st">"%Y-%m-%d"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb156-13"><a href="#cb156-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Store_type <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Trial"</span>, <span class="st">"Control"</span>))</span>
<span id="cb156-14"><a href="#cb156-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-15"><a href="#cb156-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 2: Adjust the control store sales for the 95th and 5th percentiles based on the standard deviation</span></span>
<span id="cb156-16"><a href="#cb156-16" aria-hidden="true" tabindex="-1"></a>pastSales_Controls95 <span class="ot">&lt;-</span> pastSales <span class="sc">%&gt;%</span></span>
<span id="cb156-17"><a href="#cb156-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Store_type <span class="sc">==</span> <span class="st">"Control"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb156-18"><a href="#cb156-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">totSales =</span> totSales <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">+</span> stdDev <span class="sc">*</span> <span class="dv">2</span>), <span class="at">Store_type =</span> <span class="st">"Control 95th % confidence interval"</span>)</span>
<span id="cb156-19"><a href="#cb156-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-20"><a href="#cb156-20" aria-hidden="true" tabindex="-1"></a>pastSales_Controls5 <span class="ot">&lt;-</span> pastSales <span class="sc">%&gt;%</span></span>
<span id="cb156-21"><a href="#cb156-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Store_type <span class="sc">==</span> <span class="st">"Control"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb156-22"><a href="#cb156-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">totSales =</span> totSales <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> stdDev <span class="sc">*</span> <span class="dv">2</span>), <span class="at">Store_type =</span> <span class="st">"Control 5th % confidence interval"</span>)</span>
<span id="cb156-23"><a href="#cb156-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-24"><a href="#cb156-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 3: Combine all the data</span></span>
<span id="cb156-25"><a href="#cb156-25" aria-hidden="true" tabindex="-1"></a>trialAssessment <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(pastSales, pastSales_Controls95, pastSales_Controls5)</span>
<span id="cb156-26"><a href="#cb156-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-27"><a href="#cb156-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 4: Plotting the data</span></span>
<span id="cb156-28"><a href="#cb156-28" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(trialAssessment, <span class="fu">aes</span>(TransactionMonth, totSales, <span class="at">color =</span> Store_type)) <span class="sc">+</span></span>
<span id="cb156-29"><a href="#cb156-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_rect</span>(<span class="at">data =</span> trialAssessment <span class="sc">%&gt;%</span> <span class="fu">filter</span>(YEARMONTH <span class="sc">&lt;</span> <span class="dv">201905</span> <span class="sc">&amp;</span> YEARMONTH <span class="sc">&gt;</span> <span class="dv">201901</span>),</span>
<span id="cb156-30"><a href="#cb156-30" aria-hidden="true" tabindex="-1"></a>            <span class="fu">aes</span>(<span class="at">xmin =</span> <span class="fu">min</span>(TransactionMonth), <span class="at">xmax =</span> <span class="fu">max</span>(TransactionMonth), <span class="at">ymin =</span> <span class="dv">0</span>, <span class="at">ymax =</span> <span class="cn">Inf</span>, <span class="at">color =</span> <span class="cn">NULL</span>),</span>
<span id="cb156-31"><a href="#cb156-31" aria-hidden="true" tabindex="-1"></a>            <span class="at">show.legend =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb156-32"><a href="#cb156-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb156-33"><a href="#cb156-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Month of operation"</span>, <span class="at">y =</span> <span class="st">"Total sales"</span>, <span class="at">title =</span> <span class="st">"Total Sales by Month (Trial vs Control)"</span>) <span class="sc">+</span></span>
<span id="cb156-34"><a href="#cb156-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb156-35"><a href="#cb156-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_date</span>(<span class="at">date_labels =</span> <span class="st">"%b %Y"</span>, <span class="at">date_breaks =</span> <span class="st">"1 month"</span>) <span class="sc">+</span>  <span class="co"># Adjust x-axis for better readability</span></span>
<span id="cb156-36"><a href="#cb156-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>))  <span class="co"># Rotate x-axis labels</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="QVI_files/figure-html/unnamed-chunk-63-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Assessment for ncustomers</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb157"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb157-1"><a href="#cb157-1" aria-hidden="true" tabindex="-1"></a><span class="co">#checking for customers</span></span>
<span id="cb157-2"><a href="#cb157-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb157-3"><a href="#cb157-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the scaling factor for control store customers relative to trial store customers</span></span>
<span id="cb157-4"><a href="#cb157-4" aria-hidden="true" tabindex="-1"></a>scalingFactorForControlCustomers <span class="ot">&lt;-</span> preTrialMeasures <span class="sc">%&gt;%</span></span>
<span id="cb157-5"><a href="#cb157-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(store_nbr <span class="sc">==</span> trial_store <span class="sc">&amp;</span> YEARMONTH <span class="sc">&lt;</span> <span class="dv">201902</span>) <span class="sc">%&gt;%</span></span>
<span id="cb157-6"><a href="#cb157-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">total_trial_customers =</span> <span class="fu">sum</span>(nCustomers)) <span class="sc">%&gt;%</span></span>
<span id="cb157-7"><a href="#cb157-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(total_trial_customers) <span class="sc">/</span> preTrialMeasures <span class="sc">%&gt;%</span></span>
<span id="cb157-8"><a href="#cb157-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(store_nbr <span class="sc">==</span> control_store <span class="sc">&amp;</span> YEARMONTH <span class="sc">&lt;</span> <span class="dv">201902</span>) <span class="sc">%&gt;%</span></span>
<span id="cb157-9"><a href="#cb157-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">total_control_customers =</span> <span class="fu">sum</span>(nCustomers)) <span class="sc">%&gt;%</span></span>
<span id="cb157-10"><a href="#cb157-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(total_control_customers)</span>
<span id="cb157-11"><a href="#cb157-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb157-12"><a href="#cb157-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply the scaling factor to the control store customers</span></span>
<span id="cb157-13"><a href="#cb157-13" aria-hidden="true" tabindex="-1"></a>measureOverTimeCustomers <span class="ot">&lt;-</span> measureOverTime <span class="sc">%&gt;%</span></span>
<span id="cb157-14"><a href="#cb157-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">controlCustomers =</span> <span class="fu">ifelse</span>(store_nbr <span class="sc">==</span> control_store, nCustomers <span class="sc">*</span> scalingFactorForControlCustomers, nCustomers))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb158"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb158-1"><a href="#cb158-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Calculate the percentage difference between scaled control customers and trial store customers</span></span>
<span id="cb158-2"><a href="#cb158-2" aria-hidden="true" tabindex="-1"></a>percentageDiffCustomers <span class="ot">&lt;-</span> measureOverTimeCustomers <span class="sc">%&gt;%</span></span>
<span id="cb158-3"><a href="#cb158-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(store_nbr <span class="sc">==</span> trial_store) <span class="sc">%&gt;%</span></span>
<span id="cb158-4"><a href="#cb158-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(YEARMONTH, nCustomers) <span class="sc">%&gt;%</span></span>
<span id="cb158-5"><a href="#cb158-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(measureOverTimeCustomers <span class="sc">%&gt;%</span></span>
<span id="cb158-6"><a href="#cb158-6" aria-hidden="true" tabindex="-1"></a>              <span class="fu">filter</span>(store_nbr <span class="sc">==</span> control_store) <span class="sc">%&gt;%</span></span>
<span id="cb158-7"><a href="#cb158-7" aria-hidden="true" tabindex="-1"></a>              <span class="fu">select</span>(YEARMONTH, controlCustomers), <span class="at">by =</span> <span class="st">"YEARMONTH"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb158-8"><a href="#cb158-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">percentageDiffCustomers =</span> <span class="fu">abs</span>(controlCustomers <span class="sc">-</span> nCustomers) <span class="sc">/</span> controlCustomers)</span>
<span id="cb158-9"><a href="#cb158-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb158-10"><a href="#cb158-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 1: Calculate the standard deviation of the percentageDiffCustomers during the pre-trial period</span></span>
<span id="cb158-11"><a href="#cb158-11" aria-hidden="true" tabindex="-1"></a>stdDevC <span class="ot">&lt;-</span> percentageDiffCustomers <span class="sc">%&gt;%</span></span>
<span id="cb158-12"><a href="#cb158-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(YEARMONTH <span class="sc">&lt;</span> <span class="dv">201902</span>) <span class="sc">%&gt;%</span></span>
<span id="cb158-13"><a href="#cb158-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">std_dev =</span> <span class="fu">sd</span>(percentageDiffCustomers, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb158-14"><a href="#cb158-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(std_dev)</span>
<span id="cb158-15"><a href="#cb158-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb158-16"><a href="#cb158-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 2: Degrees of freedom (8 months in pre-trial period, hence 7 degrees of freedom)</span></span>
<span id="cb158-17"><a href="#cb158-17" aria-hidden="true" tabindex="-1"></a>degreesOfFreedom <span class="ot">&lt;-</span> <span class="dv">7</span></span>
<span id="cb158-18"><a href="#cb158-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb158-19"><a href="#cb158-19" aria-hidden="true" tabindex="-1"></a><span class="do">#### We will test with a null hypothesis of there being 0 difference between trial and control stores</span></span>
<span id="cb158-20"><a href="#cb158-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 3: Calculate the t-value for each percentage difference</span></span>
<span id="cb158-21"><a href="#cb158-21" aria-hidden="true" tabindex="-1"></a>percentageDiffWithTValueC <span class="ot">&lt;-</span> percentageDiffCustomers <span class="sc">%&gt;%</span></span>
<span id="cb158-22"><a href="#cb158-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">tValue =</span> (percentageDiffCustomers <span class="sc">-</span> <span class="dv">0</span>) <span class="sc">/</span> stdDev) <span class="sc">%&gt;%</span></span>
<span id="cb158-23"><a href="#cb158-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">TransactionMonth =</span> <span class="fu">as.Date</span>(<span class="fu">paste0</span>(YEARMONTH <span class="sc">%/%</span> <span class="dv">100</span>, <span class="st">"-"</span>, YEARMONTH <span class="sc">%%</span> <span class="dv">100</span>, <span class="st">"-01"</span>), <span class="st">"%Y-%m-%d"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb158-24"><a href="#cb158-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(YEARMONTH <span class="sc">&gt;</span> <span class="dv">201901</span> <span class="sc">&amp;</span> YEARMONTH <span class="sc">&lt;</span> <span class="dv">201905</span>) <span class="sc">%&gt;%</span> <span class="co"># Filter for trial period (from Feb 2019 to Apr 2019)</span></span>
<span id="cb158-25"><a href="#cb158-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(TransactionMonth, tValue)</span>
<span id="cb158-26"><a href="#cb158-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb158-27"><a href="#cb158-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Output the result</span></span>
<span id="cb158-28"><a href="#cb158-28" aria-hidden="true" tabindex="-1"></a>percentageDiffWithTValueC</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 2
  TransactionMonth tValue
  &lt;date&gt;            &lt;dbl&gt;
1 2019-02-01         6.58
2 2019-03-01         8.75
3 2019-04-01         2.93</code></pre>
</div>
<div class="sourceCode cell-code" id="cb160"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb160-1"><a href="#cb160-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the 95th percentile of the t-distribution with the appropriate degrees of freedom</span></span>
<span id="cb160-2"><a href="#cb160-2" aria-hidden="true" tabindex="-1"></a>tPercentile95 <span class="ot">&lt;-</span> <span class="fu">qt</span>(<span class="fl">0.95</span>, <span class="at">df =</span> degreesOfFreedom)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb161"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb161-1"><a href="#cb161-1" aria-hidden="true" tabindex="-1"></a><span class="co">#graphing out the comparison values</span></span>
<span id="cb161-2"><a href="#cb161-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb161-3"><a href="#cb161-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 1: Classifying stores into "Trial", "Control", and "Other stores"</span></span>
<span id="cb161-4"><a href="#cb161-4" aria-hidden="true" tabindex="-1"></a>pastCustomers <span class="ot">&lt;-</span> measureOverTime <span class="sc">%&gt;%</span></span>
<span id="cb161-5"><a href="#cb161-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Store_type =</span> <span class="fu">case_when</span>(</span>
<span id="cb161-6"><a href="#cb161-6" aria-hidden="true" tabindex="-1"></a>    store_nbr <span class="sc">==</span> trial_store <span class="sc">~</span> <span class="st">"Trial"</span>,</span>
<span id="cb161-7"><a href="#cb161-7" aria-hidden="true" tabindex="-1"></a>    store_nbr <span class="sc">==</span> control_store <span class="sc">~</span> <span class="st">"Control"</span>,</span>
<span id="cb161-8"><a href="#cb161-8" aria-hidden="true" tabindex="-1"></a>    <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"Other stores"</span></span>
<span id="cb161-9"><a href="#cb161-9" aria-hidden="true" tabindex="-1"></a>  )) <span class="sc">%&gt;%</span></span>
<span id="cb161-10"><a href="#cb161-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(YEARMONTH, Store_type) <span class="sc">%&gt;%</span></span>
<span id="cb161-11"><a href="#cb161-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">nCustomers =</span> <span class="fu">mean</span>(nCustomers, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb161-12"><a href="#cb161-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">TransactionMonth =</span> <span class="fu">as.Date</span>(<span class="fu">paste</span>(YEARMONTH <span class="sc">%/%</span> <span class="dv">100</span>, YEARMONTH <span class="sc">%%</span> <span class="dv">100</span>, <span class="st">"01"</span>, <span class="at">sep =</span> <span class="st">"-"</span>), <span class="st">"%Y-%m-%d"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb161-13"><a href="#cb161-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Store_type <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Trial"</span>, <span class="st">"Control"</span>))</span>
<span id="cb161-14"><a href="#cb161-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb161-15"><a href="#cb161-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 2: Adjust the control store sales for the 95th and 5th percentiles based on the standard deviation</span></span>
<span id="cb161-16"><a href="#cb161-16" aria-hidden="true" tabindex="-1"></a>pastCustomers_Controls95 <span class="ot">&lt;-</span> pastCustomers <span class="sc">%&gt;%</span></span>
<span id="cb161-17"><a href="#cb161-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Store_type <span class="sc">==</span> <span class="st">"Control"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb161-18"><a href="#cb161-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">nCustomers =</span> nCustomers <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">+</span> stdDev <span class="sc">*</span> <span class="dv">2</span>), <span class="at">Store_type =</span> <span class="st">"Control 95th % confidence interval"</span>)</span>
<span id="cb161-19"><a href="#cb161-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb161-20"><a href="#cb161-20" aria-hidden="true" tabindex="-1"></a>pastCustomers_Controls5 <span class="ot">&lt;-</span> pastCustomers <span class="sc">%&gt;%</span></span>
<span id="cb161-21"><a href="#cb161-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Store_type <span class="sc">==</span> <span class="st">"Control"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb161-22"><a href="#cb161-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">nCustomers =</span> nCustomers <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> stdDev <span class="sc">*</span> <span class="dv">2</span>), <span class="at">Store_type =</span> <span class="st">"Control 5th % confidence interval"</span>)</span>
<span id="cb161-23"><a href="#cb161-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb161-24"><a href="#cb161-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 3: Combine all the data</span></span>
<span id="cb161-25"><a href="#cb161-25" aria-hidden="true" tabindex="-1"></a>trialAssessment <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(pastCustomers, pastCustomers_Controls95, pastCustomers_Controls5)</span>
<span id="cb161-26"><a href="#cb161-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb161-27"><a href="#cb161-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 4: Plotting the data</span></span>
<span id="cb161-28"><a href="#cb161-28" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(trialAssessment, <span class="fu">aes</span>(TransactionMonth, nCustomers, <span class="at">color =</span> Store_type)) <span class="sc">+</span></span>
<span id="cb161-29"><a href="#cb161-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_rect</span>(<span class="at">data =</span> trialAssessment <span class="sc">%&gt;%</span> <span class="fu">filter</span>(YEARMONTH <span class="sc">&lt;</span> <span class="dv">201905</span> <span class="sc">&amp;</span> YEARMONTH <span class="sc">&gt;</span> <span class="dv">201901</span>),</span>
<span id="cb161-30"><a href="#cb161-30" aria-hidden="true" tabindex="-1"></a>            <span class="fu">aes</span>(<span class="at">xmin =</span> <span class="fu">min</span>(TransactionMonth), <span class="at">xmax =</span> <span class="fu">max</span>(TransactionMonth), <span class="at">ymin =</span> <span class="dv">0</span>, <span class="at">ymax =</span> <span class="cn">Inf</span>, <span class="at">color =</span> <span class="cn">NULL</span>),</span>
<span id="cb161-31"><a href="#cb161-31" aria-hidden="true" tabindex="-1"></a>            <span class="at">show.legend =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb161-32"><a href="#cb161-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb161-33"><a href="#cb161-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Month of operation"</span>, <span class="at">y =</span> <span class="st">"Total Customers"</span>, <span class="at">title =</span> <span class="st">"Total Customers by Month (Trial vs Control)"</span>) <span class="sc">+</span></span>
<span id="cb161-34"><a href="#cb161-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb161-35"><a href="#cb161-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_date</span>(<span class="at">date_labels =</span> <span class="st">"%b %Y"</span>, <span class="at">date_breaks =</span> <span class="st">"1 month"</span>) <span class="sc">+</span>  <span class="co"># Adjust x-axis for better readability</span></span>
<span id="cb161-36"><a href="#cb161-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>))  <span class="co"># Rotate x-axis labels</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="QVI_files/figure-html/unnamed-chunk-66-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>